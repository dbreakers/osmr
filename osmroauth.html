<!DOCTYPE html>
<!-- Copyright David Breakwell 2021 -->
<!-- September 2022 RElease 4.1 :  Finance -->
<!-- Please don't copy this code!   -->
 






































<html>
<head>
<title>OSMR Reporting</title>

<link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" href="favicon/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="favicon/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="favicon/manifest.json">
<link rel="mask-icon" href="favicon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="favicon.ico">
<meta name="msapplication-config" content="@2ndnewhawscouts.com/ssl/favicon/browserconfig.xml">
<meta name="theme-color" content="#4d1979">
<link rel="stylesheet" type="text/css" href="https://www.2ndnewhawscouts.org.uk/osmr/css/pivot.css">
<link rel="stylesheet" type="text/css" href="https://www.2ndnewhawscouts.org.uk/osmr/multiple-select.css">
<link rel="stylesheet" type="text/css" href="https://www.2ndnewhawscouts.org.uk/osmr/css/slick.grid.css">
<link rel="stylesheet" type="text/css" href="https://www.2ndnewhawscouts.org.uk/osmr/css/osmr.css">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<link rel="stylesheet" id="cluster_style-css" href="https://2ndnewhawscouts.org.uk/wp-content/plugins/campsites/dist/MarkerCluster.css?ver=ea704a3a16582300f0e62fcafa210021" type="text/css" media="all">
<link rel="stylesheet" id="cluster_style2-css" href="https://2ndnewhawscouts.org.uk/wp-content/plugins/campsites/dist/MarkerCluster.Default.css?ver=ea704a3a16582300f0e62fcafa210021" type="text/css" media="all">

<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src='https://js.sentry-cdn.com/e7765bb8daf149f0adc902a3b52aec0c.min.js' crossorigin="anonymous"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/pivot.js?ts=6"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/export_renderers.js?ts=6"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/excel_renderers.js?ts=6"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/multiple-select.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/jquery.event.drop-2.2.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/gchart_renderers.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.core.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.grid.js"></script>

<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/FileSaver.js"></script>

<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/blob.js"></script>


<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.dataview.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.groupitemmetadataprovider.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.cellselectionmodel.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.cellrangeselector.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.pager.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/slick.columnpicker.js"></script>
<script type="text/javascript" src="https://www.2ndnewhawscouts.org.uk/osmr/scripts/xlsx.full.min.js"></script>
<script type="text/javascript" src=" https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!--<script type="text/javascript" src=" https://p10.secure.hostingprod.com/@www.2ndnewhawscouts.com/ssl/pdfmake.min.js"></script> -->
<script type="text/javascript" src=" https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.33/pdfmake.js"></script>
<script type="text/javascript" src=" https://www.2ndnewhawscouts.org.uk/osmr/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
<script type="text/javascript" src=" https://www.2ndnewhawscouts.org.uk/wp-content/plugins/osm_dashboards/Control.FullScreen.js"></script>
</head>
<body>
<script>

var relay_path = "https://www.2ndnewhawscouts.org.uk/osmr/osmrelayoa2.php";
var api_number = "42";
var oauthcode = "";
var osmr_version = "1.00.00";
var postcode_list = [];
var imd_list = [];
var url = window.location.href
var arr = url.split("/");
if (arr[0]!="https:") { window.location.replace("https://www.2ndnewhawscouts.org.uk/osmr/osmroauth2.html");};
if (arr[2]!="www.2ndnewhawscouts.org.uk") { window.location.replace("https://www.2ndnewhawscouts.org.uk/osmr/osmroauth2.html");};
//debugger;
var params = (new URL(document.location)).searchParams;
if (params.has("state")&&(params.get("state")=="logonosmr")) {
  if (params.has("code")) {
      oauthcode = params.get("code")
      console.log(oauthcode)
      $("#reportoutput_about").toggle();
if ($("#osmr_logon").is(":visible")) { 
$("#osmr_logon").toggle("slow");
$("#osmr_loggedon").toggle("slow");
}
$.ajaxSetup({
    async: true 
});
  } 
}
var pdf_file
var security = new Object();
security = null;
var script = document.createElement("script");
    script.src = "https://www.google.com/jsapi";
    script.type = "text/javascript";
    document.getElementsByTagName("head")[0].appendChild(script);
var osm_colours = ['#7413dc','#00a794','#e22e12','#ffb4e5','#003982','#006ddf','#AAAAAA','#ffe627','#ba89ee','#80d3ca','#809cc1'];
 var sections = ""
 var patrols = ""
 var scouts = ""
 var roles = ""
 var terms = ""
 var postcodes_lookup=[];
 var report_list = { 'reports' : [] };
 var template_report;
 var dialog
 var dialog_delay
 var dialog2
  var pdf_doc_copy = new Object;
 var dialog_saveas
 var dialog_confirm
var dialog_pdf
 var report_config = new Object();
 var old_report_config = new Object();
  var section_config
  var roles_config
  var terms_config
  var get_data_array = []
 var get_data_array2 = []
  var api_setup = []
  var link = window.document.createElement('link');

const removeDuplicates4 = (list) => list.reduce((r, i) => 
  !r.some(j => Object.keys(i).length === Object.keys(j).length 
    && !Object.keys(i).some(k => i[k] !== j[k])) ? [...r, i] : r
, [])

 
   
      var dialog_array = [ "Members & Badges","Badges","Events","Events & Attendance","Events & QM Lists"]
      
      var build_dialog = "<div id=\"dialog-form\" title=\"Create a Report\"><span id=\"checks\"></span><br><span>Date: <input type=\"text\" id=\"datepicker2\">";
      build_dialog = build_dialog + "Report Type: "+"<select id=\"report_type2\"><option  value=\"Members\">Members</option>";
      for (var dodrop in dialog_array) { build_dialog = build_dialog + "<option value=\""+dialog_array[dodrop]+"\">"+dialog_array[dodrop]+"</option>"; }
      build_dialog = build_dialog + "</select></span><br><p><input type =\"checkbox\" name=\"refresh\" value=\"refresh\" id=\"refresh\">Refresh Data (Ignore Cache)";
      build_dialog = build_dialog + "&nbsp;&nbsp;&nbsp;&nbsp;Output: <input type =\"radio\" name=\"outputtype\" value=\"grid\">Grid<input type =\"radio\" name=\"outputtype\" value=\"pivot\">Pivot </p>";
      build_dialog = build_dialog + "</p><p>Saved Report: <select id=\"SavedReports2\"></select></p>";
      build_dialog = build_dialog + "<p>Find this useful? Think about a donation to <a href=\"https://2ndnewhawscouts.org.uk/wordpress-plugins-for-scout-websites/osmr-reporting-for-osm/#donate\" target=\"_blank\">2nd New Haw Scout Group</a>"
    build_dialog = build_dialog + "</div>";  
    $("body").append(build_dialog);
      $("body").append("<div id=\"dialog-form2\" title=\"Create a Report : Select Fields\"><div class=\"progress-label\"></div><div id=\"progressbar\"></div><span id=\"fieldlist\"></span></div>");  
      build_dialog = "<div id=\"dialog-form3\" title=\"Report\">"
    //  build_dialog = build_dialog +"<p><table width=100%><tr><td><label id='display_total' ><input  checked type=\"checkbox\" name=\"display_total\">Display Totals</label></td><td>";
     // build_dialog = build_dialog + "<label>PDF Font Size: <input  type=\"text\" id='display_size' name=\"display_size\" value=\"6\" size=\"3\">pt</label></td><td>";
    //  build_dialog = build_dialog + "<label>PDF Page Size: <select id='page_size' name=\"page_size\">";
    //  var size_array = [ "A4", "4A0", "2A0", "A0", "A1", "A2", "A3", "A5", "EXECUTIVE", "FOLIO", "LEGAL", "LETTER", "TABLOID" ];
     // for (dodrop in size_array) { build_dialog = build_dialog + "<option value=\""+size_array[dodrop]+"\">"+size_array[dodrop]+"</option>"; };
     // build_dialog = build_dialog + "</select></label></td><td><label  >  PDF Orientation: <select name=\"page_orient\" id='page_orient'><option value=\"landscape\">Landscape</option><option value=\"portrait\">Portrait</option></select>";
     // build_dialog = build_dialog +"</td></tr></table></p>";
      build_dialog = build_dialog + "<div id=\"reportoutputxx\" style=\"height: auto; width: 90%; margin: 30px;border-style: solid!important;\"></div>";
      build_dialog = build_dialog + "<div id=\"reportdata\"></div><textarea rows=\"4\" cols=\"50\" id=\"config_json2\"></textarea>";
      
      build_dialog = build_dialog +"</div>";
      $("body").append(build_dialog);
      $("body").append("<div id=\"dialog-saveas\" title=\"Save Report\"><p>Save Report as: <input type=\"text\" id=\"saveas\"></p><p>Include Filters <input type=\"checkbox\" id=\"saveas_filters\"></p><p>Existing Reports:</p><div id=\"saveas_list\"></div></div>");    
      $("body").append("<div id=\"dialog-delete\" title=\"Delete Report\"><p><span id=\"delete_confirm\"></span></p></div>");
      $("body").append("<div id=\"dialog-confirm\" title=\"Confirmation\"><p><span id=\"confirmation\"></span></p></div>");
      $("body").append("<div id=\"dialog-delay\" title=\"Wait\"><p><span id=\"wait\"><img class=\"delay_img\" src=\"icons\\triangle.gif\" align=\"center\"></span></p></div>");

 dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 425,
      width: 650,
      modal: true,
      buttons: {
       "Select Fields": select_fields,
       "Delete Report": delete_report,
        Cancel: function() {
          dialog.dialog( "close" );
        }
      },
      close: function() {
 //       form[ 0 ].reset();
 //       allFields.removeClass( "ui-state-error" );
      }
    });
      
    dialog2 = $( "#dialog-form2" ).dialog({
      autoOpen: false,
      height: 425,
      width: 650,
      modal: true,
      buttons: {
       "Generate Report": function () {  
         
         if ($("#progressbar :visible").length==0) {select_checks();}
         },    
        Cancel: function() {
          dialog2.dialog( "close" );
        }
      },
      close: function() {
 //       form[ 0 ].reset();
 //       allFields.removeClass( "ui-state-error" );
      }
    });
 
         
      dialog3 = $( "#dialog-form3" ).dialog({
      autoOpen: false,
     'width': $(window).width(),
     'height': $(window).height(),
      modal: true,
      buttons: {
      // "Checklist": select_checks,   
          "Save" :  function() { 
              // GM_setValue("foo",$("#config_json").val() ); 
             //  alert(GM_listValues());
              report_saveas();
          },
 //         "Print" : print_report,
          "Back"  : function() { dialog2.dialog( "open" ); dialog3.dialog( "close" ); assemble_data2(); } ,
          
        "Close": function() {
          dialog3.dialog( "close" );
        }
      },
      close: function() {
      }
    });
    
    dialog_delete =   $( "#dialog-delete" ).dialog({
      autoOpen: false,
     'width': 400,
     'height': 200,
      modal: true,
      buttons: {
          "Delete" :  function() {
report_list.reports.splice(report_list.reports.findIndex(function(a){return a.name==$("#DeleteReports option:selected").text()}),1);

 
               localStorage.setItem('report_list', JSON.stringify(report_list));
$('#DeleteReports').children('option').remove();
                $('#SavedReports').children('option').remove();
   $("#SavedReports").append("<option  value=\"blank\"></option>");
$("#DeleteReports").append("<option  value=\"blank\"></option>");
   // var report_list = GM_listValues();
    for (var report in report_list.reports) {
        $("#SavedReports").append("<option  value=\"reports\">"+report_list.reports[report].name+"</option>");
$("#DeleteReports").append("<option  value=\"reports\">"+report_list.reports[report].name+"</option>");

    }
for(var i = 0; i < template_report.reports.length;  i++) {
                  $("#SavedReports").append("<option class=\"template\" value=\"reports\">"+template_report.reports[i].name+"</option>");
                }



     //          GM_deleteValue($("#SavedReports option:selected").text());
               
               dialog_delete.dialog( "close" );
          },
          
          
          
        "Cancel": function() {
          dialog_delete.dialog( "close" );
        }
      },
      close: function() {
      }
    });
      
      dialog_confirm = $("#dialog-confirm").dialog({
      autoOpen: false,
      modal: true,
      buttons: {
        "OK": function() {
          dialog_confirm.dialog( "close" );
        }
      },
      close: function() {
      }
    });
    dialog_delay = $("#dialog-delay").dialog({
      autoOpen: false,
      modal: true,
      closeOnEscape: false
    });               
    dialog_saveas =   $( "#dialog-saveas" ).dialog({
      autoOpen: false,
     'width': 400,
     'height': 600,
      modal: true,
      buttons: {
          "Save" :  function() { 
              var full_config = JSON.parse($("#config_json").val());
              full_config.display_total = ($("#dialog-form3 input[name='display_total']:checked").val()=="on");
if ($("#saveas_filters").prop("checked")) {
} else{
if (full_config.hasOwnProperty("pivot")) {
                        delete full_config.pivot.exclusions;
                        delete full_config.pivot.inclusions;
                      } else {delete full_config.exclusions; }
}

     if (report_list==null) {
     report_list = new Object;
     report_list.reports = [];
     }
if (report_list.reports.findIndex(function(a){return a.name==$("#saveas").val()})!=-1) {
report_list.reports.splice(report_list.reports.findIndex(function(a){return a.name==$("#saveas").val()}),1);
}
     report_list.reports.push({'name' : $("#saveas").val(), 'def' : JSON.stringify(full_config, undefined, 2)} );
report_list.reports.sort(function(a,b) {return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0);} ); 
localStorage.setItem('report_list', JSON.stringify(report_list));         
           //    GM_setValue($("#saveas").val(),JSON.stringify(full_config, undefined, 2) ); 
           //    alert(GM_listValues());
$('#DeleteReports').children('option').remove();
                $('#SavedReports').children('option').remove();
   $("#SavedReports").append("<option  value=\"blank\"></option>");
$("#DeleteReports").append("<option  value=\"blank\"></option>");
   // var report_list = GM_listValues();
    for (var report in report_list.reports) {
        $("#SavedReports").append("<option  value=\"reports\">"+report_list.reports[report].name+"</option>");
$("#DeleteReports").append("<option  value=\"reports\">"+report_list.reports[report].name+"</option>");

    }
               dialog_saveas.dialog( "close" );
          },
          
          
          
        "Close": function() {
          dialog_saveas.dialog( "close" );
        }
      },
      close: function() {
      }
    });
   // 

     
      $( "#datepicker" ).datepicker();
      $( "#datepicker" ).datepicker( "option", "dateFormat", "yy-mm-dd" );
      $( "#progressbar" ).progressbar({ value: 0, max: 100 });
     
     
     

// initCharts is needed and without () to prevent the DOM being cleared.....LOL
var options = {packages: ['corechart',"charteditor","timeline"], callback : initCharts};

google.load('visualization', '1', options);

var mymap = {};
      
// }, false);

////////
(function() {
    var callWithJQuery;

    callWithJQuery = function(pivotModule) {
        if (typeof exports === "object" && typeof module === "object") {
            return pivotModule(require("jquery"));
        } else if (typeof define === "function" && define.amd) {
            return define(["jquery"], pivotModule);
        } else {
            return pivotModule(jQuery);
        }
    };
    
    

    
    callWithJQuery(function($) {
        var makePDF2;
        makePDF2 = function(chartType, extraOptions) {
            return function(pivotData, opts) {
                var aggregator, c, colAttrs, colKey, colKeys, defaults, i, j, r, result, rowAttrs, rowKey, rowKeys, spanSize, td, th, totalAggregator, tr, txt, val, x;
                opts = $.extend(defaults, opts);
               colAttrs = pivotData.colAttrs;
               rowAttrs = pivotData.rowAttrs;
               rowKeys = pivotData.getRowKeys();
               colKeys = pivotData.getColKeys();
              // log.console(chartType); 
               spanSize = function(arr, i, j) {
        var l, len, n, noDraw, ref, ref1, stop, x;
        if (i !== 0) {
          noDraw = true;
          for (x = l = 0, ref = j; 0 <= ref ? l <= ref : l >= ref; x = 0 <= ref ? ++l : --l) {
            if (arr[i - 1][x] !== arr[i][x]) {
              noDraw = false;
            }
          }
          if (noDraw) {
            return -1;
          }
        }
        len = 0;
        while (i + len < arr.length) {
          stop = false;
          for (x = n = 0, ref1 = j; 0 <= ref1 ? n <= ref1 : n >= ref1; x = 0 <= ref1 ? ++n : --n) {
            if (arr[i][x] !== arr[i + len][x]) {
              stop = true;
            }
          }
          if (stop) {
            break;
          }
          len++;
        }
        return len;
      };
                
      var outDoc, result;
                
      writeRotatedText = function(text,maxlen) {
  var ctx, canvas = document.createElement('canvas');
  
  canvas.width = 40;
  canvas.height = maxlen*25+10;
  
  ctx = canvas.getContext('2d');
  ctx.fillStyle = 'white';
  ctx.rect(0, 0, canvas.width, canvas.height);
  ctx.fill();
  ctx.fillStyle = '#FFF';
  ctx.font = '29pt Arial';
  ctx.save();
  ctx.translate(36, 10+maxlen*25);
  ctx.rotate(-0.5*Math.PI);
  ctx.fillStyle = "#000";
  
  ctx.fillText(text , 0, -5);
  ctx.restore();
  return canvas.toDataURL("image/jpeg");
};
      var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth()+1; //January is 0!
      var yyyy = today.getFullYear();
      var pdf_doc = new Object;
      var pdf_header = new Object;
      pdf_header.text = '\n\nExtracted from Online Scout Manager on '+dd+"."+mm+"."+yyyy;
      pdf_header.margin = [20,0,0,0];
      pdf_doc.header = pdf_header;
      var pdf_table = new Object ;
     var pdf_footer = function(currentPage, pageCount) {  return {text: currentPage.toString() + ' of ' + pageCount, alignment: 'center'}; };
      pdf_doc.footer = pdf_footer;
      pdf_table.table = new Object;
      if (($("#disp_totals_ck").prop("checked"))) {
pdf_table.table.headerRows = pivotData.colAttrs.length + 1;
      } 
else
      {
      if (pivotData.rowAttrs.length==0){ 
      pdf_table.table.headerRows = pivotData.colAttrs.length;
      } else {pdf_table.table.headerRows = pivotData.colAttrs.length + 1;}
      }
      pdf_table.table.body = new Array;
       hasProp = {}.hasOwnProperty;    
      for (j in colAttrs) {
        if (!hasProp.call(colAttrs, j)) continue;
        c = colAttrs[j];
        var max_len = 0;
        for (maxloop in colAttrs) {
            if (max_len < colAttrs[maxloop].length) max_len = colAttrs[maxloop].length;
        }
     //   var max_len = colAttrs.sort(function (a, b) { return b.length - a.length; })[0].length;
        var table_row = new Array;  
        //tr = document.createElement("tr");
        if (parseInt(j) === 0 && rowAttrs.length !== 0) {
         // th = document.createElement("th");
         // th.setAttribute("colspan", rowAttrs.length);
         // th.setAttribute("rowspan", colAttrs.length);
         // tr.appendChild(th);
          var pdf_table_cell = new Object;
          pdf_table_cell.text = ""
          pdf_table_cell.colSpan = pivotData.rowAttrs.length;
          pdf_table_cell.rowSpan = pivotData.colAttrs.length;
          table_row.push(pdf_table_cell)     
          for (var i in rowAttrs) {
              var pdf_table_cell = new Object;
              pdf_table_cell.text = ""
              if (parseInt(i)!= pivotData.rowAttrs.length-1) {
              table_row.push(pdf_table_cell)     
              }
          }
        }
        if (parseInt(j) != 0 && rowAttrs.length !== 0) {
        for (var i in rowAttrs) {
         var pdf_table_cell = new Object;
              pdf_table_cell.text = ""
              table_row.push(pdf_table_cell)     
        }     
        }
        var pdf_table_cell = new Object;
        var rotate_this = 0;
        $("#reportoutput").find('input.pvtrotate:checked').each(function() {
            if ( $(this).data("rotate")[0]==colAttrs[j] ) {
                rotate_this = 1;
            }
        });

        if (rotate_this==1) {
        var tableBody =  [ [{image: writeRotatedText(c,max_len), fit:[7*($( "input[name=display_size" ).val())/6,max_len*$( "input[name=display_size" ).val()], alignment: 'center'}]];
        pdf_table_cell.stack = tableBody;
       
        } else
        {
          pdf_table_cell.text = c;
          pdf_replace(pdf_table_cell);
      //    pdf_table_cell.font = "Icon";
      //    pdf_table_cell.fontSize = 25;
        }
          
      //  
        table_row.push(pdf_table_cell)       
        //th = document.createElement("th");
        //th.className = "pvtAxisLabel";
        //th.innerHTML = c;
        //tr.appendChild(th);
        
        max_len = 0;
        for (maxloop in colKeys) {
            if (max_len < colKeys[maxloop][j].toString().length) max_len = colKeys[maxloop][j].toString().length;
        }
   //     var max_len = col_keys.sort(function (a, b) { return b[0].length - a[0].length; })[0][0].length;
   //     colKeys.sort(  function (a, b) { return b[0] < a[0]; });
        
        var rotate_this = 0;
        $("#reportoutput").find('input.pvtrotate:checked').each(function() {
            if ( $(this).data("rotate")[0]==colAttrs[j] ) {
                rotate_this = 1;
            }
        });
        
        for (i in colKeys) {
          if (!hasProp.call(colKeys, i)) continue;
          colKey = colKeys[i];
          x = spanSize(colKeys, parseInt(i), parseInt(j));
          if (x !== -1) {
            var pdf_table_cell = new Object;
            
            if (rotate_this==1) {
            var tableBody =  [ [{image: writeRotatedText(colKey[j].toString(),max_len), fit:[7*($( "input[name=display_size" ).val())/6,max_len*$( "input[name=display_size" ).val()],alignment: 'left'}]];
             pdf_table_cell.stack = tableBody; 
            } else
             {
            pdf_table_cell.text = colKey[j].toString(); 
            pdf_replace(pdf_table_cell);
             };
    //       
            pdf_table_cell.colSpan = x;
            //th = document.createElement("th");
            //th.className = "pvtColLabel";
            //th.innerHTML = colKey[j];
            //th.setAttribute("colspan", x);
            if (parseInt(j) === colAttrs.length - 1 && rowAttrs.length !== 0) {
            //  th.setAttribute("rowspan", 2);
            pdf_table_cell.rowSpan = 2;
            } 
            table_row.push(pdf_table_cell)      
            //tr.appendChild(th);
          } else
          {
              var pdf_table_cell = new Object;
              pdf_table_cell.text = "";
              table_row.push(pdf_table_cell)      
          }
        }          
        if ((parseInt(j) === 0)&($("#disp_totals_ck").prop("checked"))) {
           var pdf_table_cell = new Object;
            pdf_table_cell.text = 'Total'; 
            pdf_table_cell.rowSpan = colAttrs.length + (rowAttrs.length === 0 ? 0 : 1);
            table_row.push(pdf_table_cell) 
          //th = document.createElement("th");
          //th.className = "pvtTotalLabel";
          //th.innerHTML = opts.localeStrings.totals;
          //th.setAttribute("rowspan", colAttrs.length + (rowAttrs.length === 0 ? 0 : 1));
          //tr.appendChild(th);
        }
        //result.appendChild(tr);
        pdf_table.table.body.push(table_row)  
      }        
      
      if (rowAttrs.length !== 0) {
        //tr = document.createElement("tr");
        var table_row = new Array;
        
        for (i in rowAttrs) {
          if (!hasProp.call(rowAttrs, i)) continue;
          r = rowAttrs[i];
          var pdf_table_cell = new Object;  
          pdf_table_cell.text = r.toString(); 
          pdf_replace(pdf_table_cell);
          table_row.push(pdf_table_cell) 
          //th = document.createElement("th");
          //th.className = "pvtAxisLabel";
          //th.innerHTML = r;
          //tr.appendChild(th);
        }
        if (colKeys.length>0) {
        var pdf_table_cell = new Object;  
            pdf_table_cell.text = ""; 
            table_row.push(pdf_table_cell)   // The blank Cell under the Column Header  
        };
        for (j in colKeys) {
            var pdf_table_cell = new Object;  
            pdf_table_cell.text = ""; 
            table_row.push(pdf_table_cell)   
        }
        //th = document.createElement("th");
        var pdf_table_cell = new Object;  
        pdf_table_cell.text = ""; 
        if ((colAttrs.length === 0)&($("#disp_totals_ck").prop("checked"))) {
          pdf_table_cell.text = "Total"; 
          table_row.push(pdf_table_cell) 
          //th.className = "pvtTotalLabel";
          //th.innerHTML = opts.localeStrings.totals;
        }
    //    table_row.push(pdf_table_cell) 
        pdf_table.table.body.push(table_row)  
        //result.appendChild(tr);
      }
      for (i in rowKeys) {
        if (!hasProp.call(rowKeys, i)) continue;
        rowKey = rowKeys[i];
        var table_row = new Array;
      //  tr = document.createElement("tr");  
        for (j in rowKey) {
          if (!hasProp.call(rowKey, j)) continue;
          txt = rowKey[j].toString();
          x = spanSize(rowKeys, parseInt(i), parseInt(j));
          if (x !== -1) {
            var pdf_table_cell = new Object;    
//            th = document.createElement("th");
//            th.className = "pvtRowLabel";
//            th.innerHTML = txt;
            pdf_table_cell.text = txt;
            pdf_replace(pdf_table_cell);
            pdf_table_cell.rowSpan = x;  
            // th.setAttribute("rowspan", x);
            if (parseInt(j) === rowAttrs.length - 1 && colAttrs.length !== 0) {
             // th.setAttribute("colspan", 2);
              pdf_table_cell.colSpan = 2;    
              table_row.push(pdf_table_cell)    
            }
           // tr.appendChild(th);
            table_row.push(pdf_table_cell)    
          } else
          {
              var pdf_table_cell = new Object;    
              pdf_table_cell.text = "";
              table_row.push(pdf_table_cell)    
          }
        }
        for (j in colKeys) {
          if (!hasProp.call(colKeys, j)) continue;
          colKey = colKeys[j];
          aggregator = pivotData.getAggregator(rowKey, colKey);
          val = aggregator.value();
          var pdf_table_cell = new Object;    
          //td = document.createElement("td");
          //td.className = "pvtVal row" + i + " col" + j;
          //td.innerHTML = aggregator.format(val);
          pdf_table_cell.text  = aggregator.format(val);
          //td.setAttribute("data-value", val);
          //tr.appendChild(td); 
       //   if (pdf_table_cell.text =="&#10060;") { pdf_table_cell.text = "h"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'red'; }
       //       if (pdf_table_cell.text =="&#9989;") { pdf_table_cell.text = "e"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'green'; }
    //              if (pdf_table_cell.text =="&#10062;") { pdf_table_cell.text = "f"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'green';}
      //             if (pdf_table_cell.text =="&#8413;") { pdf_table_cell.text = "A"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
        //           if (pdf_table_cell.text =="&#9684;") { pdf_table_cell.text = "F"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
          //         if (pdf_table_cell.text =="&#9719;") { pdf_table_cell.text = "B"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
            //       if (pdf_table_cell.text =="&#9681;") { pdf_table_cell.text = "K"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
              //     if (pdf_table_cell.text =="&#9685;") { pdf_table_cell.text = "P"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
                //   if (pdf_table_cell.text =="&#11044;") { pdf_table_cell.text = "U"; pdf_table_cell.font = "pie";pdf_table_cell.color = 'black';}
           pdf_replace(pdf_table_cell);
           table_row.push(pdf_table_cell)    
        }
          if (($("#disp_totals_ck").prop("checked"))) {          
        totalAggregator = pivotData.getAggregator(rowKey, []);
        val = totalAggregator.value();
         var pdf_table_cell = new Object;
         pdf_table_cell.text  =  totalAggregator.format(val);
         table_row.push(pdf_table_cell)
         }
         pdf_table.table.body.push(table_row)  
        //td = document.createElement("td");
        //td.className = "pvtTotal rowTotal";
        //td.innerHTML = totalAggregator.format(val);
        //td.setAttribute("data-value", val);
        //td.setAttribute("data-for", "row" + i);
        //tr.appendChild(td);
        //result.appendChild(tr);
      }
      var table_row = new Array;
      if ($("#disp_totals_ck").prop("checked")) {
      var pdf_table_cell = new Object; 
      pdf_table_cell.text = "Total";
      pdf_table_cell.colSpan = rowAttrs.length + (colAttrs.length === 0 ? 0 : 1)
      table_row.push(pdf_table_cell);
      }
      if (colKeys.length>0) {
      for (i in rowAttrs) {
       var pdf_table_cell = new Object; 
       pdf_table_cell.text = ""   
        table_row.push(pdf_table_cell)
      } } else
      {
          for (var i = 0; i< rowAttrs.length + (colAttrs.length === 0 ? 0 : 1) - 1 ; i++) {
      
          var pdf_table_cell = new Object; 
       pdf_table_cell.text = ""   
        table_row.push(pdf_table_cell)
          }
      }
      //tr = document.createElement("tr");
      //th = document.createElement("th");
      //th.className = "pvtTotalLabel";
      //th.innerHTML = opts.localeStrings.totals;
      //th.setAttribute("colspan", rowAttrs.length + (colAttrs.length === 0 ? 0 : 1));
      //tr.appendChild(th);
      if (($("#disp_totals_ck").prop("checked"))) {
      for (j in colKeys) {
        if (!hasProp.call(colKeys, j)) continue;
        colKey = colKeys[j];
        totalAggregator = pivotData.getAggregator([], colKey);
        val = totalAggregator.value();
        if (($("#disp_totals_ck").prop("checked"))) {   
        var pdf_table_cell = new Object;   
        pdf_table_cell.text = totalAggregator.format(val);
        table_row.push(pdf_table_cell)
        };
        //td = document.createElement("td");
        //td.className = "pvtTotal colTotal";
        //td.innerHTML = totalAggregator.format(val);
        //td.setAttribute("data-value", val);
        //td.setAttribute("data-for", "col" + j);
        //tr.appendChild(td);
      }
      totalAggregator = pivotData.getAggregator([], []);
      val = totalAggregator.value();
     // td = document.createElement("td");
     // td.className = "pvtGrandTotal";
     // td.innerHTML = totalAggregator.format(val);
    //  td.setAttribute("data-value", val);
    //  tr.appendChild(td);
        var pdf_table_cell = new Object;   
        pdf_table_cell.text = totalAggregator.format(val);
        table_row.push(pdf_table_cell)
      }
 if ($("#disp_totals_ck").prop("checked")) {
         pdf_table.table.body.push(table_row)
}  
   //   result.appendChild(tr);          
   //             fullAggName = pivotData.aggregatorName;
                
               
                pdf_doc.content = pdf_table;
                 pdf_doc.pageSize =  $( "select[name=page_size" ).val();
   pdf_doc.pageOrientation =  $( "select[name=page_orient" ).val(); 
                var defaultStyle = new Object;
                defaultStyle.fontSize = defaultStyle.fontSize = $( "input[name=display_size" ).val();
                pdf_doc.defaultStyle = defaultStyle;
        
                //pdf_base

   //             pdf_doc_copy = $.extend(true, {}, pdf_doc);
pdf_doc_copy = $.extend(true, {}, pdf_doc);
                 if (chartType=="Download") {
                     pdfMake.fonts = {
                    Roboto: {
                        normal: 'Roboto-Regular.ttf',
                        bold: 'Roboto-Medium.ttf',
                        italics: 'Roboto-Italic.ttf',
                        bolditalics: 'Roboto-MediumItalic.ttf'
                        },
                    fontello: {
                        normal: 'fontello.ttf',
                        bold: 'fontello.ttf',
                        italics: 'fontello.ttf',
                        bolditalics: 'fontello.ttf'
                        },
                     Harvey: {
                        normal: 'Harvey.ttf',
                        bold: 'Harvey.ttf',
                        italics: 'Harvey.ttf',
                        bolditalics: 'Harvey.ttf'
                        },
                    pie: {
                        normal: 'pie.ttf',
                        bold: 'pie.ttf',
                        italics: 'pie.ttf',
                        bolditalics: 'pie.ttf'
                        },
                    nunito: {
                        normal: 'Nunito-Sans.ttf',
                        bold: 'Nunito-Sans-Bold.ttf',
                        italics: 'Nunito-Sans-Italic.ttf',
                        bolditalics: 'Nunito-Sans-BoldItalic.ttf'
                        }
                        
                };
                   pdfMake.createPdf(pdf_doc).download();
                } else {
                pdfMake.fonts = {
                    Roboto: {
                        normal: 'Roboto-Regular.ttf',
                        bold: 'Roboto-Medium.ttf',
                        italics: 'Roboto-Italic.ttf',
                        bolditalics: 'Roboto-MediumItalic.ttf'
                        },
                    fontello: {
                        normal: 'fontello.ttf',
                        bold: 'fontello.ttf',
                        italics: 'fontello.ttf',
                        bolditalics: 'fontello.ttf'
                        },
                        Harvey: {
                        normal: 'Harvey.ttf',
                        bold: 'Harvey.ttf',
                        italics: 'Harvey.ttf',
                        bolditalics: 'Harvey.ttf'
                        },
                     pie: {
                        normal: 'pie.ttf',
                        bold: 'pie.ttf',
                        italics: 'pie.ttf',
                        bolditalics: 'pie.ttf'
                        },
                    nunito: {
                        normal: 'Nunito-Sans.ttf',
                        bold: 'Nunito-Sans-Bold.ttf',
                        italics: 'Nunito-Sans-Italic.ttf',
                        bolditalics: 'Nunito-Sans-BoldItalic.ttf'
                        }
                        
                };
                pdfMake.createPdf(pdf_doc,null).getDataUrl(function(outDoc) {
                $("#pdf_viewer").attr("src", outDoc);
                });}
                result = "<iframe id=\"pdf_viewer\" width=100% style = \"min-width: 700px; height: 800px;\"><iframe>";    
                return result;
            };
        };
        return $.pivotUtilities.pdf_renderers = {
            "PDF": makePDF2("LineChart"),
            "Download PDF": makePDF2("Download"),
        };
    });

}).call(this);

//# sourceMappingURL=gchart_renderers.js.map
///////

function pdf_replace(pdf_table_cell) {
     if (pdf_table_cell.text =="&#10060;") { pdf_table_cell.text = "h"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'red'; }
              if (pdf_table_cell.text =="&#9989;") { pdf_table_cell.text = "e"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'green'; }
                  if (pdf_table_cell.text =="&#10062;") { pdf_table_cell.text = "f"; pdf_table_cell.font = "fontello";pdf_table_cell.color = 'green';}
                   if (pdf_table_cell.text =="&#8413;") { pdf_table_cell.text = "A"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#FF0D0D';}
                   if (pdf_table_cell.text =="&#9684;") { pdf_table_cell.text = "F"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#FF8E15';}
                   if (pdf_table_cell.text =="&#9719;") { pdf_table_cell.text = "B"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#FF4E11';}
                   if (pdf_table_cell.text =="&#9681;") { pdf_table_cell.text = "K"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#FAB733';}
                   if (pdf_table_cell.text =="&#9685;") { pdf_table_cell.text = "P"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#ACB334';}
                   if (pdf_table_cell.text =="&#11044;") { pdf_table_cell.text = "U"; pdf_table_cell.font = "pie";pdf_table_cell.color = '#69B34C';}
                   return pdf_table_cell;
}


function slick_pdf() {
 var groupings  = dataView.getGrouping();
     var table_row = new Array; 
    var pdf_doc = new Object;

var today = new Date();
      var dd = today.getDate();
      var mm = today.getMonth()+1; //January is 0!
      var yyyy = today.getFullYear();

 var pdf_header = new Object;
      pdf_header.text = '\n\nExtracted from Online Scout Manager on '+dd+"."+mm+"."+yyyy;
      pdf_header.margin = [20,0,0,0];
      pdf_doc.header = pdf_header;
      
     var pdf_footer = function(currentPage, pageCount) {  return {text: currentPage.toString() + ' of ' + pageCount, alignment: 'center'}; };
      pdf_doc.footer = pdf_footer;

      var pdf_table = new Object ;
      pdf_table.table = new Object;
      pdf_table.table.headerRows = 1;
      pdf_table.table.body = new Array;
      var table_row = new Array;  
      for (var j in grid.getColumns()) {
        table_row.push(grid.getColumns()[j].name);
      }
      pdf_table.table.body.push(table_row);
      for (var j=0; j < dataView.getLength(); j++) {
      table_row = []; 
      var rowitem = dataView.getItem(j);
      if (rowitem.hasOwnProperty("__group")) {
           for (var k in grid.getColumns()) {
           if (k==0) {
               var pdf_table_cell = new Object;
               pdf_table_cell.text = groupings[rowitem.level].getter+":"+rowitem.value;
if ($("#disp_totals_ck").prop("checked")) { 
pdf_table_cell.text = pdf_table_cell.text + "   ("+rowitem.count+")";
};
               pdf_table_cell.colSpan =  grid.getColumns().length;
               table_row.push(pdf_table_cell);
           } else
           {
               table_row.push(" ");
           }
           }
      } else
      {
       for (var k in grid.getColumns()) {
        //var prop = grid.getColumns()[j].name;
         var pdf_table_cell = new Object;
         pdf_table_cell.text = rowitem[(grid.getColumns()[k].name)].toString()
         table_row.push(pdf_table_cell);
     //   table_row.push(rowitem[(grid.getColumns()[k].name)]);
      }  
      }
      pdf_table.table.body.push(table_row);    
      }
   pdf_doc.content = pdf_table;
    pdf_doc.pageSize =  $( "select[name=page_size" ).val();
   pdf_doc.pageOrientation =  $( "select[name=page_orient" ).val(); 
                var defaultStyle = new Object;
                defaultStyle.fontSize = defaultStyle.fontSize = $( "input[name=display_size" ).val();
                pdf_doc.defaultStyle = defaultStyle;
        
                //pdf_base
//var pdf_doc_copy = new Object;
//pdf_doc_copy = Object.assign({}, pdf_doc);        
pdf_doc_copy = $.extend(true, {}, pdf_doc);
if ($(".slickot option:selected").text()=="PDF") {
        pdfMake.createPdf(pdf_doc).getDataUrl(function(outDoc) {
                $("#pdf_viewer").attr("src", outDoc);
                });
                $("#reportoutput2").html("<iframe id=\"pdf_viewer\" width=100% style = \"min-width: 700px; height: 800px;\"><iframe>");
} else
{
 pdfMake.createPdf(pdf_doc).download();
}
}

function report_saveas() {
menu_closeNav();
$("#saveas_list").html("");
var save_html=""
if (report_list!=null) {
for (var report in report_list.reports) {
        save_html = save_html + "<a href='#'><span class='saveas_list_item'>"+report_list.reports[report].name+"</span></a><br>";

//.val('"+ report_list.reports[report].name +"')'>"+report_list.reports[report].name + "</span></a><br>"; 
    }
}
$("#saveas_list").html(save_html);

$(".saveas_list_item").click(function(e){$('#saveas').val($(this).html())});

$( "#dialog-saveas" ).dialog( "option", "position",{ my: "center", at: "center top+400", of: window, collision: "fit" } );
    dialog_saveas.dialog("open");
}
function delete_report() {
    if($("#DeleteReports option:selected").text()!="") {
    $("#delete_confirm").text("Delete the Report "+$("#DeleteReports option:selected").text());
    $("#delete_confirm").dialog({ position: {'my': 'center',  'at': 'center top+400', 'of': window } });
    dialog_delete.dialog("open");
    }
}


function do_xhr2(url,f,p) {
var osmpath = url.substring(37,url.indexOf("?"));
url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
p2 = [];
if (security !== null ) {
p2['secret'] = security.secret;
p2['userid'] = security.userid;
}


var obj = $.extend({}, p2);
 $.post(url,$.param(obj),function(data,status){
            f(data);
        });

}



  




function do_xhr(url,f,p) {

var osmpath = url.substring(37,url.indexOf("?"));

url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
if (security !== null ) {
p=[];
p['secret'] = security.secret;
p['userid'] = security.userid;


}
check_xhr();
var obj = $.extend({}, p);
 
var request = $.ajax({
  url: url,
  method: "GET",
    headers: {"Authorization" : 'Bearer '+oauthcode.data.access},
  data: $.param(obj),
  dataType: "json"
});
request.done(function( msg ,status,req) {
    	if (req.getResponseHeader("x-blocked")!=null){
			alert("");
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
			}
		if (req.getResponseHeader("retry-after")!=null){
			alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" "+get_data_array[c].field);
			}	
  $("#rr").text(req.getResponseHeader("x-ratelimit-remaining"));$("#rt").text(req.getResponseHeader("x-ratelimit-reset"));
   var d = new Date();
  var n = d.getTime();
  n = n + req.getResponseHeader("x-ratelimit-reset")*1000;
  $("#rt_abs").text(n);
  f(msg);
});
request.error(function(req,status,message) {
	if (req.getResponseHeader("retry-after")!=null){
		if (req.getResponseHeader("retry-after")!=null){
				alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
        
			}	
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" ");
			}	
    
});
}

function do_xhr_post(url,f,p) {
if (!url.indexOf("?")==-1) {
var osmpath = url.substring(37,url.indexOf("?")); 
url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
} else
{
url = relay_path + "?osmpath=oauth/resource"; 
url = relay_path + "?osmpath=/ext/members/contact/grid/?action=getMembers";
p['section_id']='3320';
p['term_id']= '461428';
}
/*
if (security !== null ) {
p['secret'] = security.secret;
p['userid'] = security.userid;
}

*/


var obj = $.extend({}, p);
check_xhr();
$.ajax({
			url: url,
			type: 'POST',
                        crossDomain: true,
            headers: {"Authorization" : 'Bearer '+oauthcode.data.access},
    
			data: $.param(obj),
			success: function(data,status,req){$("#rr").text(req.getResponseHeader("x-ratelimit-remaining"));$("#rt").text(req.getResponseHeader("x-ratelimit-reset"));
			if (req.getResponseHeader("x-blocked")!=null){
			alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
			}
			if (req.getResponseHeader("retry-after")!=null){
				alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" "+get_data_array[c].field);
			}	
			  var d = new Date();
  var n = d.getTime();
   n = n + req.getResponseHeader("x-ratelimit-reset")*1000;
  $("#rt_abs").text(n);
			f(data);},
                        error: function (responseData, textStatus, errorThrown) {
         if (req.getResponseHeader("retry-after")!=null){
				alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" "+get_data_array[c].field);
			}	                   
        alert('POST failed.'); }
		});



 

// $.post(url,$.param(obj),function(data,status){
//            f(data);
//        },"json");

}

function check_xhr() {
    remain = $("#rr").text();
    time = $("#rt_abs").text();
    var d = new Date();
    var n = d.getTime();
    if (remain==0) {
        if (n<time) {
        d = new Date(parseInt(time));
        alert("You have reached your limit on the API - you can use again at "+d.toTimeString());
        report_config = {};
          throw new Error("Can't read data at the moment! OSM Limit reached");
        }
    }
}

function menu_openNav() {
    document.getElementById("mySidenav").style.width = "250px";
}

function menu_closeNav() {
    document.getElementById("mySidenav").style.width = "0";
}

function log_out() {
if (security!=null) {
  security = null;
   sections="";
report_config= [];
section_config = [];
 old_report_config = {};
get_data_array = [];
report_data = [];
$("#osmr_logon").toggle("slow");
$("#osmr_loggedon").toggle("slow");
$("#reportoutput_about").toggle();
$("#reportoutput").html("");
 
}
menu_closeNav();
}

function receiveMessage(f){
    console.log(f)
    oauthcode = f;
    security = f;
    if (f.data.access=="") {alert("There was an issue during logon with OSM - please try again later"); } else {
    var parameters = [];
   //   do_xhr_post('https://www.onlinescoutmanager.co.uk/oauth/resource',get_sections,parameters);
     do_xhr('https://www.onlinescoutmanager.co.uk/api.php?action=getSectionConfig',set_sections,"");
    }
}

function call_report () {
 sections="";
//$("#dialog-delay").dialog({ position: {'my': 'center',  'at': 'center top+300', of: window } });
//dialog_delay.dialog( "open" );
 $("#reportoutput_about").toggle();
if ($("#osmr_logon").is(":visible")) { 
$("#osmr_logon").toggle("slow");
$("#osmr_loggedon").toggle("slow");
}
$.ajaxSetup({
    async: true
});
$.getJSON( "osmr_config.json", function( data ) { 
api_number = data.api;
//relay_path = data.relay; 
});
$.ajaxSetup({
    async: true
});
   // var report_list = GM_listValues();
report_list = JSON.parse(localStorage.getItem('report_list'));
if (report_list!=null) {
if (report_list.reports.length > 0) {
report_list.reports.sort(function(a,b) {return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0);} ); 
   $('#SavedReports').children('option').remove();
    $("#SavedReports").append("<option  value=\"blank\"></option>");
  $('#DeleteReports').children('option').remove();
    $("#DeleteReports").append("<option  value=\"blank\"></option>");
 
}}
 /* var parameters = [];

  parameters['email'] = $("#username").val();
  parameters['password'] = $("#password").val();
do_xhr_post('https://www.onlinescoutmanager.co.uk/users.php?action=authorise',get_sections,parameters);
*/
if (oauthcode=="") {
    access= $('#logon_access').is(":checked");
    if (access) {tail="true";} else {tail="false";}
    window.open("https://www.2ndnewhawscouts.org.uk/osmr/osmrelayoa.php?access="+tail,"", "width=500,height=500");
    window.addEventListener("message", receiveMessage, false);

} else
{ }
}

function get_sections(text) {
  security = JSON.parse(text);
  if (security.secret == null)
  {
    $("#confirmation").text("Unable to Logon");
        dialog_confirm.dialog({ title: "Message" });
$("#dialog-confirm").dialog({ position: {'my': 'center',  'at': 'center top+400, of:window' } });
        dialog_confirm.dialog("open");
        dialog_delay.dialog("close");
        if ($("#osmr_logon").is(":hidden")) { 
          $("#osmr_logon").toggle();
        };
        if ($("#osmr_loggedon").is(":visible")) { 
          $("#osmr_loggedon").toggle();
        };  
  } else {
    do_xhr('https://www.onlinescoutmanager.co.uk/api.php?action=getSectionConfig',set_sections,"");
  };
};



function set_sections(text) {
    sections = text;
  do_xhr('https://www.onlinescoutmanager.co.uk/api.php?action=getTerms',set_terms,"");
    //do_xhr('https://www.onlinescoutmanager.co.uk/ext/settings/patrols/?action=get&sectionid=3320',set_patrols,"");
};

function set_terms(text) {
    terms = text;
    
      do_xhr('https://www.onlinescoutmanager.co.uk/api.php?action=getUserRoles',set_roles,"");
    //do_xhr('https://www.onlinescoutmanager.co.uk/ext/settings/patrols/?action=get&sectionid=3320',set_patrols,"");
};

function get_roles_section(section) {
var property;
for(property in roles_config) {
if (roles_config[property].sectionid == section) {
        return property;
    }
}
}

function do_api_setup(c) {
var url = relay_path + '?osmpath=ext/settings/access/&action=getAPIAccess&sectionid='+Object.keys(section_config)[c];
p2 = [];
var obj = $.extend({}, p2);
$.ajax({
			url: url,
			type: 'POST',
                        crossDomain: true,
            headers: {"Authorization" : 'Bearer '+oauthcode.data.access},
    
			data: $.param(obj),
			success: function(data,status){
			     api_setup[Object.keys(section_config)[c]] = data;
         c = c + 1;
      if (c==Object.keys(section_config).length) {
           // api_settings_assess_access();
            api_settings_table_draw();
      } else
      {do_api_setup(c)};
			    
			},
                        error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.'); }
		});
		
   
}

function do_api_setup2(c) {
var url = relay_path + '?osmpath=ext/settings/access/&action=getAPIAccess&sectionid='+Object.keys(section_config)[c];
p2 = [];
    if (security !== null ) {
      p2['secret'] = security.secret;
      p2['userid'] = security.userid;
    }
    var obj = $.extend({}, p2);
    $.post(url,$.param(obj),function(data,status){
         api_setup[Object.keys(section_config)[c]] = data;
         c = c + 1;
      if (c==Object.keys(section_config).length) {
            api_settings_assess_access();
      } else
      {do_api_setup(c)};
    });
}


function set_roles(text) {
    roles = text;
    section_config = sections;
    roles_config = roles;
    terms_config = terms;
    var obj = {};
   
$.ajax({
            url: 'https://2ndnewhawscouts.org.uk/osmr/report_definitions.json?callback=callbackFnc',
            dataType: 'JSONP',
            jsonpCallback: 'callbackFnc',
            type: 'GET',
            async: false,
            crossDomain: true,
            success: function () { },
            failure: function () { },
            complete: function (data) {
                
                template_report=data.responseJSON;select_sections();
                for(var i = 0; i < template_report.reports.length;  i++) {
                  $("#SavedReports").append("<option class=\"template\" value=\"reports\">"+template_report.reports[i].name+"</option>");
                }
            }
        });
 

   

//    $.get("https://2ndnewhawscouts.org.uk/osmr/report_definitions.json",obj,function(data,status){template_report=data;select_sections();})
    var c = 0;   
    
    
//do_api_setup(c);    
//select_sections();
}
function select_sections() {
  //  $("#checks").empty();
$("select.section-select").empty();
gn = "";
gc = 0;
gal = [];
for(var property in section_config) {
    gal.push(roles_config[get_roles_section(property)].groupname);
}
gal = [...new Set(gal)];
for (galc=0;galc<gal.length;galc++) {
      htmlgal = "<optgroup label='"+gal[galc]+"'>";
  //    $("select.section-select").append("<optgroup label='"+gal[galc]+"'>");
    for(var property in section_config) {
    
        if (roles_config[get_roles_section(property)]!=undefined){
        if (roles_config[get_roles_section(property)].groupname==gal[galc]) {    
//    if (roles_config[get_roles_section(property)].groupname!=gn) {
  //      if (gn!="") {
//            $("select.section-select").append("</optgroup>");
  //      }
//        $("select.section-select").append("<optgroup label='"+roles_config[get_roles_section(property)].groupname+gc+"'>");
 //       gc++;
 //       gn = roles_config[get_roles_section(property)].groupname;
  //  }
   //   $("select.section-select").append("<option value=\""+property+"\">"+roles_config[get_roles_section(property)].groupname+":"+roles_config[get_roles_section(property)].sectionname+"</option>");
    htmlgal += "<option value=\""+property+"\">"+roles_config[get_roles_section(property)].sectionname+"</option>";
    //    $("select.section-select").append("<option value=\""+property+"\">"+roles_config[get_roles_section(property)].sectionname+"</option>");
        
        }
      //  $("select.section-select").append("</optgroup>");
     
        }
  //  $("#checks").append("<input class=\"section_chk\" type=\"checkbox\"  name=\""+property+"\" value=\""+property+"\" id=\""+property+"\">"+roles_config[get_roles_section(property)].groupname+":"+roles_config[get_roles_section(property)].sectionname+"<BR>");    
ga('send', 'event',  'Logon',security.userid, roles_config[get_roles_section(property)].groupname+":"+roles_config[get_roles_section(property)].sectionname);
}
   htmlgal += "</optgroup>";
      $("select.section-select").append(htmlgal);
}
 //$("select.section-select").append("</optgroup>");
    
    $('#SavedReports').children('option').remove()
   $("#SavedReports").append("<option  value=\"blank\"></option>");
 $('#DeleteReports').children('option').remove()
   $("#DeleteReports").append("<option  value=\"blank\"></option>");

    //var report_list = GM_listValues();
report_list = JSON.parse(localStorage.getItem('report_list'));
if (report_list!=null) {
if (report_list.reports.length > 0) {
report_list.reports.sort(function(a,b) {return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0);} ); 
if (report_list!=null) {
   for (var report in report_list.reports) {
       $("#SavedReports").append("<option value=\"reports\">"+report_list.reports[report].name+"</option>");
$("#DeleteReports").append("<option value=\"reports\">"+report_list.reports[report].name+"</option>");

  }
}}
} else { var report_list = { 'reports' : [] }; };
mstest.multipleSelect("refresh");
select_sections_open();
}
function select_sections_open() {
dialog_delay.dialog( "close" );
//dialog.dialog( "open" );
}

//import * as Sentry from "@sentry/browser";

function select_fields () {
   
        for(var property in section_config) {
     //        Sentry.setUser({ id: section_config[property].groupname+" "+section_config[property].sectionname  });
        }
    
     // Sentry.setUser({ id: section_config[section].groupname+" "+section_config[section].sectionname  });
    if (security==null) {
       $("#confirmation").text("You need to logon")
        dialog_confirm.dialog({ title: "Message" });
        dialog_confirm.dialog("open");
        return;
    }
    if (mstest.multipleSelect("getSelects").length==0) {
        $("#confirmation").text("You need to choose at least one section")
        dialog_confirm.dialog({ title: "Message" });
        dialog_confirm.dialog("open")
    } else {
     dialog.dialog( "close" );
     dialog2.dialog( "open" );
    if($("#SavedReports option:selected").text() != "") {
         if ($("#SavedReports option:selected").hasClass("template")) {
         for(var i = 0; i < template_report.reports.length;  i++) {
           if (template_report.reports[i].name==$("#SavedReports option:selected").text()) {
             var saved_report = JSON.parse(template_report.reports[i].def);
           }
         }   
         } else
         {
         for (var report in report_list.reports) {
           if (report_list.reports[report].name==$("#SavedReports option:selected").text()) {
             var saved_report = JSON.parse(report_list.reports[report].def);
           }
         }
         }
         $( "#report_type" ).val(saved_report.report_type);
         if (saved_report.hasOwnProperty("pivot")) {
           $('input[name="outputtype"][value="pivot"]').prop('checked', true);
           $("#pivottable").prop("checked", true);
           $("#grid_menu_entry").html("Grid Layout");
           $("#pivot_menu_entry").html("&#10004; Pivot Layout");
                 $("#map_menu_entry").html("Map Layout");

          } 
          if (saved_report.hasOwnProperty("grid")) {
             $('input[name="outputtype"][value="grid"]').prop('checked', true);
             $("#gridtable").prop("checked", true);
             $("#grid_menu_entry").html("&#10004; Grid Layout");
             $("#pivot_menu_entry").html("Pivot Layout");
              $("#map_menu_entry").html("Map Layout");


          }
          if (saved_report.hasOwnProperty("map")) {
             $('input[name="outputtype"][value="map"]').prop('checked', true);
             $("#maptable").prop("checked", true);
             $("#map_menu_entry").html("&#10004; Map Layout");
             $("#grid_menu_entry").html("Grid Layout");
             $("#pivot_menu_entry").html("Pivot Layout");


          }
     }
     $( "#progressbar" ).show();
     $( ".progress-label" ).show();
     $("#fieldlist").hide();
    if(document.getElementById("refresh").checked==true) {
        old_report_config = {};
    } else {
        old_report_config = $.extend(true, {}, report_config);    }
    report_config = [];
    for(var property in section_config) {
        if(mstest.multipleSelect("getSelects").indexOf(property)>=0) {
        // alert(property+"  checked");
         for(var termnumber in terms_config[property]) {
             if ((terms_config[property][termnumber].startdate <= datepicker.value) && (terms_config[property][termnumber].enddate >= datepicker.value)) {
                 //alert(terms_config[property][termnumber].name);
                 var report_def = new Object();
                 report_def.termid = terms_config[property][termnumber].termid;
                 report_config[property] = report_def;
             }
         }
            if (roles_config[get_roles_section(property)].section=="waiting") {
             var report_def = new Object();
             report_def.termid = -1;
            report_config[property] = report_def;    
        }
            if (report_config[property] == null){
                $("#confirmation").text("Invalid Term for "+roles_config[get_roles_section(property)].sectionname+", no data will be selected")
                dialog_confirm.dialog({ title: "Message" });
                dialog_confirm.dialog( "open" );
            }
        } else
        { //alert(property+"  not checked") 
        }
    }   
    var report_type = $( "#report_type option:selected" ).text();
    get_data_array = [];
    get_data_array2 = [];
    
    for(var section in report_config) {
     //   Sentry.setUser({ id: section_config[section].groupname+" "+section_config[section].sectionname  });
        if (report_type == "Badge Stock") {
           var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/badges/stock/?action=getBadgeStock&section='+section_config[section].section_type+'&section_id='+section+'&term_id='+report_config[section].termid+'&seeIfShared=y';
            
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "badge_stock";
            get_data_array.push(get_data_line);
        }
        if (report_type == "Online Payments") {
           var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/onlinepayments/?action=getSchemes&sectionid='+section;
 
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "online_payment";
            get_data_array.push(get_data_line);
        }

        if ((report_type=="QM List")|(report_type=="Events & QM Lists")) {
           var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/quartermaster/?action=getListOfLists&section='+section_config[section].section_type+'&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "qm_list";
            get_data_array.push(get_data_line);
        }
        
        if (report_type == "User Access") {
           var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/settings/access/?action=getUsersForSection&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "user_access";
            get_data_array.push(get_data_line);
        }

        if ((report_type == "Members")|(report_type =="Programme & Attendance")|(report_type == "Members & Challenge Badges")|(report_type == "Members & Badges")|(report_type=="Events & Attendance")|(report_type == "Members & Staged Badges")|(report_type == "Members & Badges Details")|(report_type=="Members & Sections")|(report_type=="Members & WL")|(report_type=="Members & Maps")) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/settings/patrols/?action=get&sectionid='+section;
            report_config[section].patrol = "";
            report_config[section].members = "";
            report_config[section].memberconfig = "";
            report_config[section].flexiconfig = "";
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "patrol";
            get_data_array.push(get_data_line);
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/contact/grid/?action=getMembers';
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "POST";
            get_data_line.field = "members";
            get_data_line.postvar = "section_id="+section+"&term_id="+report_config[section].termid;
            get_data_array.push(get_data_line);
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/flexirecords/?action=getFlexiRecords&sectionid='+section+'&archived=n';
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "flexiconfig";
            get_data_array.push(get_data_line);

        //ext/members/flexirecords/?action=getFlexiRecords&sectionid='.$ss_value.'&archived=n
        // alert(section + " " + report_config[section].termid);
        }
        if (report_type=="Gift Aid") {
            report_config[section].giftaid = new Array();
            report_config[section].giftaids = new Array();
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/giftaid/?action=getStructure&sectionid='+section+'&termid='+report_config[section].termid+'&section='+section_config[section].section_type;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "giftaids";
            get_data_array.push(get_data_line);
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/giftaid/?action=getGrid&no-total=1&sectionid='+section+'&termid='+report_config[section].termid+'&section='+section_config[section].section_type;
          //  get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/giftaid/?action=getStructure&sectionid='+section+'&termid='+term_id+'&section="+section_config[section].section_type;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "giftaid";
            get_data_array.push(get_data_line);
        }
        if ((report_type == "Members & Badges")|(report_type == "Badges")|(report_type == "Members & Badges Details")|(report_type == "Members & Challenge Badges")|(report_type == "Members & Staged Badges")) {
            maxbadges = 5; badge_start=1;
            if (report_type == "Members & Challenge Badges") {
              maxbadges = 2; badge_start=1;    
            }
             if (report_type == "Members & Staged Badges") {
              maxbadges = 4; badge_start=3;    
            }
            for(var i = badge_start; i < maxbadges;  i++) {
//for(var i = 1; i < 2;  i++) {
            report_config[section].badges = new Array();
            report_config[section].memberbadges = "";
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/badges/records/?action=getBadgeStructureByType&a=1&section='+section_config[section].section_type+'&term_id='+report_config[section].termid+"&section_id="+section+"&type_id="+i;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "badges|"+i;
            get_data_array.push(get_data_line);
            } 
            if ((report_type == "Members & Badges")|(report_type == "Members & Challenge Badges")|(report_type == "Members & Badges Details")|(report_type == "Members & Staged Badges")) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/badges/badgesbyperson/?action=loadBadgesByMember&section='+section_config[section].section_type+'&sectionid='+section+'&term_id='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "memberbadges";
            get_data_array.push(get_data_line);
            }
        }
        if ((report_type == "Events")|(report_type=="Events & QM Lists")|(report_type=="Events & Attendance")|(report_type=="Shared Event Attendance")|(report_type=="Events & Badges")) {
            report_config[section].events = "";
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/summary/?action=get&sectionid='+section+'&termid='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "events";
            get_data_array.push(get_data_line);
            }
            
        if ((report_type == "Programme & Badges")|(report_type == "Programme & Attendance")){
            report_config[section].programme = "";
            var get_data_line = new Object();
          //  https://www.onlinescoutmanager.co.uk/ext/programme/?action=getProgrammeSummary&sectionid=3320&termid=521815
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/programme/?action=getProgrammeSummary&sectionid='+section+'&termid='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "programme";
            get_data_array.push(get_data_line);
        }    
        if ((report_type == "Programme & Attendance")) {
            report_config[section].attendance_config = "";
            var get_data_line = new Object();
          // https://www.onlinescoutmanager.co.uk/ext/members/attendance/?action=structure&sectionid=3320&termid=521815&section=scouts
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/attendance/?action=structure&sectionid='+section+'&termid='+report_config[section].termid+"&section="+section_config[section].section_type;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "attendance_config";
            get_data_array.push(get_data_line);
         //   https://www.onlinescoutmanager.co.uk/ext/members/attendance/?action=get&sectionid=3320&termid=521815&section=scouts&nototal=true
           report_config[section].attendance = "";
            var get_data_line = new Object();
             get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/attendance/?action=get&sectionid='+section+'&termid='+report_config[section].termid+"&section="+section_config[section].section_type+"&nototal=true";
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "attendance";
            get_data_array.push(get_data_line);
            
        }
    }
    
    $( ".progressbar" ).text = "Loading Data";
    }
    try {
    if (get_data_array[0].type == "GET") {
        get_data_xhr(0,assemble_data) } else {get_data_post_xhr(0,assemble_data) }; 
  }
    catch (error) {
          alert("We've hit an issue which may be due to the access you have in OSM (for reports that include members make sure you have Flexi Record Access)");
          throw new Error("We has an issue with this report type "+report_type+ " ");
    }    

}

function assemble_data() {
// Called after select fields (whic collects some of the data needed for this process
// This routine needs to collect the config data for member fields and Flexi-records as we need a member_id and a id for these
//    alert("Hello");
    get_data_array=[];
    get_data_array2=[];
    $( "#progressbar" ).progressbar({ value: false } );
     $( ".progress-label" ).text('Round 2');
     var report_type = $( "#report_type option:selected" ).text();
    for(var section in report_config) {
        if ((report_type=="Members")|(report_type=="Members & Badges")|(report_type=="Members & Challenge Badges")|(report_type=="Members & Badges Details")|(report_type=="Events & Attendance")|(report_type=="Members & Sections")|(report_type=="Members & WL")|(report_type=="Members & Maps")|(report_type == "Members & Staged Badges")) {
        var members_array = JSON.parse(report_config[section].members);
        var mc = false;
        report_config[section].member_sections = new Array();
        for (var scout in members_array.data) {
           // alert(members_array.data[scout].first_name);
           if (mc==false) {
           var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/customdata/?action=getData&section_id='+section;
            get_data_line.data = report_config[section];
            get_data_line.type = "POST";
            get_data_line.field = "memberconfig";
            get_data_line.olddata = old_report_config[section];  
            get_data_line.postvar = 'associated_type=member&context=members&associated_id='+members_array.data[scout].member_id;
            get_data_array.push(get_data_line);
        //    break;
            mc = true;
           }
           if (report_type=="Members & Sections") {
                var get_data_line = new Object();
                //https://www.onlinescoutmanager.co.uk/ext/members/contact/?action=getIndividual&sectionid=3320&scoutid=649811&termid=521815&context=members
                //  https://www.onlinescoutmanager.co.uk/members/contact/?action=getIndividual&sectionid=3320&scoutid=491560&termid=521815&context=members
                 get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/contact/?action=getIndividual&sectionid='+section+'&scoutid='+members_array.data[scout].member_id+'&termid='+report_config[section].termid+'&context=members';
                 get_data_line.data = report_config[section];
                 get_data_line.type = "GET";
                 get_data_line.field = "member_sections|"+members_array.data[scout].member_id;
                 get_data_line.olddata = old_report_config[section];  
             //    get_data_line.postvar = 'associated_type=member&context=members&associated_id='+members_array.data[scout].member_id;
                 get_data_array.push(get_data_line);
           }
           if (report_type=="Members & WL") {
                var get_data_line = new Object();
                //https://www.onlinescoutmanager.co.uk/ext/members/contact/?action=getIndividual&sectionid=3320&scoutid=649811&termid=521815&context=members
                //  https://www.onlinescoutmanager.co.uk/members/contact/?action=getIndividual&sectionid=3320&scoutid=491560&termid=521815&context=members
                 get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/audittrail/?action=getAuditTrail&section_id='+section; 
                 get_data_line.data = report_config[section];
                 get_data_line.type = "POST";
                 get_data_line.field = "member_changes|"+members_array.data[scout].member_id;
                 get_data_line.postvar = 'section_id='+section+'&type=member&id='+members_array.data[scout].member_id;
                 get_data_line.olddata = old_report_config[section];  
             //    get_data_line.postvar = 'associated_type=member&context=members&associated_id='+members_array.data[scout].member_id;
                 get_data_array.push(get_data_line);
           }
        };
        if (report_config[section].hasOwnProperty("flexiconfig")==true) {
        if (report_config[section].flexiconfig!="") {
        var flex_cfg_array = report_config[section].flexiconfig;
        if (flex_cfg_array.items.length > 0) {
        report_config[section].flexirecords = new Array();
        report_config[section].flexifields = new Array();
        }
        for(var flexi in flex_cfg_array.items) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/flexirecords/?action=getData&extraid='+flex_cfg_array.items[flexi].extraid+'&sectionid='+section+'&termid='+report_config[section].termid+'&section='+section_config[section].section_type;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "flexirecords|"+flex_cfg_array.items[flexi].extraid;
            get_data_array.push(get_data_line);
             var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/members/flexirecords/?action=getStructure&sectionid='+section+'&extraid='+flex_cfg_array.items[flexi].extraid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "flexifields|"+flex_cfg_array.items[flexi].extraid;
            get_data_array.push(get_data_line);
        }
        }
      }
      }
//https://www.onlinescoutmanager.co.uk/ext/quartermaster/?action=getList&listid=5071&section=scouts&sectionid=3320
        if ((report_type=="QM List")|(report_type=="Events & QM Lists")) {
          report_config[section].qmi = new Array();
          var qml =  (report_config[section].qm_list);
          for (var qi=0; qi< qml.data.length; qi++ ) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/quartermaster/?action=getList&listid='+qml.data[qi].id+'&section='+section_config[section].section_type+'&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "qmi|"+qml.data[qi].id;
            get_data_array.push(get_data_line);  
          }
           
        }
        
        if ((report_type=="Online Payments")) {
          report_config[section].opi = new Array();
          var opl =  (report_config[section].online_payment);
          for (var opi=0; opi< opl.items.length; opi++ ) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/onlinepayments/?action=getPaymentSchedule&sectionid='+section+"&schemeid="+opl.items[opi].schemeid+'&termid='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "opi|"+opl.items[opi].schemeid;
            get_data_array.push(get_data_line);  
          }
          
           
          
          report_config[section].ops = new Array();
          var opl =  (report_config[section].online_payment);
          for (var opi=0; opi< opl.items.length; opi++ ) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/finances/onlinepayments/?action=getPaymentStatus&sectionid='+section+"&schemeid="+opl.items[opi].schemeid+'&termid='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "ops|"+opl.items[opi].schemeid;
            get_data_array.push(get_data_line);  
          } 
        }
        
        
        if (report_type=="Programme & Badges") {
          report_config[section].prog = new Array();
          var pl =  (report_config[section].programme);
          for (var pi=0; pi< pl.items.length; pi++ ) {
            var get_data_line = new Object();
            //https://www.onlinescoutmanager.co.uk/ext/programme/?action=getProgramme&eveningid=5702217&sectionid=3320&termid=521815
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/programme/?action=getProgramme&eveningid='+pl.items[pi].eveningid+'&sectionid='+section+'&termid='+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "prog|"+pl.items[pi].eveningid;
            get_data_array.push(get_data_line);  
          }
           
        }

        //https://www.onlinescoutmanager.co.uk/ext/quartermaster/eventbookings/?action=loadListsForEvent&eventid=130344&section=scouts&sectionid=3320
        if (report_type=="Events & QM Lists") {
            report_config[section].eventqm = new Array();
            var el =  (report_config[section].events);
            for (var ev in el.items) {
                if (el.items[ev].startdate_g  >= datepicker.value) {
              var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/quartermaster/eventbookings/?action=loadListsForEvent&eventid='+el.items[ev].eventid+'&section=scouts&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventqm|"+el.items[ev].eventid;
            get_data_array.push(get_data_line);  
                }
            }
        }
        if (report_type=="Events & Badges") {
             report_config[section].eventcfg = new Array();
            var el =  (report_config[section].events);
            for (var ev in el.items) {
                if (el.items[ev].startdate_g  >= datepicker.value) {
              var get_data_line = new Object();
          get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/?action=getStructureForEvent&eventid='+el.items[ev].eventid+'&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventcfg|"+el.items[ev].eventid;
            get_data_array.push(get_data_line);  
                }
            }
        }
        if (report_type=="Shared Event Attendance") {
            report_config[section].eventsa = new Array();
            report_config[section].eventsac = new Array();
            report_config[section].eventcfg = new Array();
             
            var el =  (report_config[section].events);
            for (var ev in el.items) {
                if (el.items[ev].startdate_g  >= datepicker.value) {
              var get_data_line = new Object();
            // https://www.onlinescoutmanager.co.uk/ext/events/event/sharing/?action=getAttendance&eventid=944751&sectionid=26965&_v=2  
           
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/sharing/?action=getAttendance&eventid='+el.items[ev].eventid+'&sectionid='+section+'&_v=2 ';
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventsa|"+el.items[ev].eventid;
            get_data_array.push(get_data_line);  
             var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/?action=getStructureForEvent&eventid='+el.items[ev].eventid+'&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventcfg|"+el.items[ev].eventid;
            get_data_array.push(get_data_line); 
            var get_data_line = new Object();
             // https://www.onlinescoutmanager.co.uk/ext/events/event/sharing/?action=getStatus&eventid=944751&sectionid=26965&_v=2
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/sharing/?action=getStatus&eventid='+el.items[ev].eventid+'&sectionid='+section+'&_v=2 ';
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventsac|"+el.items[ev].eventid;
            get_data_array.push(get_data_line); 
                }
            }
        }
        if (report_type=="Events & Attendance") {
         report_config[section].eventcfg = new Array();
         report_config[section].eventatt = new Array();
            var el =  (report_config[section].events);
            for (var ev in el.items) {
            if (el.items[ev].startdate_g  >= datepicker.value) {
              var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/?action=getStructureForEvent&eventid='+el.items[ev].eventid+'&sectionid='+section;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventcfg|"+el.items[ev].eventid;
            get_data_array.push(get_data_line); 
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/events/event/?action=getAttendance&eventid='+el.items[ev].eventid+'&sectionid='+section+"&termid="+report_config[section].termid;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            get_data_line.field = "eventatt|"+el.items[ev].eventid;
            get_data_array.push(get_data_line);      
            }
            }
        }   
    }

   if ((report_type=="Members & Badges Details")|(report_type=="Members & Challenge Badges")|(report_type == "Members & Staged Badges")) {
      report_config[section].badgereq = new Array();
       report_config[section].badgewiz = new Array();
      for(var section in report_config) {
        for(var bt in report_config[section].badges) {
          var bl = (report_config[section].badges[bt]); 
          for(var bd in bl.details) {
       //     if (((report_type == "Members & Staged Badges")&((bd.badge_id=='94')||(bd.badge_id=='95')))||(report_type != "Members & Staged Badges")) {
            var get_data_line = new Object();
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/ext/badges/records/?action=getBadgeRecords&term_id='+report_config[section].termid+'&section='+section_config[section].section_type+"&badge_id="+bl.details[bd].badge_id+"&section_id="+section+"&badge_version="+bl.details[bd].badge_version;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            
            get_data_line.field = "badgereq|"+bl.details[bd].badge_identifier;
            get_data_array.push(get_data_line);

            var get_data_line = new Object();
            
            get_data_line.url = 'https://www.onlinescoutmanager.co.uk/v3/badges/records/wizard/?term_id='+report_config[section].termid+"&badge_id="+bl.details[bd].badge_id+"&section_id="+section+"&badge_version="+bl.details[bd].badge_version;
            get_data_line.data = report_config[section];
            get_data_line.olddata = old_report_config[section];    
            get_data_line.type = "GET";
            
            get_data_line.field = "badgewiz|"+bl.details[bd].badge_identifier;
            get_data_array.push(get_data_line);

         //   }


          }
        }
      }
    }

    if(get_data_array.length>0) {
        if (get_data_array[0].type == "POST" ) {
    get_data_post_xhr(0,assemble_data2);
        } else {get_data_xhr(0,assemble_data2)};
    } else {assemble_data2()}
    
}

function is_checked(a,v) {
    for (var l in a) {
        if (a[l]==v) { return " checked " }
    }
    return "";
}
function assemble_data2() {
    var field_list = "<div id=\"fieldtable\">Select the fields for your report from the list below<br><br>";
    field_list = field_list + "<a id=\"expandList\" class=\"ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover\">Expand All</a>";
    field_list = field_list + "<a id=\"collapseList\" class=\"ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only ui-state-hover\">Collapse All</a><ul id = \"expList\">";
    var core_fields = true;
   
    var core_field_list = [ { "fieldname" : "MC|Core|first_name" , "fieldlabel" : "First Name" },
                            { "fieldname" : "MC|Core|last_name" ,  "fieldlabel" : "Last Name"},
                           { "fieldname" : "MC|Core|full_name" ,  "fieldlabel" : "Full Name"},
                           { "fieldname" : "MC|Core|patrol" ,  "fieldlabel" : "Patrol"},
                           { "fieldname" : "MC|Core|joined" ,  "fieldlabel" : "Date Joined"},
                           { "fieldname" : "MC|Core|agejoined" ,  "fieldlabel" : "Age Joined"},
                           { "fieldname" : "MC|Core|started" ,  "fieldlabel" : "Date Started"},
                           { "fieldname" : "MC|Core|date_of_birth" ,  "fieldlabel" : "Date of Birth"},
                           { "fieldname" : "MC|Core|birth_month" ,  "fieldlabel" : "Month of Birth"},
                           { "fieldname" : "MC|Core|age" ,  "fieldlabel" : "Age"},
                           { "fieldname" : "MC|Core|age_years" ,  "fieldlabel" : "Age in Years"},
                           { "fieldname" : "MC|Core|full_age" ,  "fieldlabel" : "Age Detailed"},
                           { "fieldname" : "MC|Core|patrol_role_level" ,  "fieldlabel" : "Role ID"},
                           { "fieldname" : "MC|Core|patrol_role_level_label" ,  "fieldlabel" : "Patrol Role"},
                           { "fieldname" : "MC|Core|patrol_role_short" ,  "fieldlabel" : "Short Role"},
                            { "fieldname" : "MC|Core|section_name" ,  "fieldlabel" : "Section Name"},
                           { "fieldname" : "MC|Core|group_name" ,  "fieldlabel" : "Group Name"},
                           { "fieldname" : "MC|Core|timemovement" ,  "fieldlabel" : "Time as a Scout"},
                           { "fieldname" : "MC|Core|timesection" ,  "fieldlabel" : "Time in Section"},
                           { "fieldname" : "MC|Core|mbremailchk" ,  "fieldlabel" : "Member Email Check"},
                           { "fieldname" : "MC|Core|emgemailchk" ,  "fieldlabel" : "Emergency Email Check"},
                           { "fieldname" : "MC|Core|pcemailchk" ,  "fieldlabel" : "Primary Email Check"},
                           { "fieldname" : "MC|Core|member_id" ,  "fieldlabel" : "OSM ID"}

                          ];
                          
     var access_field_list = [ { "fieldname" : "MS|Access|firstname" , "fieldlabel" : "Name" },
                            { "fieldname" : "MC|Access|email" ,  "fieldlabel" : "Email"},
                           { "fieldname" : "MC|Access|lastlogin" ,  "fieldlabel" : "Last login"},
                           { "fieldname" : "MC|Access|numlogins" ,  "fieldlabel" : "Number of Logins"},
                           { "fieldname" : "MC|Access|section" ,  "fieldlabel" : "Section name"},
                            { "fieldname" : "MC|Access|rwa" ,  "fieldlabel" : "Read/Write/Admin"},
                           { "fieldname" : "MC|AccessP|badge" ,  "fieldlabel" : "Badge Access"},
                           { "fieldname" : "MC|AccessP|events" ,  "fieldlabel" : "Events Access"},
                           { "fieldname" : "MC|AccessP|finance" ,  "fieldlabel" : "Finance Access"},
                           { "fieldname" : "MC|AccessP|flexi" ,  "fieldlabel" : "Flexirecords Access"},
                           { "fieldname" : "MC|AccessP|member" ,  "fieldlabel" : "Member Access"},
                           { "fieldname" : "MC|AccessP|programme" ,  "fieldlabel" : "Programme Access"},
                           { "fieldname" : "MC|AccessP|quartermaster" ,  "fieldlabel" : "QM Access"},
                           { "fieldname" : "MC|AccessP|register" ,  "fieldlabel" : "Register Access"},
                           { "fieldname" : "MC|AccessP|user" ,  "fieldlabel" : "User Access"},
                          ];       
                          
    var programme_field_list = [ { "fieldname" : "MP|prog|endtime" , "fieldlabel" : "End Time" },
                                 { "fieldname" : "MP|prog|title" , "fieldlabel" : "Title" },
                                 { "fieldname" : "MP|prog|starttime" , "fieldlabel" : "Start Time" },
                                 { "fieldname" : "MP|prog|leaders" , "fieldlabel" : "Leader Notes" },
                                 { "fieldname" : "MP|prog|games" , "fieldlabel" : "Games" },
                                 { "fieldname" : "MP|prog|notesforparents" , "fieldlabel" : "Parent Notes" },
                                 { "fieldname" : "MP|prog|prenotes" , "fieldlabel" : "Pre Notes" },
                                 { "fieldname" : "MP|prog|postnotes" , "fieldlabel" : "Post Notes" },
                                 { "fieldname" : "MP|prog|notesforhelpingparents" , "fieldlabel" : "Parent Helper Notes" },
                                 { "fieldname" : "MP|prog|parentsrequired" , "fieldlabel" : "Parents Required" },
                                 { "fieldname" : "MP|prog|helpers" , "fieldlabel" : "Parent Helpers" },
                                 { "fieldname" : "MP|prog|unleaders" , "fieldlabel" : "Unavailable Leaders" }
                                ];
                                 
     
    var badge_field_list = [
        { "fieldname" : "BG|Badge|name", "fieldlabel" : "Badge Name" },
        { "fieldname" : "BG|Badge|group_name", "fieldlabel" : "Badge Group Name" },
        { "fieldname" : "BG|Badge|description", "fieldlabel" : "Badge Description" },
        { "fieldname" : "BG|Badge|badge_type", "fieldlabel" : "Badge Type" },
        { "fieldname" : "BG|Badge|badge_id", "fieldlabel" : "Badge ID" },
        { "fieldname" : "BG|Badge|badge_section", "fieldlabel" : "Section for Badge" }
                           ];
     
    var bm_field_list = [
        { "fieldname" : "BM|Badge|awarded", "fieldlabel" : "Badge Awarded" },
        { "fieldname" : "BM|Badge|awardeddet", "fieldlabel" : "Badge Awarded Detail" },
        { "fieldname" : "BM|Badge|awarded_date", "fieldlabel" : "Date Awarded" },
        { "fieldname" : "BM|Badge|status", "fieldlabel" : "% Complete" },
        { "fieldname" : "BM|Badge|statussym", "fieldlabel" : "Symbol % Complete" },
        { "fieldname" : "BM|Badge|completed", "fieldlabel" : "Completed" },
        { "fieldname" : "BM|Badge|due", "fieldlabel" : "Due" },
        { "fieldname" : "BM|Badge|dorc", "fieldlabel" : "Due or Completed" },
        { "fieldname" : "BM|Badge|yearcompleted", "fieldlabel" : "Year Awarded" },
         { "fieldname" : "BM|Badge|datedueaward", "fieldlabel" : "Date Awarded/Due" },
          { "fieldname" : "BM|Badge|yeardueaward", "fieldlabel" : "Year Awarded/Due" },
        ];
    var bm_field_detail_list = [
        { "fieldname" : "BD|Badge|name", "fieldlabel" : "Short Requirement" },
        { "fieldname" : "BD|Badge|tooltip", "fieldlabel" : "Long Requirement" },
        { "fieldname" : "BD|Badge|module", "fieldlabel" : "Section/Level" },
        { "fieldname" : "BD|Badge|reqstatus", "fieldlabel" : "Member Status" },
        { "fieldname" : "BD|Badge|needed", "fieldlabel" : "Required" },
        { "fieldname" : "BD|Badge|neededsym", "fieldlabel" : "Required Symbol" },
         { "fieldname" : "BD|Badge|countneeded", "fieldlabel" : "Number Needed" },
         { "fieldname" : "BD|Badge|countdone", "fieldlabel" : "Number Done" },
         { "fieldname" : "BD|Badge|countremain", "fieldlabel" : "Number Remaining" }
        ];
    var bs_field_list = [
          { "fieldname" : "BS|Badge|name", "fieldlabel" : "Badge Name" },
{ "fieldname" : "BS|Badge|due", "fieldlabel" : "Badges Due" },
{ "fieldname" : "BS|Badge|stock", "fieldlabel" : "Badge Stock" },
{ "fieldname" : "BS|Badge|buy", "fieldlabel" : "Badges to Buy" }
         ];
    var ev_field_list = [
        { "fieldname" : "EV|Event|cost", "fieldlabel" : "Cost" },
        { "fieldname" : "EV|Event|date", "fieldlabel" : "Start Date" },
        { "fieldname" : "EV|Event|enddate", "fieldlabel" : "End Date" },
        { "fieldname" : "EV|Event|name", "fieldlabel" : "Event Name" },
        { "fieldname" : "EV|Event|location", "fieldlabel" : "Location" },
        { "fieldname" : "EV|Event|group", "fieldlabel" : "Group Name" },
        { "fieldname" : "EV|Event|section", "fieldlabel" : "Section Name" },
        { "fieldname" : "EV|Event|yes", "fieldlabel" : "Attending" },
        { "fieldname" : "EV|Event|no", "fieldlabel" : "Not Attending" },
        
        ];
    var ev_att_list = [
        { "fieldname" : "EA|Event|attending", "fieldlabel" : "Attending" },
        { "fieldname" : "EA|Event|payment", "fieldlabel" : "Payment" },
         { "fieldname" : "EA|Event|firstname", "fieldlabel" : "First Name" },
        { "fieldname" : "EA|Event|lastname", "fieldlabel" : "Last Name" },
        { "fieldname" : "EA|Event|startage", "fieldlabel" : "Age at Start" },
        { "fieldname" : "EA|Event|startages", "fieldlabel" : "Age @ Start" }
        ]
   var qm_field_list = [
        { "fieldname" : "QL|List|name", "fieldlabel" : "QM List" },
        { "fieldname" : "QI|Item|name", "fieldlabel" : "QM Item" },
        { "fieldname" : "QI|Item|available", "fieldlabel" : "Qty Available" },
        { "fieldname" : "QI|Item|booked", "fieldlabel" : "Qty Booked" },
        { "fieldname" : "QI|Item|broken", "fieldlabel" : "Qty Broken" },
       { "fieldname" : "QI|Item|condition", "fieldlabel" : "Condition" },
       { "fieldname" : "QI|Item|description", "fieldlabel" : "Description" },
       { "fieldname" : "QI|Item|quantity", "fieldlabel" : "Total Qty" },
       { "fieldname" : "QI|Item|location", "fieldlabel" : "Location" },
       { "fieldname" : "QM|Item|Notes","fieldlabel" : "Notes" },
       { "fieldname" : "QM|Item|Weight","fieldlabel" : "Weight" },
       { "fieldname" : "QM|Item|TWeight","fieldlabel" : "Total Weight" }
        ]; 
    var qml_field_list = [
        { "fieldname" : "QL|List|name", "fieldlabel" : "QM List" },
        { "fieldname" : "QI|Item|1", "fieldlabel" : "QM Item" },
        { "fieldname" : "QI|Item|7", "fieldlabel" : "Qty Broken" },
       { "fieldname" : "QI|Item|5", "fieldlabel" : "Condition" },
       { "fieldname" : "QI|Item|2", "fieldlabel" : "Description" },
       { "fieldname" : "QI|Item|6", "fieldlabel" : "Total Qty" },
       { "fieldname" : "QI|Item|3", "fieldlabel" : "Location" },
       { "fieldname" : "QI|Item|8", "fieldlabel" : "Purchase Date" },
       { "fieldname" : "QI|Item|9", "fieldlabel" : "Renewal Price" },
       { "fieldname" : "QI|Item|4", "fieldlabel" : "Notes" },
       { "fieldname" : "QI|Item|totalvalue", "fieldlabel" : "Total Value" },
       { "fieldname" : "QI|Item|weight", "fieldlabel" : "Weight" }
        ]; 
    var pl_field_list = [
        { "fieldname" : "PL|Programme|title", "fieldlabel" : "Title" },
        { "fieldname" : "PL|Programme|meetingdate", "fieldlabel" : "Date" },
        { "fieldname" : "PL|Programme|group", "fieldlabel" : "Group" },
        { "fieldname" : "PL|Programme|section", "fieldlabel" : "Section" },
        { "fieldname" : "PL|Programme|notesforhelpingparents", "fieldlabel" : "Helper Notes" },
        { "fieldname" : "PL|Programme|notesforparents", "fieldlabel" : "Parent Notes" },
        { "fieldname" : "PL|Programme|games", "fieldlabel" : "Games Notes" },
        { "fieldname" : "PL|Programme|prenotes", "fieldlabel" : "Pre Notes" },
        { "fieldname" : "PL|Programme|postnotes", "fieldlabel" : "Post Notes" },
        { "fieldname" : "PL|Programme|leaders", "fieldlabel" : "Leader Notes" },
        ];
    var pi_field_list = [
        { "fieldname" : "PI|Progs|badgetypeLongName", "fieldlabel" : "Badge Type" },
        { "fieldname" : "PI|Progs|badgeLongName", "fieldlabel" : "Badge Name" },
        { "fieldname" : "PI|Progs|columnnameLongName", "fieldlabel" : "Requirement" }
        ];
      var att_field_list = [
        { "fieldname" : "AT|Attendance|attendance", "fieldlabel" : "Attended?" },
         { "fieldname" : "AT|Attendance|attendances", "fieldlabel" : "Attended Symbol" },
         { "fieldname" : "AT|Attendance|termid", "fieldlabel" : "Term ID" },
         { "fieldname" : "AT|Attendance|termname", "fieldlabel" : "Term Name" },
        ];
      var wl_field_list = [
        { "fieldname" : "WL|Added", "fieldlabel" : "Added to WL" },
         { "fieldname" : "WL|Moved", "fieldlabel" : "Moved to Section" },
           { "fieldname" : "WL|Ageadded", "fieldlabel" : "Full Age when Added" },
               { "fieldname" : "WL|Ageonmove", "fieldlabel" : "Full Age when Moved" },
                { "fieldname" : "WL|Ageaddeds", "fieldlabel" : "Age when Added" },
               { "fieldname" : "WL|Ageonmoves", "fieldlabel" : "Age when Moved" },
           { "fieldname" : "WL|TimeonWL", "fieldlabel" : "Time on WL" },
            { "fieldname" : "WL|TimeonWLF", "fieldlabel" : "Time on WL Full" },
               { "fieldname" : "WL|TimeonWLD", "fieldlabel" : "Time on WL Days" },
        ];
        
        var op_field_list = [
        { "fieldname" : "OS|schedule|name", "fieldlabel" : "Payment Schedule" },
        { "fieldname" : "OS|schedule|schemeid", "fieldlabel" : "Schedule ID" },
        { "fieldname" : "OP|payment|name", "fieldlabel" : "Payment Name" },
         { "fieldname" : "OP|payment|paymentid", "fieldlabel" : "Payment ID" },
        { "fieldname" : "OP|payment|amount", "fieldlabel" : "Payment Amount" },
        { "fieldname" : "OP|payment|date", "fieldlabel" : "Payment Date" },
        { "fieldname" : "OP|payment|is_past", "fieldlabel" : "Payment Past?" },
        { "fieldname" : "OM|member|firstname", "fieldlabel" : "First Name" },
        { "fieldname" : "OM|member|lastname", "fieldlabel" : "Last Name" },
        { "fieldname" : "OM|member|patrolid", "fieldlabel" : "Patrol ID" },
        { "fieldname" : "OM|member|scoutid", "fieldlabel" : "Scout ID" },
        { "fieldname" : "OM|member|directdebit", "fieldlabel" : "Direct Debit" },
         { "fieldname" : "OM|member|dob", "fieldlabel" : "Date of Birth" },
        { "fieldname" : "OT|member|status", "fieldlabel" : "Payment Status" },
        ];
        
        
        var map_field_list = [
        { "fieldname" : "MQ|IMD", "fieldlabel" : "IMD" }
        ];
     var sec_field_list = [
          { "fieldname" : "SC|attendance|attendance", "fieldlabel" : "Total Attendance" }
         ];
     var sea_field_list = [
        { "fieldname" : "SA|attendance|firstname", "fieldlabel" : "First Name" },
        { "fieldname" : "SA|attendance|lastname", "fieldlabel" : "Last Name" },
        { "fieldname" : "SA|attendance|fullname", "fieldlabel" : "Full Name" },
        { "fieldname" : "SA|attendance|dob", "fieldlabel" : "Date of Birth" },
        { "fieldname" : "SA|attendance|age", "fieldlabel" : "Age" },
        { "fieldname" : "SA|attendance|groupname", "fieldlabel" : "Att. Group Name" },
        { "fieldname" : "SA|attendance|sectionname", "fieldlabel" : "Att.Section Name" },
        { "fieldname" : "SA|attendance|patrolid", "fieldlabel" : "Patrol ID" },
        { "fieldname" : "SA|attendance|patrol", "fieldlabel" : "Patrol" },
        { "fieldname" : "SA|attendance|attending", "fieldlabel" : "Attending" },
        { "fieldname" : "SA|Event|startage", "fieldlabel" : "Age at Start" },
        { "fieldname" : "SA|Event|startages", "fieldlabel" : "Age @ Start" }
        ];
    var searchIDs = $('#fieldtable input:checked').map(function(){
        
      return $(this).val();
        
    });
    var checklist = searchIDs.get();
    var saved_report = new Object();
     if($("#SavedReports option:selected").text() != "") {
      if ($("#SavedReports option:selected").hasClass("template")) {
        for(var i = 0; i < template_report.reports.length;  i++) {
           if (template_report.reports[i].name==$("#SavedReports option:selected").text()) {
             var saved_report = JSON.parse(template_report.reports[i].def);
           }
         }  
       } else {
       for (var report in report_list.reports) {
         if (report_list.reports[report].name==$("#SavedReports option:selected").text()) {
        var saved_report = JSON.parse(report_list.reports[report].def);
         }
       }
       }
       // var saved_report = JSON.parse(GM_getValue($("#SavedReports option:selected").text()));
         checklist = saved_report.fields;
       
     }
    var report_type = $( "#report_type option:selected" ).text();
    $("#fieldlist").empty();
    $("#fieldlist").show();
     if ((report_type=="Members & Badges")|(report_type=="Members")|(report_type=="Programme & Attendance")|(report_type=="Events & Attendance")|(report_type=="Members & Badges Details")|(report_type=="Members & Challenge Badges")|(report_type=="Members & Sections")|(report_type=="Members & WL")|(report_type=="Members & Maps")|(report_type == "Members & Staged Badges") ){
    field_list = field_list + "<li>Members";
    field_list = field_list + "<ul><li>Core Fields";
    field_list = field_list + "<ul><li>Core Member Fields<ul>";
    for (var core in core_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+core_field_list[core].fieldlabel+"\" value=\""+core_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+core_field_list[core].fieldname+"\""+is_checked(checklist,core_field_list[core].fieldname)+"><label for=\""+core_field_list[core].fieldname+"\">"+core_field_list[core].fieldlabel + "</label></li>";
    }   
    field_list = field_list + "</ul></li>";
    for(var section in report_config) {
        if ((report_config[section].memberconfig !== "")&&(core_fields === true)) {
     var fields_array = JSON.parse(report_config[section].memberconfig);
            core_fields = false;
        for(var fieldgroup in fields_array['data']) {
            // alert(fields_array['data'][fieldgroup].name);
            if (fields_array['data'][fieldgroup].is_considered_core == "yes") {
              field_list = field_list + "<li>" + fields_array['data'][fieldgroup].name + "<ul>";
              for (var fieldlist in fields_array['data'][fieldgroup]['columns']) {
                  if ( fields_array['data'][fieldgroup]['columns'][fieldlist].is_core == "yes" ) {
                var chklbl = fields_array['data'][fieldgroup]['columns'][fieldlist].label;

                var chkval = "MA|" + fields_array['data'][fieldgroup].group_id + "|" + fields_array['data'][fieldgroup]['columns'][fieldlist].column_id; 
var chklbl2 = "<label for=\""+chkval+"\">"+fields_array['data'][fieldgroup]['columns'][fieldlist].label+"</label>";
                if ((report_type!="Members & Maps")|((report_type=="Members & Maps") & (chklbl.indexOf("Postcode")==-1))){  
                field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl+ " " +  fields_array['data'][fieldgroup].group_id+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+"><label for=\""+chkval+"\">"+chklbl + " " +  fields_array['data'][fieldgroup].group_id + "</label><br></li>";
                }
                  }
              }
              field_list = field_list + "</ul></li>";
            }
        }
        }
        if (core_fields === false) { break };
    }
    
    field_list = field_list + "</li></ul>"
    
    // Sectional Fields (inc Flex)
    
    for( section in report_config) {
        field_list = field_list + "<li>Additional fields for "+ roles_config[get_roles_section(section)].groupname+":"+roles_config[get_roles_section(section)].sectionname + "<ul>";
       if ((report_config[section].memberconfig !== "")) {
        
        var fields_array = JSON.parse(report_config[section].memberconfig);
            core_fields = false;
        for( fieldgroup in fields_array['data']) {
            var print_header = true;
           for (var fieldlist in fields_array['data'][fieldgroup]['columns']) {
               if ( fields_array['data'][fieldgroup]['columns'][fieldlist].is_core == "no" ) {
                  if ( print_header===true) {
                     field_list = field_list + "<li>" + fields_array['data'][fieldgroup].name + "<ul>";      
                     print_header = false;
                  };
                var chklbl =fields_array['data'][fieldgroup]['columns'][fieldlist].label;
var chklbl2 = "<label for=\""+chklbl+"\">"+fields_array['data'][fieldgroup]['columns'][fieldlist].label+"</label>";
                var chkval = "MA|" + fields_array['data'][fieldgroup].group_id + "|" + fields_array['data'][fieldgroup]['columns'][fieldlist].column_id; 
                field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+">"+chklbl2 + "<br></li>";
              }
           }
           if ( print_header===false) {
           field_list = field_list + "</ul></li>";
           };
           
        } 
       }
            // Flexi
           // var flex_cfg_array = JSON.parse(report_config[section].flexiconfig);
    
         //   for(var flexi in flex_cfg_array.items) {
          for(var flexi in report_config[section].flexifields) {
                //var flex_cfg = JSON.parse(report_config[section].flexiconfig[flex_cfg_array.items[flexi].extraid]);
                //var flex_cfg = flex_cfg_array.items[flexi];
              var flex_cfg = (report_config[section].flexifields[flexi]);
                field_list = field_list + "<li>"+ flex_cfg.name+"<ul>";
                    for (var flexif in flex_cfg.structure[1].rows) {
                    var chklbl = "<label>"+flex_cfg.structure[1].rows[flexif].name+"</label>";
var chklbl2 = flex_cfg.structure[1].rows[flexif].name;
                           //   var chkval = "MF"+"|"+flex_cfg_array.items[flexi].extraid+"|"+flex_cfg.structure[1].rows[flexif].field;    
                        var chkval = "MF"+"|"+flexi+"|"+flex_cfg.structure[1].rows[flexif].field;    
                    field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl2+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+">"+chklbl+"</li>";
                }
                field_list = field_list + "</ul></li>"; // Flex end
            }
            
            field_list = field_list + "</ul></li>";
        
        
    }
    
   
    //field_list = field_list + "</ul>";      
    field_list = field_list + "</li></ul>"; // Members
}
    if ((report_type=="Members & WL")){
        field_list = field_list + "<li>Waiting List<ul>";
        for (var core in wl_field_list) {
             field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+wl_field_list[core].fieldlabel+"\" value=\""+wl_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+wl_field_list[core].fieldname+"\""+is_checked(checklist,wl_field_list[core].fieldname)+">"+wl_field_list[core].fieldlabel + "</li>";
            
        }
         field_list = field_list + "</ul></li>"; // WL
    } 
    
    if ((report_type=="Members & Maps")){
        field_list = field_list + "<li>Member Postcode Fields<ul>";
          core_fields = true;
          for(var section in report_config) {
             if ((report_config[section].memberconfig !== "")&&(core_fields === true)) {
                var fields_array = JSON.parse(report_config[section].memberconfig);
                core_fields = false;
                for(var fieldgroup in fields_array['data']) {
                  // alert(fields_array['data'][fieldgroup].name);
                  if (fields_array['data'][fieldgroup].is_considered_core == "yes") {
                     // field_list = field_list + "<li>" + fields_array['data'][fieldgroup].name + "<ul>";
                     for (var fieldlist in fields_array['data'][fieldgroup]['columns']) {
                        if ( fields_array['data'][fieldgroup]['columns'][fieldlist].is_core == "yes" ) {
                        var chklbl = fields_array['data'][fieldgroup]['columns'][fieldlist].label;
                        if (chklbl.indexOf("Postcode")>-1) {
                            var chkval = "MA|" + fields_array['data'][fieldgroup].group_id + "|" + fields_array['data'][fieldgroup]['columns'][fieldlist].column_id; 
                            var chklbl2 = "<label for=\""+chkval+"\">"+fields_array['data'][fieldgroup]['columns'][fieldlist].label+"</label>";
                            field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl+ " " +  fields_array['data'][fieldgroup].group_id+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+"><label for=\""+chkval+"\">"+chklbl + " " + fields_array['data'][fieldgroup].name + " " +fields_array['data'][fieldgroup].group_id + "</label><br></li>";
                        }
                  }
              }
             
            }
        }
        }
        if (core_fields === false) { break };
    }
     field_list = field_list + "</ul></li>";
      
        
        field_list = field_list + "<li>Geodata<ul>";
        for (var core in map_field_list) {
             field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+map_field_list[core].fieldlabel+"\" value=\""+map_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+map_field_list[core].fieldname+"\""+is_checked(checklist,map_field_list[core].fieldname)+">"+map_field_list[core].fieldlabel + "</li>";
            
        }
         field_list = field_list + "</ul></li>"; // WL
    } 
    if ((report_type=="Members & Badges Details")|(report_type=="Members & Badges")|(report_type=="Badges")|(report_type=="Members & Challenge Badges")|(report_type == "Members & Staged Badges") ){
    field_list = field_list + "<li>Badges<ul>";
    for (var core in badge_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+badge_field_list[core].fieldlabel+"\" value=\""+badge_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+badge_field_list[core].fieldname+"\""+is_checked(checklist,badge_field_list[core].fieldname)+">"+badge_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; // Badges
    }
    
    if ((report_type=="Online Payments")) {
    field_list = field_list + "<li>Online Payments<ul>";
    for (var core in op_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+op_field_list[core].fieldlabel+"\" value=\""+op_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+op_field_list[core].fieldname+"\""+is_checked(checklist,op_field_list[core].fieldname)+">"+op_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }
    
    
    if ((report_type=="Members & Badges")|(report_type=="Members & Challenge Badges")|(report_type=="Members & Badges Details")|(report_type == "Members & Staged Badges")) {
    field_list = field_list + "<li>Badges per Member<ul>";
    for (var core in bm_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+bm_field_list[core].fieldlabel+"\" value=\""+bm_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+bm_field_list[core].fieldname+"\""+is_checked(checklist,bm_field_list[core].fieldname)+">"+bm_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; // Badges
    }
    if ((report_type=="Members & Challenge Badges")|(report_type=="Members & Badges Details")|(report_type == "Members & Staged Badges")) {
field_list = field_list + "<li>Badge Requirements per Member<ul>";
    for (var core in bm_field_detail_list) {    
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+bm_field_detail_list[core].fieldlabel+"\" value=\""+bm_field_detail_list[core].fieldname;
        field_list = field_list + "\" id=\""+bm_field_detail_list[core].fieldname+"\""+is_checked(checklist,bm_field_detail_list[core].fieldname)+">"+bm_field_detail_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; // Badges

    }
    if ((report_type=="Events")|(report_type=="Events & QM Lists")|(report_type=="Events & Attendance")|(report_type=="Shared Event Attendance") ){
    field_list = field_list + "<li>Events<ul>";
    for (var core in ev_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+ev_field_list[core].fieldlabel+"\" value=\""+ev_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+ev_field_list[core].fieldname+"\""+is_checked(checklist,ev_field_list[core].fieldname)+">"+ev_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }
    
  
    
    if ((report_type=="Programme & Badges")|(report_type=="Programme & Attendance") ){
    field_list = field_list + "<li>Programme<ul>";
    for (var core in pl_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+pl_field_list[core].fieldlabel+"\" value=\""+pl_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+pl_field_list[core].fieldname+"\""+is_checked(checklist,pl_field_list[core].fieldname)+">"+pl_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    if (report_type=="Programme & Badges") {
    field_list = field_list + "<li>Badge Info<ul>";
    for (var core in pi_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+pi_field_list[core].fieldlabel+"\" value=\""+pi_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+pi_field_list[core].fieldname+"\""+is_checked(checklist,pi_field_list[core].fieldname)+">"+pi_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>";
    }
    }
    if (report_type=="Programme & Attendance") {
         field_list = field_list + "<li>Attendance<ul>";
         for (var core in att_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+att_field_list[core].fieldlabel+"\" value=\""+att_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+att_field_list[core].fieldname+"\""+is_checked(checklist,att_field_list[core].fieldname)+">"+att_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }
    
     if ((report_type=="Shared Event Attendance") ){
           field_list = field_list + "<li>Shared Event Attendance<ul>";
            for (var core in  sec_field_list) {
        
              field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+sec_field_list[core].fieldlabel+"\" value=\""+sec_field_list[core].fieldname;
              field_list = field_list + "\" id=\""+sec_field_list[core].fieldname+"\""+is_checked(checklist,sec_field_list[core].fieldname)+">"+sec_field_list[core].fieldlabel + "</li>";
            }
           field_list = field_list + "<li>Shared Event Attendees<ul>";
            for (var core in  sea_field_list) {
        
              field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+sea_field_list[core].fieldlabel+"\" value=\""+sea_field_list[core].fieldname;
              field_list = field_list + "\" id=\""+sea_field_list[core].fieldname+"\""+is_checked(checklist,sea_field_list[core].fieldname)+">"+sea_field_list[core].fieldlabel + "</li>";
            }
            
            for (var section in report_config) {
        field_list = field_list + "<li>Events for "+roles_config[get_roles_section(section)].groupname+":"+roles_config[ get_roles_section(section) ].sectionname +"<ul>"
        for (var events in report_config[section].eventcfg) {
            var event_config = (report_config[section].eventcfg[events]);
            var event_fields = []
            if ((event_config.config!="{}")&(event_config.config!="")&(event_config.config!=null)&(event_config.startdate >= datepicker.value ) ) {
                event_fields = JSON.parse(event_config.config);  }  
            if (event_fields===null) { event_fields = [];}
         //   if (event_fields.length>0) {
if (event_config.structure[1].rows.length>0) {

                field_list = field_list + "<li>"+event_config.name+"<ul>" }
           // for (var event_f in event_fields) {
              for (var event_f in event_config.structure[1].rows) {
               // var chkval = "EA|"+event_config.eventid+"|"+event_fields[event_f].id;
var chkval = "EA|"+event_config.eventid+"|"+event_config.structure[1].rows[event_f].field;
     //           var chklbl = event_fields[event_f].name;
var chklbl = event_config.structure[1].rows[event_f].name;
                field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+">"+chklbl + "<br></li>";
                // field_list = field_list + "<li>" + event_fields[event_f].name + "</li>"
            }
          //  if (event_fields.length>0) { field_list = field_list + "</ul></li>" }
if (event_config.structure[1].rows.length>0) { field_list = field_list + "</ul></li>" }

        }
            field_list = field_list + "</ul></li>"; 
        }
    field_list = field_list + "</ul></li>"; 
            
     }
     
         if ((report_type=="Events & Badges")){
    field_list = field_list + "<li>Events<ul>";
     field_list = field_list + "<li>Events<ul>";
    for (var core in ev_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+ev_field_list[core].fieldlabel+"\" value=\""+ev_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+ev_field_list[core].fieldname+"\""+is_checked(checklist,ev_field_list[core].fieldname)+">"+ev_field_list[core].fieldlabel + "</li>";
    } 
     
    field_list = field_list + "</ul></li>"; 
    
    field_list = field_list + "<li>Badge Info<ul>";
    for (var core in pi_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+pi_field_list[core].fieldlabel+"\" value=\""+pi_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+pi_field_list[core].fieldname+"\""+is_checked(checklist,pi_field_list[core].fieldname)+">"+pi_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>";
    
    }
     
     
    if ((report_type=="Events & Attendance") ){
    field_list = field_list + "<li>Event Attendance<ul>";
    for (var core in  ev_att_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+ev_att_list[core].fieldlabel+"\" value=\""+ev_att_list[core].fieldname;
        field_list = field_list + "\" id=\""+ev_att_list[core].fieldname+"\""+is_checked(checklist,ev_att_list[core].fieldname)+">"+ev_att_list[core].fieldlabel + "</li>";
    } 
        for (var section in report_config) {
        field_list = field_list + "<li>Events for "+roles_config[get_roles_section(section)].groupname+":"+roles_config[ get_roles_section(section) ].sectionname +"<ul>"
        for (var events in report_config[section].eventcfg) {
            var event_config = (report_config[section].eventcfg[events]);
            var event_fields = []
            if ((event_config.config!="{}")&(event_config.config!="")&(event_config.config!=null)&(event_config.startdate >= datepicker.value ) ) {
                event_fields = JSON.parse(event_config.config);  }  
            if (event_fields===null) { event_fields = [];}
         //   if (event_fields.length>0) {
if (event_config.structure[1].rows.length>0) {

                field_list = field_list + "<li>"+event_config.name+"<ul>" }
           // for (var event_f in event_fields) {
              for (var event_f in event_config.structure[1].rows) {
               // var chkval = "EA|"+event_config.eventid+"|"+event_fields[event_f].id;
var chkval = "EA|"+event_config.eventid+"|"+event_config.structure[1].rows[event_f].field;
     //           var chklbl = event_fields[event_f].name;
var chklbl = event_config.structure[1].rows[event_f].name;
                field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+chklbl+"\" value=\""+chkval+"\" id=\""+chkval+"\""+is_checked(checklist,chkval)+">"+chklbl + "<br></li>";
                // field_list = field_list + "<li>" + event_fields[event_f].name + "</li>"
            }
          //  if (event_fields.length>0) { field_list = field_list + "</ul></li>" }
if (event_config.structure[1].rows.length>0) { field_list = field_list + "</ul></li>" }

        }
            field_list = field_list + "</ul></li>"; 
        }
    field_list = field_list + "</ul></li>"; 
    }

    if (report_type == "Badge Stock") {
    field_list = field_list + "<li>Badge Stock<ul>";
    for (var core in bs_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+bs_field_list[core].fieldlabel+"\" value=\""+bs_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+bs_field_list[core].fieldname+"\""+is_checked(checklist,bs_field_list[core].fieldname)+">"+bs_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }
    
    if ((report_type=="Gift Aid")) {
        field_list = field_list + "<li>Gift Aid<ul>";
        ga_flag = true;
        for (var section in report_config) {
          if (ga_flag) {
              var ga_config = (report_config[section].giftaids[0]['rows']);
              for (var gaf=0;gaf<ga_config.length;gaf++){
                 field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+ga_config[gaf].name+"\" value=\""+ga_config[gaf].field;
                 field_list = field_list + "\" id=\""+ga_config[gaf].field+"\""+is_checked(checklist,ga_config[gaf].field)+">"+ga_config[gaf].name + "</li>";   
              }
               field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+"Title"+"\" value=\""+"title";
               field_list = field_list + "\" id=\""+"title"+"\""+is_checked(checklist,"title")+">"+"Title" + "</li>";   
               field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+"Status"+"\" value=\""+"status";
               field_list = field_list + "\" id=\""+"status"+"\""+is_checked(checklist,"status")+">"+"Status" + "</li>";   
          }

        } 
    field_list = field_list + "</ul></li>"; 
    }
    if ((report_type=="QM List") ){
    field_list = field_list + "<li>QM List<ul>";
    for (var core in qml_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+qml_field_list[core].fieldlabel+"\" value=\""+qml_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+qml_field_list[core].fieldname+"\""+is_checked(checklist,qml_field_list[core].fieldname)+">"+qml_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }

    if ((report_type=="Events & QM Lists") ){
    field_list = field_list + "<li>QM Lists<ul>";
    for (var core in qm_field_list) {
        
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+qm_field_list[core].fieldlabel+"\" value=\""+qm_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+qm_field_list[core].fieldname+"\""+is_checked(checklist,qm_field_list[core].fieldname)+">"+qm_field_list[core].fieldlabel + "</li>";
    } 
    field_list = field_list + "</ul></li>"; 
    }
    if (report_type=="User Access") {
     field_list = field_list + "<li>User Access<ul>";
     for (var core in access_field_list) {
        field_list = field_list + "<li class=\"chkfld\"><input type=\"checkbox\" name=\""+access_field_list[core].fieldlabel+"\" value=\""+access_field_list[core].fieldname;
        field_list = field_list + "\" id=\""+access_field_list[core].fieldname+"\""+is_checked(checklist,access_field_list[core].fieldname)+">"+access_field_list[core].fieldlabel + "</li>"; 
     }
    }

    field_list = field_list + "</ul></div>";
      $("#fieldlist").empty();
     $("#fieldlist").append(field_list);
    //alert("Hello 2");
    $( "#progressbar" ).hide();
    $( ".progress-label" ).hide();
      $('#expList').find('li:has(ul)')
      .unbind('click')
      .click(function(event) {
        if(this == event.target) {
           $(this).toggleClass('expanded');
           $(this).children('ul').toggle('medium');
        }
        // return false;
       }).addClass('collapsed')
      .removeClass('expanded')
      .children('ul').hide();

$('#expandList').unbind('click').click(function() {
    $('.collapsed').addClass('expanded');
    $('.collapsed').children().show('medium');
  });
  $('#collapseList').unbind('click').click(function() {
    $('.collapsed').removeClass('expanded');
    $('.collapsed').children().hide('medium');
  });
}


function get_data_xhr2(c,f) {
var do_http = true;
        $( "#progressbar" ).progressbar({ value: 100 * ( (c + 1) / get_data_array.length )});
        $( ".progress-label" ).text(get_data_array[c].field);
        if (typeof get_data_array[c].olddata!= "undefined") {
          var tfield = get_data_array[c].field;
          var tindex = "";
          if (tfield.indexOf("|")>1) {
            tindex = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
            tfield = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
           }  


          if ((typeof get_data_array[c].olddata[tfield] != "undefined")) {
            if (tindex=="") {
              get_data_array[c].data[tfield] = get_data_array[c].olddata[tfield]; 
              do_http = false;
            } 
            
            if (tindex!="") {
               if ((typeof get_data_array[c].olddata[tfield][tindex] != "undefined")) {        
                get_data_array[c].data[tfield][tindex] = get_data_array[c].olddata[tfield][tindex]; 
                do_http = false;
              }
              
            }
          }
        if (do_http==false) {
          if ((get_data_array.length -1)  != c ) {
             if (get_data_array[c+1].type == "GET") { get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
           } else { alert('f();'); }
        }
    }
    
    if (do_http === true ) {
    var url = get_data_array[c].url;
    var osmpath = url.substring(37,url.indexOf("?"));
    url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
    p2 = [];
    if (security !== null ) {
      p2['secret'] = security.secret;
      p2['userid'] = security.userid;
    }

    var obj = $.extend({}, p2);
    $.post(url,$.param(obj),function(data,status){
       var index = "";
       if (get_data_array[c].field.indexOf("|")>1) {
          index = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          get_data_array[c].field = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
       }

       if (index=="") { get_data_array[c].data[get_data_array[c].field] = data; }
                    else 
                      { get_data_array[c].data[get_data_array[c].field][index] = data; }
      
      if ((get_data_array.length -1)  != c ) {
       if (get_data_array[c+1].type == "GET") {
              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
              } else { 
              f();
              }
                 
      });

}
}


function get_data_xhr(c,f) {


// Faster Block
//if ((get_data_array.length -1)  != c ) {
//       if (get_data_array[c+1].type == "GET") {
//              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
//    } else { 
//       f();
//             };
                 
     
// End of Faster


var do_http = true;
       // $( "#progressbar" ).progressbar({ value: 100 * ( (c + 1) / get_data_array.length )});
       // $( ".progress-label" ).text(get_data_array[c].field);
        if (typeof get_data_array[c].olddata!= "undefined") {
          var tfield = get_data_array[c].field;
          var tindex = "";
          if (tfield.indexOf("|")>1) {
            tindex = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
            tfield = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
           }  


          if ((typeof get_data_array[c].olddata[tfield] != "undefined")) {
            if (tindex=="") {
              get_data_array[c].data[tfield] = get_data_array[c].olddata[tfield]; 
              do_http = false;
            } 
            
            if (tindex!="") {
               if ((typeof get_data_array[c].olddata[tfield][tindex] != "undefined")) {        
                get_data_array[c].data[tfield][tindex] = get_data_array[c].olddata[tfield][tindex]; 
                do_http = false;
              }
              
            }
          }
        if (do_http==false) {
  //       if ((get_data_array.length -1)  != c ) {
  //         if (get_data_array[c+1].type == "GET") { get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
  //       } else { f(); }
$( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           $( ".progress-label" ).text(get_data_array[c].field);

           get_data_array2.push(get_data_array[c]);
           if ((get_data_array.length -1)  == c  ) {f();} else { if (get_data_array[c+1].type == "GET") { get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };};
        }
    }
    
    if (do_http === true ) {
    var url = get_data_array[c].url;
    var osmpath = url.substring(37,url.indexOf("?"));
    url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
    p2 = [];
    

    var obj = $.extend({}, p2);
    check_xhr();
    var request = $.ajax({
  url: url,
  method: "POST",
    headers: {"Authorization" : 'Bearer '+oauthcode.data.access},
  data: $.param(obj),
  dataType: "json",
   error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.'); },
success: function(data,status,req) {
    	if (req.getResponseHeader("x-blocked")!=null){
			alert("");
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
			}
			if (req.getResponseHeader("retry-after")!=null){
			alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" "+get_data_array[c].field);
			}	
  if (req.responseText =='false') {
        var ss = this.url.indexOf("section_id=");
        if (ss>-1) { off = 11; } else { ss = this.url.indexOf("sectionid="); off = 10; };
		sd = "NO section";
		if (ss>-1) {
			var se = this.url.indexOf("&",ss);
			if (se==-1) { se=this.url.length; }
			sl = this.url.substring(ss+off,se);
			sd = roles_config[get_roles_section(sl)].sectionname;
		}
        
      alert("We've hit an issue reading data - check your access in OSM for section "+sd+" "+get_data_array[c].field );
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
  }
  if (data.hasOwnProperty('error')&(data.error != null)) {
        var ss = this.url.indexOf("section_id=");
        if (ss>-1) { off = 11; } else { ss = this.url.indexOf("sectionid="); off = 10; };
		sd = "NO section";
		if (ss>-1) {
			var se = this.url.indexOf("&",ss);
			if (se==-1) { se=this.url.length; }
			sl = this.url.substring(ss+off,se);
			sd = roles_config[get_roles_section(sl)].sectionname;
		}
        
      alert("We've hit an issue reading data - check your access in OSM for section "+sd+" "+get_data_array[c].field );
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
  } 
  var index = "";
  var remaining = req.getResponseHeader('X-RateLimit-Remaining');
    $("#rr").text(req.getResponseHeader("x-ratelimit-remaining"));$("#rt").text(req.getResponseHeader("x-ratelimit-reset"));
   var d = new Date();
  var n = d.getTime();
  n = n + req.getResponseHeader("x-ratelimit-reset")*1000;
  $("#rt_abs").text(n);
       if (1==1) {
       if (get_data_array[c].field.indexOf("|")>1) {
          index = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          get_data_array[c].field = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
       }

       if (index=="") { get_data_array[c].data[get_data_array[c].field] = data; }
                    else 
                     try {
                      { get_data_array[c].data[get_data_array[c].field][index] = data; }
                     }
                     catch (error) {
                         var ss = this.url.indexOf("section_id=");
                         if (ss>-1) { off = 11; } else { ss = this.url.indexOf("sectionid="); off = 10; };
                    		sd = "NO section";
		                    if (ss>-1) {
			                    var se = this.url.indexOf("&",ss);
			                    if (se==-1) { se=this.url.length; }
			                    sl = this.url.substring(ss+off,se);
			                    sd = roles_config[get_roles_section(sl)].groupname+" "+roles_config[get_roles_section(sl)].sectionname;
		                    }
                            alert("We've hit an issue processing the data for section "+sd+" "+get_data_array[c].field+" an error has been logged with support"  );
                            throw new Error("We has an issue processing data with this URL "+this.url+ " "+sd+" "+get_data_array[c].field);
                     }
      if ((get_data_array.length -1)  != c ) {
            if (get_data_array[c+1].type == "GET") { get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
        } else { f();}
           $( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           if (c>=0&&c<get_data_array.length) {
           $( ".progress-label" ).text(get_data_array[c].field);
           get_data_array2.push(get_data_array[c]);
           }
           if (get_data_array.length == get_data_array2.length ) {f();} 
        } else { get_data_xhr(c,f); }

      } // Success 
    });  // AJAX
    
    }  // do_http = true
 /**
 $.post(url,$.param(obj),function(data,status){
       var index = "";
       if (data.search("CAPTCHA")==-1) {
       if (get_data_array[c].field.indexOf("|")>1) {
          index = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          get_data_array[c].field = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
       }

       if (index=="") { get_data_array[c].data[get_data_array[c].field] = data; }
                    else 
                      { get_data_array[c].data[get_data_array[c].field][index] = data; }
      
      if ((get_data_array.length -1)  != c ) {
       if (get_data_array[c+1].type == "GET") {
              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
              } else { 
              f();
              }
           $( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           $( ".progress-label" ).text(get_data_array[c].field);
           get_data_array2.push(get_data_array[c]);
           if (get_data_array.length == get_data_array2.length ) {f();} 
        } else { get_data_xhr(c,f); }
     
                 
     });
**/

}




    


function get_data_post_xhr2(c,f) {

//if ((get_data_array.length -1)  != c ) {
//       if (get_data_array[c+1].type == "GET") {
//              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
//    } else { 
//       f();
//             };


   //   $( "#progressbar" ).progressbar({ value: 100 * ( (c + 1) / get_data_array.length ) });
   //   $( ".progress-label" ).text(get_data_array[c].field);
     var  do_http = true;
     if (typeof get_data_array[c].olddata!= "undefined") {
        var tfield = get_data_array[c].field;
        var tindex = "";
        if (tfield.indexOf("|")>1) {
          tindex = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          tfield = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
        }  
        if ((typeof get_data_array[c].olddata[tfield] != "undefined")) {
         if (tindex=="") { 
            get_data_array[c].data[tfield] = get_data_array[c].olddata[tfield]; 
            do_http = false;
         }
        
        if (tindex!="") { 
          if ((typeof get_data_array[c].olddata[tfield][tindex] != "undefined")) {
            get_data_array[c].data[tfield][tindex] = get_data_array[c].olddata[tfield][tindex]; 
            do_http = false;
          }
        }
        if (do_http == false) {
 
        if ((get_data_array.length -1)  != c ) {
$( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           $( ".progress-label" ).text(get_data_array[c].field);
           get_data_array2.push(get_data_array[c]);
 
           if (get_data_array[c+1].type == "GET") { get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
         } else { 
          f();
         }
           $( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           $( ".progress-label" ).text(get_data_array[c].field);
           get_data_array2.push(get_data_array[c]);
     //      if (get_data_array.length == get_data_array2.length ) {f();}

 
       }
      }    
     }
    
    if (do_http===true) {
    var url = get_data_array[c].url;
    var osmpath = url.substring(37,url.indexOf("?"));
    url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
 
    if (security !== null ) {
      get_data_array[c].postvar=get_data_array[c].postvar+"&secret="+security.secret;
      get_data_array[c].postvar=get_data_array[c].postvar+"&userid="+security.userid;
    }
 

    //var obj = $.extend({}, get_data_array[c].postvar);
    $.post(url,get_data_array[c].postvar,function(data,status){
        
       var index = "";
       if (get_data_array[c].field.indexOf("|")>1) {
          index = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          get_data_array[c].field = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
       }

       if (index=="") { get_data_array[c].data[get_data_array[c].field] = data; }
                    else 
                      { get_data_array[c].data[get_data_array[c].field][index] = data; }
      
     if ((get_data_array.length -1)  != c ) {
       if (get_data_array[c+1].type == "GET") {
             get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
             } else { 
             f();
             }
 $( "#progressbar" ).progressbar({ value: 100 * ( get_data_array2.length / get_data_array.length ) });
           $( ".progress-label" ).text(get_data_array[c].field);
       get_data_array2.push(get_data_array[c]);
           if (get_data_array.length == get_data_array2.length ) {f();}

                 
      });


    }
}

function get_data_post_xhr(c,f) {
      $( "#progressbar" ).progressbar({ value: 100 * ( (c + 1) / get_data_array.length ) });
      $( ".progress-label" ).text(get_data_array[c].field);
     var  do_http = true;
     if (typeof get_data_array[c].olddata!= "undefined") {
        var tfield = get_data_array[c].field;
         var tindex = "";
        if (tfield.indexOf("|")>1) {
          tindex = get_data_array[c].field.substring(get_data_array[c].field.lastIndexOf("|")+1);
          tfield = get_data_array[c].field.substring(0,get_data_array[c].field.lastIndexOf("|"));
        }  
        if ((typeof get_data_array[c].olddata[get_data_array[c].field] != "undefined")) { 
        get_data_array[c].data[get_data_array[c].field] = get_data_array[c].olddata[get_data_array[c].field]; 
        do_http = false;
        if ((get_data_array.length -1)  != c ) {
       if (get_data_array[c+1].type == "GET") {
              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
      } else { 
      f();
      }
    }
    }
    
    if (do_http===true) {
        var url = get_data_array[c].url;
    var osmpath = url.substring(37,url.indexOf("?"));
    url = relay_path +"?osmpath="+osmpath+"&"+url.substring(url.indexOf("?")+1,1000);
//var obj = $.extend({}, p);
check_xhr();
$.ajax({
			url: url,
			type: 'POST',
                        crossDomain: true,
            headers: {"Authorization" : 'Bearer '+oauthcode.data.access,  "Content-Type": "application/x-www-form-urlencoded"},
   
			data:get_data_array[c].postvar,
			 error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.'); },
			success: function(data,status,req){
			    	if (req.getResponseHeader("x-blocked")!=null){
			alert("");
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd+" "+get_data_array[c].field);
			}
			if (req.getResponseHeader("retry-after")!=null){
			alert("To many requests retry after seconds "+req.getResponseHeader("retry-after"));
          throw new Error("Too Many Requests "+this.url+ " (retry-after) "+req.getResponseHeader("retry-after")+" "+get_data_array[c].field);
			}	
			     if (JSON.parse(data).hasOwnProperty('error')&(JSON.parse(data).error != null)) {
			         var ss = this.data.indexOf("section_id=");
			         sd = "NO section";
			         if (ss>-1) {
			             var se = this.data.indexOf("&",ss);
			             if (se==-1) { se=this.data.length; }
			             sl = this.data.substring(ss+11,se);
			             sd = roles_config[get_roles_section(sl)].sectionname;
			         }
      alert("We've hit an issue reading data - check your access in OSM for section "+sd+" for "+get_data_array[c].field);
          throw new Error("We has an issue getting data with this URL "+this.url+ " (false) "+sd);
  }    
			      $("#rr").text(req.getResponseHeader("x-ratelimit-remaining"));$("#rt").text(req.getResponseHeader("x-ratelimit-reset"));
   var d = new Date();
  var n = d.getTime();
  n = n + req.getResponseHeader("x-ratelimit-reset")*1000;
  $("#rt_abs").text(n);
			     get_data_array[c].data[get_data_array[c].field] = data; //response.responseText;
      if ((get_data_array.length -1)  != c ) {
          if (get_data_array[c+1].type == "GET") {
              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
      } else { 
      f();
      }
			},
                        error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.'); }
		});
        
 /**       
        
    GM_xmlhttpRequest({
  method: "POST",
  data: get_data_array[c].postvar,
        headers: {
    "Content-Type": "application/x-www-form-urlencoded",
    "Authorization" : 'Bearer '+oauthcode.data.access
  },
  url: get_data_array[c].url,
  onload: function(response) {
    //alert(response.responseText);
    //  switch(get_data_array[c].field) {
    //      case 'members': get_data_array[c].data.members = response.responseText; break;
    //      case 'config': get_data_array[c].data.memberconfig = response.responseText; break;    
    //  }
    get_data_array[c].data[get_data_array[c].field] = response.responseText;
      if ((get_data_array.length -1)  != c ) {
          if (get_data_array[c+1].type == "GET") {
              get_data_xhr(c+1,f); } else {get_data_post_xhr(c+1,f); };
      } else { 
      f();
      }
  }
}); **/
    }
}



var columnsizes = new Object();
var dataView;
var exclusions;
var groups;
var sortcols;
var slick_full_config = new Object();
var map_full_config = new Object();



function collect_mapfilters() 
{
     
     exclusions = {};
            $("#reportoutput").find('input.pvtFilter').not(':checked').each(function() {
              var filter;
              filter = $(this).data("filter");
              if (exclusions[filter[0]] != null) {
                return exclusions[filter[0]].push(filter[1]);
              } else {
                return exclusions[filter[0]] = [filter[1]];
              }
            });
    // oldgroups = dataView.getGrouping();
     return exclusions;
} // collectmap




function collect_slickfilters() 
{
     sortcols= [];
     $("#reportoutput").find('li.sortAttr').each(function() {
         var filter
        filter = $(this);
        var sortobj = new Object();
         sortobj.name = filter.text();
         sortobj.ascend = filter.find("span").hasClass("ui-icon-arrowthick-1-n");
       // alert(filter.find("span").hasClass("ui-icon-arrowthick-1-n")+" "+filter.text());
         sortcols.push(sortobj);
     });
      
     exclusions = {};
            $("#reportoutput").find('input.pvtFilter').not(':checked').each(function() {
              var filter;
              filter = $(this).data("filter");
              if (exclusions[filter[0]] != null) {
                return exclusions[filter[0]].push(filter[1]);
              } else {
                return exclusions[filter[0]] = [filter[1]];
              }
            });
    // oldgroups = dataView.getGrouping();
     groups = [];
     // Groups are generted
       $("#reportoutput").find('li.sortAttr').each(function() {
       var filter
       filter = $(this).text();
       $("#reportoutput").find('input.slkgrp:checked').each(function() {
       if ( $(this).data("group")==filter ) {
        var groupobj = new Object();
        groupobj.getter = filter;
        //groupobj.aggregators = new Slick.Data.Aggregators.Sum("Attending");
        groupobj.formatter = function (g) {  
if ($("#disp_totals_ck").prop("checked")) { 
return filter+":  " + g.value + "  <span style='color:green'>(" + g.count + " items)</span>"; } else
{
return filter+":  " + g.value;
} 
};
        groupobj.displayTotalsRow = true;
  //      for (var gl in oldgroups) {
  //        if (oldgroups[gl].getter =  groupobj.getter ) { groupobj.collapsed = oldgroups[gl].collapsed; }
  //      }
        groups.push(groupobj);  
       }
       });
       });
} // collect


function filterslick(item)
{
    var ret;
    ret = true;
    for(var key in item) {
    var value = item[key];
   //** ewjewkj 
   for (var key2 in exclusions) {
    if (key2 == key) {
       var value2 = exclusions[key];
       for (var l in value2) {
           if (value2[l]==value) {
              ret = false;
           }
        }
     }
    }
    }
    return ret;
}
    
    //var test
    //test = Math.round(Math.random() * 10);
   //// if (test<5) {
   // return true;
  //  } else { return false };
    var report_data = new Array();      
function sort_dataview() {
    report_data.sort(function (dataRow1, dataRow2) {
        for (var i = 0, l = sortcols.length; i < l; i++) {
          var field = sortcols[i].name;
          var sign = sortcols[i].ascend ? 1 : -1;
          var value1 = dataRow1[field], value2 = dataRow2[field];
          var result = (value1 == value2 ? 0 : (value1 > value2 ? 1 : -1)) * sign;
          if (result != 0) {
            return result;
          }
        }
        return 0;
      });
}

function slick_click (checklist) {
    grid.onClick.subscribe(function (e, args) {
    var item = dataView.getItem(args.row);
    if(item.hasOwnProperty('groupingKey')) {
    if(item.collapsed == 1) {
    dataView.expandGroup(item.groupingKey);
    } else
    {
    dataView.collapseGroup(item.groupingKey);
    }
    grid.invalidateAllRows();
    grid.render();
    grid.resizeCanvas();
    }
    });
    grid.onColumnsResized.subscribe(function() {
       var sze = grid.getColumns();
       for (var i in sze) 
       { columnsizes[sze[i].field] = sze[i].width; };
       slickupdate(dataView,grid,checklist,false,false) ;
    } );
}
function slickupdate(dataView,grid,checklist,event,grp) {
    collect_slickfilters();
   sort_dataview();
    dataView.refresh();
    if (grp) {
    dataView.setGrouping(groups);
    }
    if ($(".slickot option:selected").text()=="Grid") {
    grid.invalidateAllRows();
    grid.render();
    if (event) {
        slick_click (checklist);
    } 
    grid.resizeCanvas();
    } else  { slick_pdf() };
            
     slick_full_config.report_type =     $( "#report_type option:selected" ).text();
     slick_full_config.output_type =     $( ".slickot option:selected" ).val();
     slick_full_config.fields = checklist;
     slick_full_config.exclusions = exclusions;
    var gridconfig = new Object();
    var lis2 = document.getElementById("selfields")
    var lis = document.getElementById("selfields").getElementsByTagName("li");
    gridconfig.rows = new Array;
    for (var i = 0; i < lis.length; i++) { 
      gridconfig.rows.push(lis[i].id);
    }
    gridconfig.groups = new Array;
    for (var i = 0; i < groups.length; i++) { 
      gridconfig.groups.push(groups[i].getter);
    }
    gridconfig.sort = new Array;
    gridconfig.sort = sortcols.slice(0);
    gridconfig.sizes = new Object;
    for (var i in gridconfig.rows) {
        gridconfig.sizes[gridconfig.rows[i]] = columnsizes[gridconfig.rows[i]];
    }
    slick_full_config.grid = gridconfig;
     $("#config_json").val(JSON.stringify(slick_full_config, undefined, 2));
}

function get_postcodes_bulk(section,checklist,checklist2) {
    var fld = -1;
    var limit = 99;
    for(var f=0; f<checklist2.length;f++) {
        if (checklist2[f].indexOf("Postcode")!=-1) {
        fld = f;
        }
    };
    pl = [];
    if (fld>-1) {
        var fn = checklist[fld].substring(checklist[fld].lastIndexOf("|")+1);
        var gp = checklist[fld].substring(checklist[fld].indexOf("|")+1,checklist[fld].lastIndexOf("|"));
        var members_array = JSON.parse(report_config[section].members);
        for( var member in members_array.data) {  
          pc = members_array.data[member].custom_data[gp][fn];
          if (postcode_list.find(a=>(a.query==pc))==undefined) {
          pl.push(pc);
          }
        }
    //    var a = [ {'postcode':'KT15 1LG'}, {'postcode':'KT15 3AS'}];
    pl.sort();
    pl = pl.filter((e, i, a) => e !== a[i - 1]);
    copy_pl = Array.from(pl);
    while (copy_pl.length>0) {
    pls = copy_pl.splice(0,limit);    
        l = pls.map((p)=> {return ("postcodes%5B%5D="+encodeURIComponent(p))});
   if (pls.length>0) {    
   $.ajax({
    type: "POST",
    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
    url:'https://api.postcodes.io/postcodes',
    data: l.join("&"),
    success: function(html) {
      arrReturn = html;
    },
    async:false
  });
    }
//    postcode_list
postcode_list = postcode_list.concat(arrReturn.result);
}
        
    }

}

function select_checks() {
    dialog2.dialog( "close" );
  //   dialog3.dialog( "open" );
    // this returns a list of values that are checked
dialog_delay.dialog( "open" );
     var searchIDs = $('#fieldtable input:checked').map(function(){
        
      return $(this).val();
        
    });
    var searchIDs2 = $('#fieldtable input:checked').map(function(){
        
      return $(this).attr("name");
        
    });
    var month_list = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var badge_types = [ "Challenge", "Activity","Staged", "Core"];
    postcode_list=[];
    imd_list=[];
    var checklist = searchIDs.get();
    var checklist2 = searchIDs2.get();
    var report_type = $( "#report_type option:selected" ).text();
    report_data = [];
   // ga('send', 'event', 'Report', 'OSMR', report_type);
    // Members and Members & Badges
    if ((report_type=="Programme & Attendance")|(report_type=="Members")|(report_type=="Members & Badges")|(report_type=="Members & Challenge Badges")|(report_type == "Members & Staged Badges")|(report_type=="Members & Badges Details")|(report_type=="Members & Sections")|(report_type=="Members & WL")|(report_type=="Members & Maps")) {
    for(var section in report_config) {
        var members_array = JSON.parse(report_config[section].members);
        if (report_type=='Members & Maps')   {
               
                get_postcodes_bulk(section,checklist,checklist2);
                lsoa=[];
                for (pc=0;pc<postcode_list.length;pc++){
                    if (postcode_list[pc].result!=null){
                       lsoa.push(postcode_list[pc].result.codes.lsoa);
                    }
                }
                lsoa = [...new Set(lsoa.map(item => item))];
                if (checklist.find(a=>a=="MQ|IMD")!=undefined) {
                
                for (pc=0;pc<lsoa.length;pc++){
                    arrReturn="";
                    $.ajax({
                         type: "GET",
                        
                         url:'https://services3.arcgis.com/ivmBBrHfQfDnDf8Q/arcgis/rest/services/Indices_of_Multiple_Deprivation_(IMD)_2019/FeatureServer/0/query?where=lsoa11cd%20%3D%20%27'+lsoa[pc]+'%27&outFields=*&returnGeometry=false&returnDistinctValues=true&outSR=4326&f=json',
                         success: function(html) {
                            arrReturn = html;
                            },
                        async:false
                    });
                    if (arrReturn.hasOwnProperty('features')&(arrReturn.features.length!=0)) {
                        v = new Object;
                        v.lsoa = lsoa[pc];
                        v.imd = arrReturn.features[0].attributes['IMD_Decile'];
                        imd_list.push(v);
                    } else
                    {
                         arrReturn="";
                    $.ajax({
                         type: "GET",
                     // https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Index_of_Multiple_Deprivation_December_2016_Lookup_in_Scotland/FeatureServer/0/query?where=dz11cd%20%3D%20'".$lsoa11cd."'&outFields=*&outSR=4326&f=json
                         url:"https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Index_of_Multiple_Deprivation_December_2016_Lookup_in_Scotland/FeatureServer/0/query?where=dz11cd%20%3D%20'"+lsoa[pc]+"'&outFields=*&outSR=4326&f=json",
                         success: function(html) {
                            arrReturn = html;
                            },
                        async:false
                    });
                      if (arrReturn.hasOwnProperty('features')&(arrReturn.features.length!=0)) {
                        v = new Object;
                        v.lsoa = lsoa[pc];
                        v.imd = parseInt(100*(arrReturn.features[0].attributes['imd16']/6976));
                        imd_list.push(v);
                    } else {
                        arrReturn="";
                    $.ajax({
                         type: "GET",
                     // https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Index_of_Multiple_Deprivation_December_2019_Lookup_in_Wales/FeatureServer/0/query?f=json&where=(lsoa11cd%20%3D%20%27'.$lsoa11cd.'%27)%20AND%20(1%3D1)&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=FID%20ASC&resultOffset=0&resultRecordCount=50&cacheHint=true&quantizationParameters=%7B%22mode%22%3A%22edit%22%7D
                         url:"https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/Index_of_Multiple_Deprivation_December_2019_Lookup_in_Wales/FeatureServer/0/query?f=json&where=(lsoa11cd%20%3D%20%27"+lsoa[pc]+"%27)%20AND%20(1%3D1)&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=FID%20ASC&resultOffset=0&resultRecordCount=50&cacheHint=true&quantizationParameters=%7B%22mode%22%3A%22edit%22%7D",
                         success: function(html) {
                            arrReturn = html;
                            },
                        async:false
                    });
                        if (arrReturn.hasOwnProperty('features')&(arrReturn.features.length!=0)) {
                        v = new Object;
                        v.lsoa = lsoa[pc];
                        v.imd = parseInt(100*(arrReturn.features[0].attributes['wimd_2019']/1909));
                        imd_list.push(v);
                        }
                           }
                    }
                }
                }
            }
        for( var member in members_array.data) {  
           var report_line = new Object();
          for (var field in checklist ) {
              if ( checklist[field].substring(0,7)=="MC|Core" ){
                 var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                 report_line[checklist2[field]] = members_array.data[member][fn];
                 if (fn=="full_name") { report_line[checklist2[field]] = members_array.data[member].first_name+" "+members_array.data[member].last_name; };
                  if (fn=="patrol_role_short") { report_line[checklist2[field]] = globals.patrol_roles[roles_config[get_roles_section(section)].section][members_array.data[member].patrol_role_level].abbr; }
                  if (fn=="group_name") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].groupname; };
                  if (fn=="section_name") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; };
                     if (fn=="full_age") { report_line[checklist2[field]] = getAge(members_array.data[member].date_of_birth,"","a"); };
                     if (fn=="agejoined") { if (members_array.data[member].joined!="0000-00-00") {report_line[checklist2[field]] = getAge(members_array.data[member].date_of_birth,members_array.data[member].joined,"s");} else {report_line[checklist2[field]] =""; }};
                     if (fn=="age_years") { report_line[checklist2[field]] = getAge(members_array.data[member].date_of_birth,"","y"); };
                     if (fn=="birth_month") { report_line[checklist2[field]] = month_list[(new Date(members_array.data[member].date_of_birth).getMonth())]; };
                  if (fn=="timemovement") { report_line[checklist2[field]] = getAge(members_array.data[member].started,"","s"); };
                   if (fn=="timesection") { report_line[checklist2[field]] = getAge(members_array.data[member].joined,"","s"); };
                 if (fn=="mbremailchk") {
                     
                     	report_line[checklist2[field]] = "";
	for (var me = 12; me < 15; me++) {
		if (me == 12) {
			var mes = "Member Email 1";
		} else {
			var mes = "Member Email 2";
		}
		if (members_array.data[member]['custom_data'][6].hasOwnProperty(me)&&members_array.data[member]['custom_data'][6][me]!="") {
			var mcs = "Primary Contact ";
			for (var mc = 1; mc < 3; mc++) {
				mcs = "Primary Contact " + mc;
				if ((members_array.data[member]['custom_data'][mc].hasOwnProperty("12"))) {
					if (members_array.data[member]['custom_data'][6][me] == (members_array.data[member]['custom_data'][mc][12])) {
					     if (report_line[checklist2[field]]!="") {report_line[checklist2[field]]+=",";}
						report_line[checklist2[field]] += mcs + " Email 1 matches " + mes;
					}
				}
				if ((members_array.data[member]['custom_data'][mc].hasOwnProperty("13"))) {
					if (members_array.data[member]['custom_data'][6][me] == (members_array.data[member]['custom_data'][mc][13])) {
					     if (report_line[checklist2[field]]!="") {report_line[checklist2[field]]+=",";}
						report_line[checklist2[field]] += mcs + " Email 2 matches " + mes;
					}
				}
			}
		}
	}
                 }
   if (fn=="pcemailchk") {
   	report_line[checklist2[field]] = "";
   for (var me = 12; me < 15; me++) {
      if (me == 12) {
			var mes = "Primary Contact 1 Email 1";
		} else {
			var mes = "Primary Contact 1 Email 2";
		}
      for (var mc = 12; me < 15; me++) {
           if (mc == 12) {
			var mcs = "Primary Contact 2 Email 1";
		} else {
			var mcs = "Primary Contact 2 Email 2";
		}
	    if ((members_array.data[member]['custom_data'][1].hasOwnProperty(me))) {
	        if ((members_array.data[member]['custom_data'][2].hasOwnProperty(mc))) {
	           if  (members_array.data[member]['custom_data'][1][me]==members_array.data[member]['custom_data'][2][mc]) {
	               if (members_array.data[member]['custom_data'][1][me]!="") {
	                     if (report_line[checklist2[field]]!="") {report_line[checklist2[field]]+=",";}
	                     report_line[checklist2[field]] += mcs + " matches " + mes;
	               }
	           }
	        } 
	    }     
      }
   }
    
   }   
    if (fn=="emgemailchk") {
    	report_line[checklist2[field]] = "";          
    for (me = 12; me < 15; me++) {
        if (me == 12) {
			var mes = " Emergency Email 1";
		} else {
			var mes = " Emergency Email 2";
		}
        if 	(members_array.data[member]['custom_data'].hasOwnProperty('3')) {
            if (members_array.data[member]['custom_data'][3].hasOwnProperty(me)&members_array.data[member]['custom_data'][3][me]!="") {
                	for (mc = 1; mc < 3; mc++) {
				        mcs = " Primary Contact " + mc;
				         
				        if ((members_array.data[member]['custom_data'][mc].hasOwnProperty("12"))) {
				            
					        if (members_array.data[member]['custom_data'][3][me] == (members_array.data[member]['custom_data'][mc][12])) {
					           if (report_line[checklist2[field]]!="") {report_line[checklist2[field]]+=",";}
						       report_line[checklist2[field]] += mcs + " Email 1" +" matches " + mes;
					        }
				        }
				        if ((members_array.data[member]['custom_data'][mc].hasOwnProperty("13"))) {
				            
					       if (members_array.data[member]['custom_data'][3][me] == (members_array.data[member]['custom_data'][mc][13])) {
					            if (report_line[checklist2[field]]!="") {report_line[checklist2[field]]+=",";}
						        report_line[checklist2[field]] += mcs + " Email 2 matches " + mes;
					        }
				        }
				        
				        
				        
				        
                	}
            }
        }
    }
       
             
             
             
             
             
             
                     
                  }  
              } // Core
              
              
              if ( checklist[field].substring(0,2)=="MA" ){
                var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
               // alert(checklist[field].indexOf("|")+1);
                var gp = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"));
                if (report_line.hasOwnProperty(checklist2[field])==true) {
                    checklist2[field] = checklist2[field]+" "+field;
                }
                
                report_line[checklist2[field]] = members_array.data[member].custom_data[gp][fn];  
              }  
              if ( checklist[field].substring(0,2)=="MF" ){
                  var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                  var gp = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"));
                  if (report_config[section].flexirecords[gp]!=null){
                  var flx =report_config[section].flexirecords[gp]; //  JSON.parse(report_config[section].flexirecords[gp]);
                  report_line[checklist2[field]] = ""
                  for (var flxm in flx.items) {
                      if (flx.items[flxm].scoutid==member) {
                          report_line[checklist2[field]] = flx.items[flxm][fn];  
                      }   
                  } 
                  } else { report_line[checklist2[field]] = "" };
              }
          } // Fields (Members)
            if (report_type=="Members") {
              report_data.push(report_line);
            };
            if (report_type=='Members & Sections') {
              
                var sl = report_config[section].member_sections[member];
                
                report_line2 =  Object.assign({}, report_line);
                if (sl.data.others==undefined){
                    report_line2['Other Sections'] = "";
                     
                    report_data.push(report_line2);
                } else { 
                    for(var i=0; i<sl.data.others.length;i++) {
                         var report_line3 = new Object;
                         report_line3 =  Object.assign({}, report_line2);
                        report_line3['Other Sections'] = sl.data.others[i];
                        report_data.push(report_line3);
                    }
                }
            }
            if (report_type=='Members & WL') {
                  if (report_config[section].hasOwnProperty('member_changes|'+member)) {
                  var sl = JSON.parse(report_config[section]['member_changes|'+member]); } else {sl={};}
                 
                       for (var field in checklist ) {
                            var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                            if ( checklist[field].substring(0,2)=="WL" ){
                                if ((fn=='Added')|(fn=='Ageadded')|(fn=='TimeonWL')|(fn=='Ageaddeds')|(fn=='TimeonWLF')|(fn=='TimeonWLD')) {
                                     fdate="";
                                     if (sl.hasOwnProperty('status')) {
                                         for(var i=0;i<sl.data.length;i++){
                                             if ((sl.data[i].type=="members")&(sl.data[i].code=="add")&(fdate=="")) {
                                                 fdate = sl.data[i].date_raw;
                                             }
                                         }
                                     }
                                     if (fn=='Added') {
                                     report_line[checklist2[field]]=fdate.substring(0,10);
                                     }
                                     if (fn=='Ageadded') {
                                     report_line[checklist2[field]]=getAge(members_array.data[member].date_of_birth,fdate.substring(0,10),"a");
                                     }
                                     if (fn=='Ageaddeds') {
                                     report_line[checklist2[field]]=getAge(members_array.data[member].date_of_birth,fdate.substring(0,10),"s");
                                     }
                                     if ((fn=="TimeonWL")|(fn=='TimeonWLF')|(fn=='TimeonWLD')) {
                                         stdate = fdate;
                                     }
                                }
                                 if ((fn=='Moved')|(fn=='TimeonWL')|(fn=='Ageonmove')|(fn=='Ageonmoves')|(fn=='TimeonWLF')|(fn=='TimeonWLD')) {
                                     fdate="";
                                     if (sl.hasOwnProperty('status')) {
                                         for(var i=0;i<sl.data.length;i++){
                                             if ((sl.data[i].type=="members")&(sl.data[i].code=="moved-from-waiting")) {
                                                 fdate = sl.data[i].date_raw;
                                             }
                                         }
                                     }
                                     if (fn=='Moved') {
                                     report_line[checklist2[field]]=fdate.substring(0,10);
                                     }
                                     if (fn=='Ageonmove') {
                                     report_line[checklist2[field]]= getAge(members_array.data[member].date_of_birth,fdate.substring(0,10),"a");
                                     }
                                     if (fn=='Ageonmoves') {
                                     report_line[checklist2[field]]= getAge(members_array.data[member].date_of_birth,fdate.substring(0,10),"s");
                                     }
                                     if (fn=='TimeonWL') {
                                     report_line[checklist2[field]]=getAge(stdate.substring(0,10),fdate.substring(0,10),"s");
                                     }
                                      if (fn=='TimeonWLF') {
                                     report_line[checklist2[field]]=getAge(stdate.substring(0,10),fdate.substring(0,10),"b");
                                     }
                                      if (fn=='TimeonWLD') {
                                     report_line[checklist2[field]]=getAge(stdate.substring(0,10),fdate.substring(0,10),"c");
                                     }
                                }
                            }    
                       }    
                       report_data.push(report_line);
                  }
            if (report_type=='Members & Maps')   {
                 for (var field in checklist ) {
                      var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                      if (fn=='IMD') {
                          report_line.imd = "";
                          for (i in report_line) {
                             if (i.indexOf('Postcode')>-1) {
                               pc = report_line[i];
                               ll = postcode_list.find(a=>(a.query==pc));
                                if (ll!=undefined&&ll.result!=null) {
                                    lsoa = ll.result.codes.lsoa
                                    imd = imd_list.find(a=>a.lsoa==lsoa);
                                    report_line.IMD = imd.imd;
                                }    
                             }
                             
                          }
                      }
                 }    
                report_data.push(report_line);
            }
            if (report_type=='Programme & Attendance') {
                for (var field in checklist ) {
                    if ( checklist[field].substring(0,13)=="AT|Attendance" ){
                      var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                      if (fn=="termid") {
                            report_line[checklist2[field]] =  report_config[section].termid;
                      }
                      if (fn=="termname") {
                            terms=terms_config[section];
                            report_line[checklist2[field]] = "";
                            for (var i=0;i<terms.length;i++){
                                if (terms[i].termid==report_config[section].termid) {
                                    report_line[checklist2[field]] =  terms[i].name;
                                }
                            }
                            
                      }
                    }
                }
            }
            if (report_type=='Programme & Attendance') {
                var progslist = report_config[section].programme.items;
               if (Array.isArray(progslist)) { 
                for (var i=0; i<progslist.length; i++){
                    report_line2 =  Object.assign({}, report_line);
                    for (var field in checklist ) {
                        var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                      if ( checklist[field].substring(0,12)=="PL|Programme" ){
                          
                          report_line2[checklist2[field]] = progslist[i][fn];
                           if (fn=="group") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                           if (fn=="section") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                      }
                      if ( checklist[field].substring(0,13)=="AT|Attendance" ){
                         var m = report_config[section].attendance.items.find(e=> e.scoutid==member );
                        
                         if (m!=undefined) {
                             if (m[progslist[i]["meetingdate"]]!=undefined) {
                                 if (fn=="attendance") {
                                 report_line2['Attended?']=m[progslist[i]["meetingdate"]]
                                 } else {
                                    if(m[progslist[i]["meetingdate"]]=="Yes") { report_line2['Attended'] = '&#9989;'; }
                                    if(m[progslist[i]["meetingdate"]]=="No") { report_line2['Attended'] = '&#10060;'; }
                                    if(m[progslist[i]["meetingdate"]]=="") { report_line2['Attended'] = ''; }
                                 }
                             } else {
                                  if (fn=="attendance") { 
                                report_line2['Attended?']=""; } else {report_line2['Attended']="";}
                             }
                         } else {
                             if (fn=="attendance") { 
                             report_line2['Attended?']=""; } else  {report_line2['Attended']="";}
                                 
                             }
                      }
                    }
                    
                    report_data.push(report_line2);
                }
            }
            }
            if ((report_type=="Members & Badges")|(report_type=="Members & Challenge Badges")|(report_type=="Members & Badges Details")|(report_type == "Members & Staged Badges")) {
            // Loop at Badges and look for member/badge intersects 
               
                var bm_def =  (report_config[section].memberbadges);
                for (var badge_type in report_config[section].badges) {
                    var badge_def = (report_config[section].badges[badge_type]);
                    for (var badges in badge_def.details) {
                        var bm_match = false;
                       // var report_line2 = new Object();
                        report_line2 =  Object.assign({}, report_line);
                       // for (var key in report_line) {
                        //copy all the fields
                       //   report_line2[key] = report_line[key];
                       // }

                        for (var field in checklist ) {
                           if ( checklist[field].substring(0,8)=="BG|Badge" ){
                            var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                            report_line2[checklist2[field]] = badge_def.details[badges][fn];   
                               if (fn=="badge_type") { report_line2[checklist2[field]] = badge_types[badge_type-1]; }
                               if (fn=="badge_section") { report_line2[checklist2[field]] = section_config[section].section_type; }
                           }
                           
                           if ( checklist[field].substring(0,8)=="BM|Badge" ){
                               report_line2[checklist2[field]] = "";
                               var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                               for (var bm in bm_def.data) {
                                   if (bm_def.data[bm].scout_id == member) {
                              
var bmb = bm_def.data[bm].badges.findIndex(function find(a){return a.badge_shortname==badges;});
  if (bmb!=-1){ bm_match = true; 
    report_line2[checklist2[field]] = bm_def.data[bm].badges[bmb][fn];
    if (fn=="statussym") {
        var sym="";
        fn2 = "status";
        if (bm_def.data[bm].badges[bmb][fn2]==0 ) {  sym = "" } 
        if ((bm_def.data[bm].badges[bmb][fn2]>0) & (bm_def.data[bm].badges[bmb][fn2]<=0.25)) {  sym = "&#9719;" } 
        if ((bm_def.data[bm].badges[bmb][fn2]>0.25 ) & (bm_def.data[bm].badges[bmb][fn2]<=0.5)) {  sym = "&#9684;" } 
         if ((bm_def.data[bm].badges[bmb][fn2]>0.5) & (bm_def.data[bm].badges[bmb][fn2]<=0.75)) {  sym = "&#9681;" } 
         if ((bm_def.data[bm].badges[bmb][fn2]>0.75) & (bm_def.data[bm].badges[bmb][fn2]<1)) {  sym = "&#9685;" } 
          if (bm_def.data[bm].badges[bmb][fn2]==1) {  sym = "&#11044;" } 
          report_line2[checklist2[field]] = sym;
    }
    if (fn=="awarded_date") {
      if (bm_def.data[bm].badges[bmb][fn]==-1) 
        {report_line2[checklist2[field]] = ""; } else 
        {report_line2[checklist2[field]] = new Date(1000*bm_def.data[bm].badges[bmb][fn]).toISOString().split('T')[0];};

    }
    if (fn=="yearcompleted") {
      if ((bm_def.data[bm].badges[bmb]['awarded_date']==-1)) 
        {report_line2[checklist2[field]] = ""; } else 
        {report_line2[checklist2[field]] = (new Date(1000*bm_def.data[bm].badges[bmb]['awarded_date']).toISOString().split('T')[0]).substring(0,4);};

    }
     if (fn=="datedueaward") {
      if ((bm_def.data[bm].badges[bmb]['awarded_date']==-1)) 
      {report_line2[checklist2[field]] = ""; } else 
        {report_line2[checklist2[field]] = new Date(1000*bm_def.data[bm].badges[bmb]['awarded_date']).toISOString().split('T')[0];};
      if ((bm_def.data[bm].badges[bmb]['completed']>bm_def.data[bm].badges[bmb]['awarded']))  
          {report_line2[checklist2[field]] = new Date(Date.now()).toISOString().split('T')[0];}
     }
     
     if (fn=="yeardueaward") {
      if ((bm_def.data[bm].badges[bmb]['awarded_date']==-1)) 
      {report_line2[checklist2[field]] = ""; } else 
        {report_line2[checklist2[field]] = (new Date(1000*bm_def.data[bm].badges[bmb]['awarded_date']).toISOString().split('T')[0]).substring(0,4);};
      if ((bm_def.data[bm].badges[bmb]['completed']>bm_def.data[bm].badges[bmb]['awarded']))  
          {report_line2[checklist2[field]] = (new Date(Date.now()).toISOString().split('T')[0]).substring(0,4);}
     }
     
     
    
    if (fn=="due") {
      report_line2[checklist2[field]] = "";     
      if ((bm_def.data[bm].badges[bmb]['completed']>bm_def.data[bm].badges[bmb]['awarded'])) { 
        report_line2[checklist2[field]] = "Due ";          
        if (bm_def.data[bm].badges[bmb]['level']!=false) { report_line2[checklist2[field]]+=bm_def.data[bm].badges[bmb]['level']; }   
      }
    }
     if (fn=="awardeddet") {
      report_line2[checklist2[field]] = "";     
      if (bm_def.data[bm].badges[bmb]['awarded']>=1) { 
        report_line2[checklist2[field]] = "Awarded ";          
        if (bm_def.data[bm].badges[bmb]['awarded']>1) { report_line2[checklist2[field]]+="Lvl "+bm_def.data[bm].badges[bmb]['awarded']; }   
      }
    }
    if (fn=="dorc") {
      report_line2[checklist2[field]] = "";    
      if ((bm_def.data[bm].badges[bmb]['completed']==bm_def.data[bm].badges[bmb]['awarded'])&(bm_def.data[bm].badges[bmb]['completed']!=0)) {
          report_line2[checklist2[field]] = "Completed ";
          if (bm_def.data[bm].badges[bmb]['level']!=false) { report_line2[checklist2[field]]+=bm_def.data[bm].badges[bmb]['level']; } 
      } 
      if (bm_def.data[bm].badges[bmb]['completed']>bm_def.data[bm].badges[bmb]['awarded']) {
          report_line2[checklist2[field]] = "Due ";
          if (bm_def.data[bm].badges[bmb]['level']!=false) { report_line2[checklist2[field]]+=bm_def.data[bm].badges[bmb]['level']; } 
      } 

    } 
     
  };

if ((report_type=="Members & Challenge Badges")|(report_type=="Members & Badges Details")|(report_type == "Members & Staged Badges")) {
     
} 
      
//      for (var bmb in bm_def.data[bm].badges) {
//     if (bm_def.data[bm].badges[bmb].badge_identifier == badges ) {
//        bm_match = true;
//  report_line2[checklist2[field]] = bm_def.data[bm].badges[bmb][fn];
//if (fn=="awarded_date") {
//if (bm_def.data[bm].badges[bmb][fn]==-1) {report_line2[checklist2[field]] = ""; } else {report_line2[checklist2[field]] = new Date(1000*bm_def.data[bm].badges[bmb][fn]);};

// }
// }    
// }

                                   }
                               }
                           }
                        }
                         if (report_type=="Members & Badges") {
                         report_data.push(report_line2);
                         } else 
                         {
                           
                          // Badges and Details

bmr_list=[{name: "No Requirements", field: "114596", width: "150px", formatter: "cellFormatter", tooltip: "No fixed Requirement"}];
if (badge_def.structure.hasOwnProperty(badges)) {
if (badge_def.structure[badges].length == 2){
var bmr_list = badge_def.structure[badges][1].rows;}
else {bmr_list=[{name: "No Requirements", field: "114596", module: "a", width: "150px", formatter: "cellFormatter", tooltip: "No fixed Requirement"}];}
}

var lastmodule = "";
var lastmoduleindex = 0;
var reqcounter = 1;

for (var bmr_list_idx in bmr_list) {
//  var report_line3 = new Object();
                       //      for (var key in report_line2) {
                       //        //copy all the fields
                       //        report_line3[key] = report_line2[key];
                       //      }
report_line3 =  Object.assign({}, report_line2);

if (lastmodule==bmr_list[bmr_list_idx]["module"])
{ reqcounter = reqcounter + 1;} else
{ reqcounter = 1;
lastmoduleindex = lastmoduleindex + 1; 
lastmodule=bmr_list[bmr_list_idx]["module"];};
var bmd =  ( report_config[section].badgereq[badges]); // Member & Req
                             var bmr = badge_def.structure[badges]; // Req
var bmd_index = bmd.items.findIndex(function find(a){return a.scoutid==member;});
                          for (var field in checklist ) {
                            if ( checklist[field].substring(0,8)=="BD|Badge" ){
                             
                             var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                             
                             
                             report_line3[checklist2[field]] = bmr_list[bmr_list_idx][fn];
                             if (fn!="module") { report_line3[checklist2[field]] = reqcounter  + ". "+ report_line3[checklist2[field]]; } 
                             if ((fn=="module")&(JSON.parse(badge_def.details[badges].config).hasOwnProperty("shownumbers")))
                             {
                                report_line3[checklist2[field]] = "Level "+JSON.parse(badge_def.details[badges].config).levelslist[lastmoduleindex];
                             };
                                 
                              if (fn=="reqstatus") { report_line3[checklist2[field]] = ""; };
                              if ((fn=="needed")||(fn=="neededsym")) {
                                  bwiz = report_config[section].badgewiz[badges].meta.module_status;
                                  bwizcheck = bmr_list[bmr_list_idx]; // this is the requirement we're looking at
                                  //bmr_list is a list of all reqs for this badge
                                  // bmd.items[bmd_index] is our member record for this badge
                                  // So we need to count the number for this bmr_list[bmr_list_idx].module that we have done
                                  // Compare this with the total required
                                  // If hasn't been done does it need to be done?
                                  if (bmd_index!=-1) {
                                  if ((bmd.items[bmd_index][bmr_list[bmr_list_idx].field]==undefined) || (bmd.items[bmd_index][bmr_list[bmr_list_idx].field]=="") 
                                      || (bmd.items[bmd_index][bmr_list[bmr_list_idx].field].toString().substring(0,1).toLowerCase()=="x")) {
                                     
                                      if  (bwiz[bwizcheck.module]==undefined) {tn=0;} else  {tn =  bwiz[bwizcheck.module].requirements;};
                                       for (var bmr_list_idx_wiz in bmr_list) {
                                           if (bmr_list[bmr_list_idx_wiz].module==bwizcheck.module) {
                                               if (bmd.items[bmd_index][bmr_list[bmr_list_idx_wiz].field]==undefined){
                                                   tn = tn;
                                               } else { tn = tn - 1; }
                                           }
                                           
                                       }
                                       if (tn>0) { if (fn=="needed") {report_line3[checklist2[field]]="Requried"} else {report_line3[checklist2[field]]="&#10060;"} } 
                                         else {if (fn=="needed") {report_line3[checklist2[field]]="Not Requried";} else {report_line3[checklist2[field]]="&#10062;";} }
                                      } else { if (fn=="needed") {report_line3[checklist2[field]]="Completed" } else {report_line3[checklist2[field]]="&#9989;" }}
                              }
                              }
                             
                              if (fn=="countdone") {
                                  bwiz = report_config[section].badgewiz[badges].meta.module_status;
                                  bwizcheck = bmr_list[bmr_list_idx]; // this is the requirement we're looking at
                                  tn = 0;
                                   if (bmd_index!=-1) {
                                  for (var i=0; i<bmr_list.length;i++) {
                                      if (bmr_list[i].module==bmr_list[bmr_list_idx].module){
                                          if (bmd.items[bmd_index][bmr_list[i].field]!=undefined)
                                          if ((bmd.items[bmd_index][bmr_list[i].field].toString().substring(0,1)!="")&&(bmd.items[bmd_index][bmr_list[i].field].toString().substring(0,1).toLowerCase()!="x")) {
                                              tn+=1;
                                          }
                                      }
                                  }
                                   }
                                   report_line3[checklist2[field]] = tn;
                                  
                                  
                              }
                              if (fn=="countremain") {
                                  bwiz = report_config[section].badgewiz[badges].meta.module_status;
                                  bwizcheck = bmr_list[bmr_list_idx]; // this is the requirement we're looking at
                                  tn = 0;
                                   if (bmd_index!=-1) {
                                  for (var i=0; i<bmr_list.length;i++) {
                                      if (bmr_list[i].module==bmr_list[bmr_list_idx].module){
                                          if (bmd.items[bmd_index][bmr_list[i].field]!=undefined)
                                          if ((bmd.items[bmd_index][bmr_list[i].field].toString().substring(0,1)!="")&&(bmd.items[bmd_index][bmr_list[i].field].toString().substring(0,1).toLowerCase()!="x")) {
                                              tn+=1;
                                          }
                                      }
                                  }
                                   }
                                   tn2=0;
                                   if ( bwiz[bwizcheck.module]!=undefined) {
                                   tn2 =  bwiz[bwizcheck.module].requirements;
                                   }
                                   report_line3[checklist2[field]] = tn2-tn;
                                  
                                  
                              }
                              if (fn=="countneeded") {
                                  bwiz = report_config[section].badgewiz[badges].meta.module_status;
                                  bwizcheck = bmr_list[bmr_list_idx]; // this is the requirement we're looking at
                                  if  (bwiz[bwizcheck.module]==undefined) {tn=0;} else  {tn =  bwiz[bwizcheck.module].requirements;}; 
                                  tn2 = 0;
                                  for (var bmr_list_idx_wiz in bmr_list) {
                                           if (bmr_list[bmr_list_idx_wiz].module==bwizcheck.module) { tn2 = tn2 + 1; }
                                  }
                                  
                                  report_line3[checklist2[field]]= tn+" from "+tn2;
                                 
                              }
                             if (bmd_index!=-1) {
                                 
                                 
                                 if (fn=="reqstatus") {
                                 report_line3[checklist2[field]] = bmd.items[bmd_index][bmr_list[bmr_list_idx].field];
                                 }
                               }
                            
                           } // BD Field
                          } // Fields
                           if (((report_type == "Members & Staged Badges")&((badges=='94_0')||(badges=='95_0')))||(report_type != "Members & Staged Badges")) {
                            if ((report_type == "Members & Staged Badges")&(report_line3['Member Status']=="")) {
                                report_line3['Member Status'] = 0;
                            }
                             report_data.push(report_line3);
                           }
                           }
                         } // BAdges & Details

                    } // Badge
                } // Badge Types
            } // End of Badges 

        }
    }
}
    if (report_type=="Badges") {
         for(var section in report_config) {
            
             for (var badge_type in report_config[section].badges) {
                var badge_def =  (report_config[section].badges[badge_type]);
                 for (var badges in badge_def.details) {
                   var report_line2 = new Object();
                   for (var field in checklist ) {
                     if ( checklist[field].substring(0,8)=="BG|Badge" ){
                       var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                       report_line2[checklist2[field]] = badge_def.details[badges][fn];   
                       if (fn=="badge_type") { report_line2[checklist2[field]] = badge_types[badge_type-1]; }
                       if (fn=="badge_section") { report_line2[checklist2[field]] = section_config[section].section_type; }
                     }
                   }
                      
                      report_data.push(report_line2);
                      
                 }
                
             }
         }
    }
    
    if (report_type=="Online Payments") {
        for(var section in report_config) {
            schedules = report_config[section].online_payment.items;
            for (var i=0; i<schedules.length;i++) {
                schedule = schedules[i];
                payments =  report_config[section].opi[schedules[i].schemeid].payments;
                people = report_config[section].ops[schedules[i].schemeid].items;
                for (var j=0;j<people.length;j++){
                   
                    for (var k=0; k<payments.length;k++) {
                           var report_line = new Object();
                        for (var field in checklist ) {
                           var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);    
                           if ( checklist[field].substring(0,2)=="OS" ){
                               report_line[checklist2[field]] = schedule[fn]; 
                           }
                           if ( checklist[field].substring(0,2)=="OP" ){
                               report_line[checklist2[field]] = payments[k][fn]; 
                               if ( fn=="amount") {
                                   if (payments[k][fn]=="") {report_line[checklist2[field]] = 0} else {
                                   report_line[checklist2[field]] =  Number(payments[k][fn]); }
                               }
                           }
                           if ( checklist[field].substring(0,2)=="OM" ){
                               report_line[checklist2[field]] = people[j][fn]; 
                           }
                           if ( checklist[field].substring(0,2)=="OT" ){
                               report_line[checklist2[field]] = people[j]["_"+payments[k]["paymentid"]]; 
                           }
                        }
                           report_data.push(report_line);    
                    }
                }
            }
        }
    }
    
        if (report_type=="Shared Event Attendance") {
        for(var section in report_config) {
               var evlist =  (report_config[section].events);
               for (var events in evlist.items) {
                   if ( evlist.items[events].startdate_g >= datepicker.value ) {
                     var report_line = new Object();
                     for (var field in checklist ) {
                       if ( checklist[field].substring(0,8)=="EV|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                         report_line[checklist2[field]] = evlist.items[events][fn];   
                         if (fn=="group") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                         if (fn=="section") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                       } else {report_line[checklist2[field]] = "";}
                     }
                     
                     
                   
//                 Attendance
                   
                   var attendee_list = (report_config[section].eventsa[ evlist.items[events].eventid].data);
                   
                   for (var attendee in attendee_list.items) {
                     var report_line2 = new Object();
                     for (var key in report_line) {
                          //copy all the fields
                          report_line2[key] = report_line[key];
                      }
                     for (var field in checklist ) {
                      if ( checklist[field].substring(0,13)=="SC|attendance" ){
                          var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                          if (fn=="attendance") {
                              evc = report_config[section].eventsac[ evlist.items[events].eventid].data.items;
                              evc_tot = 0;
                              for (var sec in evc) {
                                evc_tot =  evc_tot + evc[sec]['attendance']      
                              }
                              report_line2[checklist2[field]] = evc_tot;
                          }
                     }
                        
              if ( checklist[field].substring(0,2)=="SA" ){
                var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
               // alert(checklist[field].indexOf("|")+1);
                var gp = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"));
                
                report_line2[checklist2[field]] = attendee_list.items[attendee][fn];  
                if (fn=="fullname") {   report_line2[checklist2[field]] = attendee_list.items[attendee]['firstname']+" "+attendee_list.items[attendee]['lastname'];}
                if (fn=="patrol") {
                    report_line2[checklist2[field]] = attendee_list.items[attendee]['patrol']
                    if ( attendee_list.items[attendee]['patrolid']=='-2') {
                    report_line2[checklist2[field]] = 'Leader';
                    }
                    if ( attendee_list.items[attendee]['patrolid']=='-3') {
                    report_line2[checklist2[field]] = 'Young Leader';
                    }
                    if ( attendee_list.items[attendee]['patrolid']>=0) {
                    report_line2[checklist2[field]] = 'Member';
                    }
                };   
                if (fn=="startage") {
 
report_line2[checklist2[field]] = getAge(attendee_list.items[attendee].dob, evlist.items[events]["startdate_g"],"a");  

};
if (fn=="startages") {

report_line2[checklist2[field]] = getAge(attendee_list.items[attendee].dob, evlist.items[events]["startdate_g"],"s");  

};                   

}
                       if ( checklist[field].substring(0,8)=="EA|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                              report_line2[checklist2[field]] = attendee_list.items[attendee][fn];   
                       }
                       var field_event = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"))
                       if (( checklist[field].substring(0,3)=="EA|")&(field_event== evlist.items[events].eventid)){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                              report_line2[checklist2[field]] = attendee_list.items[attendee][fn];   
                       }
                     
              
                     }
                     
                       report_data.push(report_line2);     
                   } // Attendees
                    
                }
               }
        }
    }
    
    
    
    
    
    
    if (report_type=="Events & Attendance") {
        for(var section in report_config) {
               var evlist =  (report_config[section].events);
               for (var events in evlist.items) {
                   if ( evlist.items[events].startdate_g >= datepicker.value ) {
                     var report_line = new Object();
                     for (var field in checklist ) {
                       if ( checklist[field].substring(0,8)=="EV|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                         report_line[checklist2[field]] = evlist.items[events][fn];   
                         if (fn=="group") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                         if (fn=="section") { report_line[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                       } else {report_line[checklist2[field]] = "";}
                     }
                   
//                 Attendance
                   var attendee_list = (report_config[section].eventatt[ evlist.items[events].eventid]);
                    var members_array = JSON.parse(report_config[section].members);
                   for (var attendee in attendee_list.items) {
                     var report_line2 = new Object();
                     for (var key in report_line) {
                          //copy all the fields
                          report_line2[key] = report_line[key];
                      }
                     for (var field in checklist ) {
                       var member = attendee_list.items[attendee].scoutid;
                       if ( checklist[field].substring(0,7)=="MC|Core" ){
                       if (members_array.data[member]!=null){
                       var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                       report_line2[checklist2[field]] = members_array.data[member][fn];
                 if (fn=="full_name") { report_line2[checklist2[field]] = members_array.data[member].first_name+" "+members_array.data[member].last_name; };
                  if (fn=="patrol_role_short") { report_line2[checklist2[field]] = globals.patrol_roles[roles_config[get_roles_section(section)].section][members_array.data[member].patrol_role_level].abbr; }
                  if (fn=="group_name") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].groupname; };
                  if (fn=="section_name") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; };
                     if (fn=="full_age") { report_line2[checklist2[field]] = getAge(members_array.data[member].date_of_birth,"","a"); };
                     if (fn=="age_years") { report_line2[checklist2[field]] = getAge(members_array.data[member].date_of_birth,"","y"); };
                     if (fn=="birth_month") { report_line2[checklist2[field]] = month_list[(new Date(members_array.data[member].date_of_birth).getMonth())]; };
              }}
              if ( checklist[field].substring(0,2)=="MA" ){
                var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
               // alert(checklist[field].indexOf("|")+1);
                var gp = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"));
                if  (members_array.data[member]!=null) {
                report_line2[checklist2[field]] = members_array.data[member].custom_data[gp][fn];  };
              }  
              if ( checklist[field].substring(0,2)=="MF" ){
                  var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                  var gp = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"));
                  if (report_config[section].flexirecords[gp]!=null){
                  var flx = JSON.parse(report_config[section].flexirecords[gp]);
                  for (var flxm in flx.items) {
                      if (flx.items[flxm].scoutid==member) {
                          report_line2[checklist2[field]] = flx.items[flxm][fn];  
                      }   
                  } 
                  } else { report_line2[checklist2[field]] = "" };
              }  
                         
                         
                       if ( checklist[field].substring(0,8)=="EA|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                              report_line2[checklist2[field]] = attendee_list.items[attendee][fn];   
if (fn=="startage") {
if (typeof(members_array.data[member])!="undefined") {
report_line2[checklist2[field]] = getAge(members_array.data[member].date_of_birth, evlist.items[events]["startdate"],"a");  
};
};
if (fn=="startages") {
if (typeof(members_array.data[member])!="undefined") {
report_line2[checklist2[field]] = getAge(members_array.data[member].date_of_birth, evlist.items[events]["startdate"],"s");  
};
};                       }
                       var field_event = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|"))
                       if (( checklist[field].substring(0,3)=="EA|")&(field_event== evlist.items[events].eventid)){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                              report_line2[checklist2[field]] = attendee_list.items[attendee][fn];   
                       }
                     }
                       report_data.push(report_line2);     
                   }
                    
                }
               }
        }
    }


    if (report_type == "QM List") {
      for(var section in report_config) {
        for (var qmi in report_config[section].qmi){
          var qmilist = (report_config[section].qmi[qmi]);
          for (var items in qmilist.data.rows) {
           var report_line2 = new Object();
           for (var field in checklist ) {
             var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
             if (fn=="name") { report_line2[checklist2[field]] = qmilist.data.list.name;} else {
             report_line2[checklist2[field]] = qmilist.data.rows[items][fn];
             }   
             if (fn=="totalvalue") {
                 report_line2[checklist2[field]] = qmilist.data.rows[items][9]*qmilist.data.rows[items][6];
                 if (isNaN(report_line2[checklist2[field]])) {report_line2[checklist2[field]]=0;}
             }
             if (fn=="weight") {
                 report_line2[checklist2[field]]=0;
                 if (qmilist.data.rows[items].hasOwnProperty("4")) {
                 s = qmilist.data.rows[items][4].indexOf("WEIGHT:");
                 if (s!=-1) {
                    e = qmilist.data.rows[items][4].indexOf("\n",s);
                    if (e==-1) {e=qmilist.data.rows[items][4].length;}
                    report_line2[checklist2[field]] = qmilist.data.rows[items][4].substr(s+7, e-(s+7));
                   // if (isNaN(report_line2[checklist2[field]])) {report_line2[checklist2[field]]=0;}
                 }
                 }
             }
             if (report_line2[checklist2[field]]==undefined) {report_line2[checklist2[field]]="";}
           }
           report_data.push(report_line2);
         }
      }
     }
    }
    
    if (report_type == "User Access") {
      
      for(var section in report_config) {
        for (var ua in report_config[section].user_access){
               
           var report_line2 = new Object();
           for (var field in checklist ) {
             var fn1 = checklist[field].substring(checklist[field].indexOf("|")+1,checklist[field].lastIndexOf("|")); 
             var fn2 = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
             if (fn1=="Access") { report_line2[checklist2[field]] = report_config[section].user_access[ua][fn2];} else {
             acl="";   
             acn = parseInt(report_config[section].user_access[ua].permissions[fn2]);
             switch (acn) {
                 case 10: acl = 'Read Only'; break; 
                 case 20: acl = 'Read/Write'; break; 
                 case 100: acl = 'Admin'; break; 
                 default: acl = "No Access "; break;
             }     
             report_line2[checklist2[field]] = acl;
             } 
             if (fn2=='section') {report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname;}
             if (fn2=='rwa') {
                fl = ['badge','events','finance','flexi','member','programme','quartermaster','register','user'];
                ma = 0;
                for (i=0;i<fl.length;i++){
                    acn = parseInt(report_config[section].user_access[ua].permissions[fl[i]]);
                    if (acn>ma) {ma=acn;} 
                }
                switch (ma) {
                 case 10: acl = 'Read Only'; break; 
                 case 20: acl = 'Read/Write'; break; 
                 case 100: acl = 'Administrator'; break; 
                 default: acl = "No Access "; break;
             }
             report_line2[checklist2[field]] = acl; 
                
             }     
           }
           report_data.push(report_line2);
         }
      }
     
    }

    if ((report_type=="Gift Aid")) {
        for(var section in report_config) {
            var galist =  (report_config[section].giftaid);
            for (var gal in galist.items) {
                var report_line2 = new Object();
                for (var field in checklist ) {
                    var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                    report_line2[checklist2[field]] = galist.items[gal][fn];   
           }
           report_data.push(report_line2);
            }
        }
    }
    if (report_type == "Badge Stock") {
      for(var section in report_config) {
        var bslist =  (report_config[section].badge_stock);
         for (var stock in bslist.items) {
           var report_line2 = new Object();
           for (var field in checklist ) {
             var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
             report_line2[checklist2[field]] = bslist.items[stock][fn];   
           }
           report_data.push(report_line2);
         }
      }
    }
    
    if ((report_type=="Programme & Badges")) {
        for(var section in report_config) {
               var plist = (report_config[section].programme);
               for (var progs in plist.items) {
                  var report_line2 = new Object();
                   
                  for (var field in checklist ) {
                      if ( checklist[field].substring(0,12)=="PL|Programme" ){
                          var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                          report_line2[checklist2[field]] = plist.items[progs][fn];
                           if (fn=="group") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                           if (fn=="section") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                      }
                  }
                      var pitem = report_config[section].prog[plist.items[progs]['eveningid']];
                       var p = pitem.badgelinks[plist.items[progs]['eveningid']].length;
                    if (pitem.badgelinks[plist.items[progs]['eveningid']].length>0) {
                        // We have badges
                        for (var pb=0; pb<pitem.badgelinks[plist.items[progs]['eveningid']].length; pb++) {
                            var report_line = new Object();  
                            for (var key in report_line2) {
                            //copy all the fields
                              report_line[key] = report_line2[key];
                            }
                             for (var field2 in checklist ) {
                                if ( checklist[field2].substring(0,8)=="PI|Progs" ){
                                var fn = checklist[field2].substring(checklist[field2].lastIndexOf("|")+1);
                                report_line[checklist2[field2]] = pitem.badgelinks[plist.items[progs]['eveningid']][pb][fn];
                                }
                             }
                             report_data.push(report_line);
                        }
                        
                  } else { 
                      for (var field2 in checklist ) {
                                if ( checklist[field2].substring(0,8)=="PI|Progs" ){
                                var fn = checklist[field2].substring(checklist[field2].lastIndexOf("|")+1);
                                report_line2[checklist2[field2]] = "";
                                }
                             }
                      report_data.push(report_line2);
                  }
               
               }
        }
    }

    if ((report_type=="Events")|(report_type=="Events & QM Lists")) {
           for(var section in report_config) {
               var evlist = (report_config[section].events);
               for (var events in evlist.items) {
                   if ( evlist.items[events].startdate_g >= datepicker.value ) {
                    var report_line2 = new Object();
                    var any_qm = false;
                   for (var field in checklist ) {
                       if ( checklist[field].substring(0,1)=="Q" ){ any_qm = true; }
                     if ( checklist[field].substring(0,8)=="EV|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                       report_line2[checklist2[field]] = evlist.items[events][fn];   
                         if (fn=="group") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                         if (fn=="section") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                     }
                     if ( checklist[field].substring(0,1)=="Q" ){
                         report_line2[checklist2[field]] = "";
                     }
                        
                   }
                   if ((report_type=="Events")|(any_qm==false)) { report_data.push(report_line2); }
                   if (( report_type=="Events & QM Lists")&(any_qm==true)) {
                     if (report_config[section].eventqm[evlist.items[events].eventid]!=null) {
                     var qmlists =  (report_config[section].eventqm[evlist.items[events].eventid]);
                         if (qmlists.data.lists.length == 0 ) { report_data.push(report_line2); }
                     for (var qm_list in qmlists.data.lists) {
                       for ( var qm_list_item in qmlists.data.lists[qm_list].items) {
                         var report_line = new Object();  
                         for (var key in report_line2) {
                          //copy all the fields
                          report_line[key] = report_line2[key];
                         }
                          for (var field in checklist ) {
                             var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                             if ( checklist[field].substring(0,7)=="QL|List" ){  
                               report_line[checklist2[field]] = qmlists.data.lists[qm_list].list[fn];   
                             }
                             if ( checklist[field].substring(0,7)=="QI|Item" ){  
                               report_line[checklist2[field]] = qmlists.data.lists[qm_list].items[qm_list_item][fn];   
                             }
                             if ( checklist[field].substring(0,7)=="QM|Item" ){  
                               if ((fn=="TWeight")|(fn=="Weight")) {  report_line2[checklist2[field]] = '0'; }
                               if (report_config[section].qmi[qmlists.data.lists[qm_list].list.id].data.rows[qm_list_item].hasOwnProperty("4")) {
                               if (fn=="Notes") {
                                 report_line[checklist2[field]] = report_config[section].qmi[qmlists.data.lists[qm_list].list.id].data.rows[qm_list_item][4];
                               }
                               if ((fn=="TWeight")|(fn=="Weight")) {
                                   report_line2[checklist2[field]] = '0';
                                 ts =   report_config[section].qmi[qmlists.data.lists[qm_list].list.id].data.rows[qm_list_item][4];
                                 s = ts.indexOf("WEIGHT:");
                                 if (s!=-1) {
                                   e = ts.indexOf("\n",s);
                                   if (e==-1) {e=ts.length;}
                                   report_line[checklist2[field]] = ts.substr(s+7, e-(s+7));
                                   if (fn=="TWeight") {
                                       report_line[checklist2[field]] = report_line[checklist2[field]] * qmlists.data.lists[qm_list].items[qm_list_item]['booked'];
                                   }
                   
                                 }   
                                   
                                   
                                // report_line[checklist2[field]] = report_config[section].qmi[qmlists.data.lists[qm_list].list.id].data.rows[qm_list_item][4];
                               }
                               } else {
                                   report_line[checklist2[field]] = "";
                               }
                             }
                          }
                           report_data.push(report_line);
                         }
                        
                       }
                     } else {
                         report_data.push(report_line2);
                     }
                   }      // event                                                 
                   }
               }
                  
               
           }
    }

  
   if ((report_type=="Events & Badges")) {
           for(var section in report_config) {
               var evlist = (report_config[section].events);
               for (var events in evlist.items) {
                   if ( evlist.items[events].startdate_g >= datepicker.value ) {
                    var report_line2 = new Object();
                    var any_bg = false;
                   for (var field in checklist ) {
                       if ( checklist[field].substring(0,1)=="P" ){ any_bg = true; }
                     if ( checklist[field].substring(0,8)=="EV|Event" ){
                         var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                       report_line2[checklist2[field]] = evlist.items[events][fn];   
                         if (fn=="group") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].groupname; }
                         if (fn=="section") { report_line2[checklist2[field]] = roles_config[get_roles_section(section)].sectionname; }
                     }
                     if ( checklist[field].substring(0,1)=="P" ){ report_line2[checklist2[field]] = ""; }
                   }
                   if ((any_bg==false)|(!evlist.items[events]['badgelinks'])) { report_data.push(report_line2); }
                   if (( report_type=="Events & Badges")&(any_bg==true)) {
                     evc = report_config[section].eventcfg[evlist.items[events]['eventid']]['badgelinks'];
                     if (evc.length == 0 ) { report_data.push(report_line2); }
                     for (var bg_list in evc) {
                      
                         var report_line = new Object();  
                         for (var key in report_line2) {
                          //copy all the fields
                          report_line[key] = report_line2[key];
                         }
                          for (var field in checklist ) {
                             var fn = checklist[field].substring(checklist[field].lastIndexOf("|")+1);
                             if (checklist[field].substring(0,1)=="P") {
                             report_line[checklist2[field]] = evc[bg_list][fn];   
                             }
                              
                          }
                           report_data.push(report_line);
                         }
                     } 
                   }                                                       
                   }
               }
    }

  
  
  // Add in 'id' needed for gridview
   for (var id in report_data ) {    
       report_data[id].id = id;
   }
   // var json_Data = JSON.stringify(report_data);
   // $("#reportdata").text(json_Data);
   
    // var groupItemMetadataProvider = new 
dialog_delay.dialog( "close" );
select_checks2();
}


function onEachFeature(feature, layer) {
		var popupContent = "";
		if (feature.properties && feature.properties.popupContent) {
			popupContent += feature.properties.popupContent;
		}
		layer.bindPopup(popupContent);
}

function update_map_key(unique,prop2,exclusions) {
    $(".mapkey").html("Key for "+prop2+":");
    if (exclusions.hasOwnProperty(prop2)) {
         ex =  exclusions[prop2];
        } else { ex=[];}
    unique2 = [];    
    for (rd=0; rd<report_data.length;rd++) {
        include = true;
        for(field in exclusions) {
            for (exv=0;exv<exclusions[field].length;exv++){
                if (report_data[rd][field]==exclusions[field][exv]) { include=false; }
            }
        }
        if (include) { unique2.push(report_data[rd][prop2]) }
        
    }
    for (mk=0;mk<unique.length;mk++){
        col = mk%osm_colours.length;
       // if (!(ex.findIndex(exi=>exi==unique[mk])>-1)) {
          if (unique2.findIndex(exi=>exi==unique[mk])>-1) {
            
            $(".mapkey").append("&nbsp;<span style='color:"+osm_colours[mk%osm_colours.length]+"'>&#9608;&nbsp;</span>"+unique[mk])
            if (unique[mk]=="") { $(".mapkey").append("Blank");}
         }
    }
    if ($( "#report_type option:selected" ).text()!="Members & Maps") {
        $(".mapkey").html("<br>You need to select Report Type Members & Maps and a postcode field for Mapping");
    }
}
	
	
function refresh_map() {
     mymap.removeLayer(markers);
       map_full_config.groupby =  $( "#groupby option:selected" ).text();
        $("#config_json").val(JSON.stringify(map_full_config, undefined, 2));
    //    mymap.removeLayer(current_geojson);
    iconSettings = {
        mapIconUrl: '<svg version="1" xmlns="http://www.w3.org/2000/svg" style="width: 30px; height: 40px;" ><path fill="{mapIconColor}" stroke="#FFF" stroke-width="1" stroke-miterlimit="10" d="m14.095833,1.55c-6.846875,0 -12.545833,5.691 -12.545833,11.866c0,2.778 1.629167,6.308 2.80625,8.746l9.69375,17.872l9.647916,-17.872c1.177083,-2.438 2.852083,-5.791 2.852083,-8.746c0,-6.175 -5.607291,-11.866 -12.454166,-11.866zm0,7.155c2.691667,0.017 4.873958,2.122 4.873958,4.71s-2.182292,4.663 -4.873958,4.679c-2.691667,-0.017 -4.873958,-2.09 -4.873958,-4.679c0,-2.588 2.182292,-4.693 4.873958,-4.71z"/></svg>',
       
        mapIconColor: '#cc756b',
        mapIconColorInnerCircle: '#fff',
        pinInnerCircleRadius: 0
    };
    
divIcon = L.divIcon({
                        className: "leaflet-data-marker",
                        html: L.Util.template(iconSettings.mapIconUrl, iconSettings),
                        iconAnchor: [12, 32],
                        iconSize: [25, 40],
                        popupAnchor: [0, -28] 
                         
                    });
    current_geojson = L.geoJSON(null, {onEachFeature: onEachFeature,  
                                     filter: function(feature, layer) {
                                         exclude = false;
                                         for(field in exclusions) {
                                            for (exv=0;exv<exclusions[field].length;exv++){
                                                if (feature.properties.filtervalue[field]==exclusions[field][exv]) { exclude = true; }
                                            }
                                         }
                                            return (!exclude);
                                        }, 
                                    pointToLayer: function (feature, latlng) {
           iconSettings.mapIconColor =  feature.properties.iconcolor;
		divIcon = L.divIcon({
                        className: "leaflet-data-marker",
                        html: L.Util.template(iconSettings.mapIconUrl, iconSettings),
                        iconAnchor: [12, 32],
                        iconSize: [25, 40],
                        popupAnchor: [0, -28] 
                         
                    });
				return  L.marker(latlng,{icon: divIcon}) 
            
    }});
    prop = "";
    prop2 = "";
    for (l in report_data[0]){ 
        if (l.indexOf("Postcode")>-1) {prop=l;}
        if ((l.indexOf("Postcode")==-1) && (l.indexOf("Full Name")==-1)&& (l.indexOf("id")==-1)) {prop2=l;}
    }
    prop2= $( "#groupby option:selected" ).text();
    var unique = [...new Set(report_data.map(item => item[prop2]))];
    unique.sort();
    update_map_key(unique,prop2,exclusions);
     markers  = L.markerClusterGroup();    
    gf = [];
    for(var i=0;i<report_data.length;i++){
         iconSettings.mapIconColor = osm_colours[unique.findIndex(a=>a==report_data[i][prop2])%osm_colours.length];
         pc = report_data[i][prop];
         if (report_data[i].hasOwnProperty("Full Name")) {fn = report_data[i]["Full Name"] } else {fn =pc}
         ll = postcode_list.find(a=>(a.query==pc));
         if (ll!=undefined&&ll.result!=null) {
            var geojsonFeature = {
            "type": "Feature",
            "properties": {
            "popupContent": fn+"<br>"+report_data[i][prop2],
            "filtervalue": report_data[i], 
            "iconcolor": osm_colours[unique.findIndex(a=>a==report_data[i][prop2])%osm_colours.length]
            },
            "geometry": {
            "type": "Point",
            "coordinates": [ll.result.longitude,ll.result.latitude]
            }
            };   
       //      current_geojson.addData(geojsonFeature);
       gf.push(geojsonFeature)
        }
        
       
       
    }
 //    current_geojson.addData(gf);
    
    current_geojson.addData(gf);
       markers.addLayer(current_geojson);
  mymap.addLayer(markers);
 // mymap.removeLayer(current_geojson); 
    //   markers.addLayer(current_geojson);
    //  mymap.addLayer(markers);
    //  mymap.removeLayer(current_geojson);
    if (markers.getBounds().hasOwnProperty("_northEast")){
  mymap.fitBounds(markers.getBounds());
 
    }
}
	
function select_checks2() {
     // Start of fn
        
        
      fndd = function(c) {
          var attrElem, btns, checkContainer, filterItem, filterItemExcluded, hasExcludedItem, keys, len3, o, ref2, showFilterList, triangleLink, updateFilter, v, valueList;
          
           // keys = (function() {
          //  var results;
          //  results = [];
          //  for (k in axisValues[c]) {
         //     results.push(k);
        //    }
        //    return results;
        //    })();   // keys
          if (slick_full_config.hasOwnProperty("exclusions")) { exclusions = slick_full_config.exclusions };  
          hasExcludedItem = false;
          if (exclusions.hasOwnProperty(c)==true) {  hasExcludedItem = true; };
          valueList = $("<div>").addClass('pvtFilterBox').hide();
          valueList.append($("<h4>").text(c + " (" + consolidated.length + ")"));
          //if (keys.length > opts.menuLimit) {
         //   valueList.append($("<p>").html(opts.localeStrings.tooMany));
         // } else {
            
            btns = $("<p>").appendTo(valueList);
          var groupitem = false;
          if(slick_full_config.hasOwnProperty("grid")) {
            if (slick_full_config.grid.hasOwnProperty("groups")) {
              // do we have a group on this field?
                  groupitem = (slick_full_config.grid.groups.indexOf(c)!=-1);              //}
            }
          }
  
         
          $("<input>").attr("type", "checkbox").addClass('slkgrp').attr("checked", groupitem).data("group", [c]).appendTo(btns);
          
          btns.append("Group Field");
          btns.append($("<br>"));
            btns.append($("<button>", {
              type: "button"
            }).html("Select All").bind("click", function() {
              return valueList.find(".pvtCheckContainer input:visible").prop("checked", true);
            }));
            btns.append($("<button>", {
              type: "button"
            }).html("Select None").bind("click", function() {
              return valueList.find(".pvtCheckContainer input:visible").prop("checked", false);
            }));
            btns.append($("<br>"));
            btns.append($("<input>", {
              type: "text",
              placeholder: "Filter",
              "class": "pvtSearch"
            }).bind("keyup", function() {
              var filter;
              filter = $(this).val().toLowerCase();
              return valueList.find('.pvtCheckContainer p').each(function() {
                var testString;
                testString = $(this).text().toLowerCase().indexOf(filter);
                if (testString !== -1) {
                  return $(this).show();
                } else {
                  return $(this).hide();
                }
              });
            }));
            checkContainer = $("<div>").addClass("pvtCheckContainer").appendTo(valueList);
           // ref2 = keys.sort(getSort(opts.sorters, c));
            for (o = 0, len3 = consolidated.length; o < len3; o++) {
              //k = ref2[o];
              //v = axisValues[c][k];
              k = consolidated[o];
              v = consolidatedc[consolidated[o]];
              filterItem = $("<label>");
              filterItemExcluded = false;
              //if (opts.inclusions[c]) {
            //   filterItemExcluded = (indexOf.call(opts.inclusions[c], k) < 0);
           //   } else if (opts.exclusions[c]) {
            //    filterItemExcluded = (indexOf.call(opts.exclusions[c], k) >= 0);
           //   }
           //   hasExcludedItem || (hasExcludedItem = filterItemExcluded);
         //     $("<input>").attr("type", "checkbox").addClass('pvtFilter').attr("checked", true).data("filter", [c, k]).appendTo(filterItem);
         slk_exc_tick = true;
         if (exclusions.hasOwnProperty(c)==true) 
         {
          if (exclusions[c].find( function (a) { return a==k; }) != null) { slk_exc_tick = false }; 
         }
         $("<input>").attr("type", "checkbox").addClass('pvtFilter').attr("checked", slk_exc_tick).data("filter", [c, k]).appendTo(filterItem);
              filterItem.append($("<span>").html(k));
              filterItem.append($("<span>").text(" (" + v + ")"));
              checkContainer.append($("<p>").append(filterItem));
            }
          
          updateFilter = function() {
            var groupitem;
            groupitem = (valueList.find(".slkgrp:checked").length > 0);
            var unselectedCount;
            unselectedCount = valueList.find("[type='checkbox'].pvtFilter").length  - valueList.find("[type='checkbox'].pvtFilter:checked").length;
                          
            if (unselectedCount > 0) {
              attrElem.addClass("pvtFilteredAttribute");
            } else {
              attrElem.removeClass("pvtFilteredAttribute");
            }
          if (groupitem) {  attrElem.addClass("pvtGroupAttribute");
            } else {
              attrElem.removeClass("pvtGroupAttribute");
            }
          collect_slickfilters() 
          slickupdate(dataView,grid,checklist,false,true); 
              return valueList.toggle(0, slickupdate(dataView, grid, checklist,false,true));
          };
          $("<p>").appendTo(valueList).append($("<button>", {
            type: "button"
          }).text("OK").bind("click", updateFilter));
          showFilterList = function(e) {
            var clickLeft, clickTop, ref3;
            ref3 = $(e.currentTarget).position(), clickLeft = ref3.left, clickTop = ref3.top;
            valueList.css({
              left: clickLeft + 10,
              top: clickTop + 10
            }).toggle();
            valueList.find('.pvtSearch').val('');
            return valueList.find('.pvtCheckContainer p').show();
          };
          triangleLink = $("<span>").addClass('pvtTriangle').html(" &#x25BE;").bind("click", showFilterList);
          i = 1;
          attrElem = $("<li>").attr('id',c).addClass("axis_" + i).append($("<span>").addClass('pvtAttr').text(c).data("attrName", c).append(triangleLink));
          if (hasExcludedItem) {
            attrElem.addClass('pvtFilteredAttribute');
          }
          if (groupitem) {  attrElem.addClass("pvtGroupAttribute");
            } 
           report_output_divs.append(attrElem).append(valueList);
  //        $("#reportoutput").append(attrElem.prop('outerHTML')).append(valueList.prop('outerHTML'))
    //      return attrElem.bind("dblclick", showFilterList);
          return attrElem.bind("dblclick", showFilterList);
    };
  
        //// ENd of fn
        
        
         fnddmap = function(c) {
          var attrElem, btns, checkContainer, filterItem, filterItemExcluded, hasExcludedItem, keys, len3, o, ref2, showFilterList, triangleLink, updateFilter, v, valueList;
          
           // keys = (function() {
          //  var results;
          //  results = [];
          //  for (k in axisValues[c]) {
         //     results.push(k);
        //    }
        //    return results;
        //    })();   // keys
          if (map_full_config.hasOwnProperty("exclusions")) { exclusions = map_full_config.exclusions };  
          hasExcludedItem = false;
          if (exclusions.hasOwnProperty(c)==true) {  hasExcludedItem = true; };
          valueList = $("<div>").addClass('pvtFilterBox').hide();
          valueList.append($("<h4>").text(c + " (" + consolidated.length + ")"));
          //if (keys.length > opts.menuLimit) {
         //   valueList.append($("<p>").html(opts.localeStrings.tooMany));
         // } else {
            
            btns = $("<p>").appendTo(valueList);
         
          btns.append($("<br>"));
            btns.append($("<button>", {
              type: "button"
            }).html("Select All").bind("click", function() {
              return valueList.find(".pvtCheckContainer input:visible").prop("checked", true);
            }));
            btns.append($("<button>", {
              type: "button"
            }).html("Select None").bind("click", function() {
              return valueList.find(".pvtCheckContainer input:visible").prop("checked", false);
            }));
            btns.append($("<br>"));
            btns.append($("<input>", {
              type: "text",
              placeholder: "Filter",
              "class": "pvtSearch"
            }).bind("keyup", function() {
              var filter;
              filter = $(this).val().toLowerCase();
              return valueList.find('.pvtCheckContainer p').each(function() {
                var testString;
                testString = $(this).text().toLowerCase().indexOf(filter);
                if (testString !== -1) {
                  return $(this).show();
                } else {
                  return $(this).hide();
                }
              });
            }));
            checkContainer = $("<div>").addClass("pvtCheckContainer").appendTo(valueList);
           // ref2 = keys.sort(getSort(opts.sorters, c));
            for (o = 0, len3 = consolidated.length; o < len3; o++) {
              //k = ref2[o];
              //v = axisValues[c][k];
              k = consolidated[o];
              v = consolidatedc[consolidated[o]];
              filterItem = $("<label>");
              filterItemExcluded = false;
             
         slk_exc_tick = true;
         if (exclusions.hasOwnProperty(c)==true) 
         {
          if (exclusions[c].find( function (a) { return a==k; }) != null) { slk_exc_tick = false }; 
         }
         $("<input>").attr("type", "checkbox").addClass('pvtFilter').attr("checked", slk_exc_tick).data("filter", [c, k]).appendTo(filterItem);
              filterItem.append($("<span>").html(k));
              filterItem.append($("<span>").text(" (" + v + ")"));
              checkContainer.append($("<p>").append(filterItem));
            }
          
            updateFilterMap = function() {
        var unselectedCount;
            unselectedCount = valueList.find("[type='checkbox'].pvtFilter").length  - valueList.find("[type='checkbox'].pvtFilter:checked").length;
            if (unselectedCount > 0) {
              attrElem.addClass("pvtFilteredAttribute");
            } else {
              attrElem.removeClass("pvtFilteredAttribute");
            }
          exclusions = collect_mapfilters(); 
          
        //  slickupdate(dataView,grid,checklist,false,true); 
        grid={};
         map_full_config.report_type =     $( "#report_type option:selected" ).text();
         map_full_config.fields = checklist;
         map_full_config.exclusions = exclusions;
         map_full_config.map = true;
           map_full_config.groupby =  $( "#groupby option:selected" ).text();
                   $("#config_json").val(JSON.stringify(map_full_config, undefined, 2));
          return valueList.toggle(0,refresh_map);
         //     return valueList.toggle(0, slickupdate(dataView, grid, checklist,false,true));
          }; //UpdateFilterMap
          $("<p>").appendTo(valueList).append($("<button>", {
            type: "button"
          }).text("OK").bind("click", updateFilterMap));
          showFilterList = function(e) {
            var clickLeft, clickTop, ref3;
            ref3 = $(e.currentTarget).position(), clickLeft = ref3.left, clickTop = ref3.top;
            valueList.css({
              left: clickLeft + 10,
              top: clickTop + 10
            }).toggle();
            valueList.find('.pvtSearch').val('');
            return valueList.find('.pvtCheckContainer p').show();
          };
          triangleLink = $("<span>").addClass('pvtTriangle').html(" &#x25BE;").bind("click", showFilterList);
          i = 1;
          attrElem = $("<li>").attr('id',c).addClass("axis_" + i).append($("<span>").addClass('pvtAttr').text(c).data("attrName", c).append(triangleLink));
          if (hasExcludedItem) {
            attrElem.addClass('pvtFilteredAttribute');
          }
          
           report_output_divs.append(attrElem).append(valueList);
  //        $("#reportoutput").append(attrElem.prop('outerHTML')).append(valueList.prop('outerHTML'))
    //      return attrElem.bind("dblclick", showFilterList);
          return attrElem.bind("dblclick", showFilterList);
    };
  
        //// ENd of fnmap
        
        
var searchIDs = $('#fieldtable input:checked').map(function(){ return $(this).val(); });
    var searchIDs2 = $('#fieldtable input:checked').map(function(){ return $(this).attr("name");});
 var checklist = searchIDs.get();
    var checklist2 = searchIDs2.get();
     var report_type = $( "#report_type option:selected" ).text();
    if (report_type=='Members & Sections') {
                checklist.push("MC|Core|othersections");
                checklist2.push("Other Sections");
    }
//ga('send', 'event', 'Report', security.userid, $("#report_type option:selected" ).text());
Slick.Data.GroupItemMetadataProvider();
   
    dataView = new Slick.Data.DataView( ); 
    var Refresh = function(config) {  var config_copy = JSON.parse(JSON.stringify(config));
                    //delete some values which are functions
                      delete config_copy["aggregators"];
                      delete config_copy["renderers"];
                      if ($("#saveas_filters").val()!="on") {
                    //    delete config_copy["exclusions"];
                      }
                      delete config_copy["sorters"];                                    
                      delete config_copy["derivedAttributes"];
                    //delete some bulky default values
                     // delete config_copy["rendererOptions"];
                      delete config_copy["localeStrings"];
   $("#SavedReports").val("blank");
   disp($("input[name='display_total']:checked").val()=="on");
   var searchIDs = $('#fieldtable input:checked').map(function(){    
      return $(this).val();
    });
    var checklist = searchIDs.get();
      
        var full_config = new Object();
            full_config.pivot = config_copy;
            full_config.report_type =     $( "#report_type option:selected" ).text();
            full_config.rotate = [];
            $("#reportoutput").find('input.pvtrotate:checked').each(function() {
            full_config.rotate.push($(this).data("rotate")); 
            });
            full_config.fields = checklist;
            // full_config.display_total = ($("#dialog-form3 input[name='display_total']:checked").val()=="on");
                    // $("#config_json").val(JSON.stringify(config_copy, undefined, 2));
            $("#config_json").val(JSON.stringify(full_config, undefined, 2));
 };
    
		var sortAs =           $.pivotUtilities.sortAs;
        var naturalSort2 =           $.pivotUtilities.naturalSort2;
        var renderers = $.extend($.pivotUtilities.renderers, $.pivotUtilities.export_renderers,
                        $.pivotUtilities.gchart_renderers, $.pivotUtilities.pdf_renderers,$.pivotUtilities.excel_renderers);
        var agg = "Count";
        var rows = new Array();
        var cols = new Array();
        var vals = new Array();
        var rendname = "Table";
        var rotate = new Array();
        var exclusions = new Object;
        var inclusions = new Object;
        var refresh_layout = false;
        if($("#SavedReports option:selected").text() != "") {
        if ($("#SavedReports option:selected").hasClass("template")) {
        for(var i = 0; i < template_report.reports.length;  i++) {
           if (template_report.reports[i].name==$("#SavedReports option:selected").text()) {
             var saved_report = JSON.parse(template_report.reports[i].def);
           }
         }  
       } else {
         for (var report in report_list.reports) {
        if (report_list.reports[report].name==$("#SavedReports option:selected").text()) {
        var saved_report = JSON.parse(report_list.reports[report].def);
         }
        }
        }
        //var saved_report = JSON.parse(GM_getValue($("#SavedReports option:selected").text()));
        $("#SavedReports").val("blank");
         if (saved_report.hasOwnProperty("pivot")) {
         rows = saved_report.pivot.rows;
         rendname = saved_report.pivot.rendererName;
         if(typeof saved_report.pivot.exclusions  === "undefined") {
         } else {  
exclusions = saved_report.pivot.exclusions;
inclusions = saved_report.pivot.inclusions;
}
         cols = saved_report.pivot.cols;
         vals = saved_report.pivot.vals;
         rotate = saved_report.rotate;
         disp(saved_report.display_total);
                $("#dialog-form3 input[name='display_total']").prop('checked',saved_report.display_total); 
            
         refresh_layout = true;
         agg = saved_report.pivot.aggregatorName;
        } else if ( saved_report.hasOwnProperty("map"))
        {
            map_full_config = saved_report;
        }
        
        else {slick_full_config = saved_report; }
        	
        }
		var pvtOpts = {
			renderers: renderers,
            onRefresh: Refresh,
            rendererName : rendname,
            rows: rows,
            cols: cols,
            vals: vals,
            exclusions: exclusions,
            inclusions: inclusions,
            rotate : rotate,
            sorters: function(attr) {
                        if(attr == "Month of Birth") {
                            return sortAs(["Jan","Feb","Mar","Apr", "May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]);
                        }
                        if((attr == "Patrol Role")|(attr == "Role ID")) {
                            return naturalSort2();
                        }
            },
			aggregatorName : agg
		};

 
//debugger;
   
var display_option 
display_option = $('input[name=outputtype]:checked').val();
display_option = $('input[type=radio][name=render]:checked').val();
    if (display_option=='pivot') {
          if ($("#mapid").is(":visible")) { $("#mapid").toggle();} 
        $("#reportoutput").pivotUI(report_data, pvtOpts,refresh_layout);
        $("#reportoutput").append("<br>Drag fields from the blue 'dock' area to the pink columns and rows areas.");
        
    }  else if (display_option=='map') {
         checklist = Array.from(new Set(checklist));
         checklist2 = Array.from(new Set(checklist2));
          for (l in report_data[0]){ 
             if ((l.indexOf("Postcode")==-1) && (l.indexOf("Full Name")==-1)&& (l.indexOf("id")==-1)) {prop2=l;}
         }
         if (!map_full_config.hasOwnProperty("groupby")){ map_full_config.groupby=prop2}
         report_output_divs2 = "<div class='oneline' style='display: flex'><div class='reportfields' style='width:auto'>Group by:<br><select id='groupby'>";
         for ( field in checklist ) {
             report_output_divs2 +="<option";
             if ((map_full_config.hasOwnProperty("groupby")) & (map_full_config.groupby==checklist2[field])) {report_output_divs2 +=" selected";} 
             report_output_divs2 += ">"+checklist2[field]+"</option>"
         }
         report_output_divs2 +="</select></div><div class='filtersline'></div>";
         report_output_divs = $("<ul>").addClass("reportfields").attr("id", "listfields");
 // keys = Object.keys(report_data[0]);
  for ( field in checklist ) { 
 //     if (columnsizes.hasOwnProperty(checklist2[field])==false) 
 //     {
 //         columnsizes[checklist2[field]] = 100;
 //     };
      // Assemble Unique Values & Counts
       var consolidated, consolidatedc 
             
   
       
      consolidated = []
      consolidatedc = []
          for (var value in report_data) {
              if (consolidated.indexOf(report_data[value][checklist2[field]]) < 0 ) {
                   consolidated.push(report_data[value][checklist2[field]]) ;
                   consolidatedc[report_data[value][checklist2[field]]] = 1;
              } else
              {
                   consolidatedc[report_data[value][checklist2[field]]] += 1;
              }
             
          }
      consolidated.sort();
     var test_output =  fnddmap(checklist2[field]);
   
   
  }   //fields
        
           $("#reportoutput").html("");  
           $("#reportoutput").append(report_output_divs2); 
    //       $("#reportoutput").append("<div>");
     //      $("#reportoutput").append(report_output_divs);  
             $(".filtersline").append(report_output_divs);  
           $("#reportoutput").append("</div></div><div class='mapkey'></div>"); 
      //     $("#reportoutput").append("<br>Mapping is not yet implemented");
            $("#groupby").on("change",refresh_map);
            if (!$("#mapid").is(":visible")) { $("#mapid").toggle();} 
           if (!mymap.hasOwnProperty('options')) {
             
              mymap = L.map('mapid',{     
                      fullscreenControl: true,
                      fullscreenControlOptions: {position: 'topleft'}}).setView([51.505, -0.09], 13);
           }
           mymap.eachLayer(function (layer) {
             mymap.removeLayer(layer);
           });
           L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
    }).addTo(mymap)
     iconSettings = {
        mapIconUrl: '<svg version="1" xmlns="http://www.w3.org/2000/svg" style="width: 30px; height: 40px;" ><path fill="{mapIconColor}" stroke="#FFF" stroke-width="1" stroke-miterlimit="10" d="m14.095833,1.55c-6.846875,0 -12.545833,5.691 -12.545833,11.866c0,2.778 1.629167,6.308 2.80625,8.746l9.69375,17.872l9.647916,-17.872c1.177083,-2.438 2.852083,-5.791 2.852083,-8.746c0,-6.175 -5.607291,-11.866 -12.454166,-11.866zm0,7.155c2.691667,0.017 4.873958,2.122 4.873958,4.71s-2.182292,4.663 -4.873958,4.679c-2.691667,-0.017 -4.873958,-2.09 -4.873958,-4.679c0,-2.588 2.182292,-4.693 4.873958,-4.71z"/></svg>',
       
        mapIconColor: '#cc756b',
        mapIconColorInnerCircle: '#fff',
        pinInnerCircleRadius: 0
    };
    
divIcon = L.divIcon({
                        className: "leaflet-data-marker",
                        html: L.Util.template(iconSettings.mapIconUrl, iconSettings),
                        iconAnchor: [12, 32],
                        iconSize: [25, 40],
                        popupAnchor: [0, -28] 
                         
                    });
    current_geojson = L.geoJSON(null, {onEachFeature: onEachFeature,  
                                     filter: function(feature, layer) {
                                            exclude = false;
                                         for(field in exclusions) {
                                            for (exv=0;exv<exclusions[field].length;exv++){
                                                if (feature.properties.filtervalue[field]==exclusions[field][exv]) { exclude = true; }
                                            }
                                         }
                                            return (!exclude);
                                        }, 
                                    pointToLayer: function (feature, latlng) {
                                         
        iconSettings.mapIconColor =  feature.properties.iconcolor;
		divIcon = L.divIcon({
                        className: "leaflet-data-marker",
                        html: L.Util.template(iconSettings.mapIconUrl, iconSettings),
                        iconAnchor: [12, 32],
                        iconSize: [25, 40],
                        popupAnchor: [0, -28] 
                         
                    });
				return  L.marker(latlng,{icon: divIcon}) 
            
    }}); //.addTo(mymap);
    prop = "";
    prop2 = "";
    for (l in report_data[0]){ 
        if (l.indexOf("Postcode")>-1) {prop=l;}
        if ((l.indexOf("Postcode")==-1) && (l.indexOf("Full Name")==-1)&& (l.indexOf("id")==-1)) {prop2=l;}
    }
    if ((map_full_config.hasOwnProperty("groupby"))) {prop2= map_full_config.groupby};
    var unique = [...new Set(report_data.map(item => item[prop2]))];
    unique.sort();
    exclusions = collect_mapfilters(); 
    update_map_key(unique,prop2,exclusions)
     markers  = L.markerClusterGroup();    
    gf = [];
    for(var i=0;i<report_data.length;i++){
         iconSettings.mapIconColor = osm_colours[unique.findIndex(a=>a==report_data[i][prop2])%osm_colours.length];
         pc = report_data[i][prop];
         if (report_data[i].hasOwnProperty("Full Name")) {fn = report_data[i]["Full Name"] } else {fn =pc}
         ll = postcode_list.find(a=>(a.query==pc));
         if (ll!=undefined&&ll.result!=null) {
            var geojsonFeature = {
            "type": "Feature",
            "properties": {
            "popupContent": fn+"<br>"+report_data[i][prop2],
            "filtervalue": report_data[i],
            "iconcolor":osm_colours[unique.findIndex(a=>a==report_data[i][prop2])%osm_colours.length]
            },
            "geometry": {
            "type": "Point",
            "coordinates": [ll.result.longitude,ll.result.latitude]
            }
            };   
          //   current_geojson.addData(geojsonFeature);
          gf.push(geojsonFeature);
        }
        
       
       
    }
      current_geojson.addData(gf);
       markers.addLayer(current_geojson);
  mymap.addLayer(markers);
 // mymap.removeLayer(current_geojson); 
    //   markers.addLayer(current_geojson);
    //  mymap.addLayer(markers);
    //  mymap.removeLayer(current_geojson);
     if (markers.getBounds().hasOwnProperty("_northEast")){
  mymap.fitBounds(markers.getBounds());
  map_full_config.report_type =     $( "#report_type option:selected" ).text();
         map_full_config.fields = checklist;
         map_full_config.exclusions = exclusions;
         map_full_config.map = true;
         map_full_config.groupby =  $( "#groupby option:selected" ).text();
     }
    } // map
    else {
 
         if ($("#mapid").is(":visible")) { $("#mapid").toggle();} 
        var report_output_divs, triangleLink, field_div, btn, field
    //    if (1==1) {
 report_output_divs = $("<ul>").addClass("reportfields").attr("id", "listfields");
 // keys = Object.keys(report_data[0]);
  for ( field in checklist ) { 
      if (columnsizes.hasOwnProperty(checklist2[field])==false) 
      {
          columnsizes[checklist2[field]] = 100;
      };
      // Assemble Unique Values & Counts
       var consolidated, consolidatedc 
             
   
       
      consolidated = []
      consolidatedc = []
          for (var value in report_data) {
              if (consolidated.indexOf(report_data[value][checklist2[field]]) < 0 ) {
                   consolidated.push(report_data[value][checklist2[field]]) ;
                   consolidatedc[report_data[value][checklist2[field]]] = 1;
              } else
              {
                   consolidatedc[report_data[value][checklist2[field]]] += 1;
              }
             
          }
      consolidated.sort();
     var test_output =  fndd(checklist2[field],"sg");
   
   
  }  
  
  var sortlist = $("<ul>").attr("id","fieldsortlist");   
  var sortlistinc = new Array ();
  sortlistinc = [];    
  if(slick_full_config.hasOwnProperty("grid")) {
    if (slick_full_config.grid.hasOwnProperty("sort")) {
      for (field in slick_full_config.grid.sort) {
          if (checklist2.indexOf(slick_full_config.grid.sort[field].name)!=-1) {
              sortlistinc.push(slick_full_config.grid.sort[field].name);
              if (slick_full_config.grid.sort[field].ascend) {
              sortlist.append("<li class=\"sortAttr\"><span class=\"sortAttrorder ui-icon ui-icon-arrowthick-1-n\" style=\"float:left;\"></span>"+slick_full_config.grid.sort[field].name+"</li>");             
              } else
               sortlist.append("<li class=\"sortAttr\"><span class=\"sortAttrorder ui-icon ui-icon-arrowthick-1-s\" style=\"float:left;\"></span>"+slick_full_config.grid.sort[field].name+"</li>");
              {
              }
          }
      }
    }
  }
  if(slick_full_config.hasOwnProperty("grid")) {
    if (slick_full_config.grid.hasOwnProperty("sizes")) {     
        for (field in  slick_full_config.grid.sizes) {
            columnsizes[field] = slick_full_config.grid.sizes[field];
        }
    }
  }
  for ( field in checklist ) { 
    if (sortlistinc.indexOf(checklist2[field])==-1) {
    sortlist.append("<li class=\"sortAttr\"><span class=\"sortAttrorder ui-icon ui-icon-arrowthick-1-n\" style=\"float:left;\"></span>"+checklist2[field]+"</li>");
    }
  }
  //report_output_divs = report_output_divs+  "</ul><br><ul id=\"selfields\" class=\"reportfields\" style=\"list-style-type: none; margin: 0; float: left; margin: 10px; background: #eee;  width: 95% ; padding: 5px; border-style: solid!important; \"></ul><div id=\"reportoutput2\" style=\" min-height: 300px; height: 95%; width: 95%; margin: 30px;border-style: solid!important;\"></div>"
  
  $('#reportoutput').html(""); 
 // $('#reportoutput').append("Drag fields from the blue dock area to the pink area. Sort sequence fields can also be dragged.<br>"); 
  $('#reportoutput').append('<table id="reportoutputtable"></table>');
  $('#reportoutput').children().append("<tr><td rowspan=3 id=\"tablesortlist\" width=\"20%\"></td><td id=\"tablereportoutput\"></td></tr><tr><td id=\"tablereportoutput2\"></td></tr><td id=\"tablereportoutput3\"></td></tr>");
  $("#tablereportoutput").html(report_output_divs);  
  $("#tablereportoutput2").append($("<ul>").attr('id', 'selfields').addClass("reportfields"));//.attr('width', $("#reportoutput").width()));
  $("#tablereportoutput3").append($("<div>").attr('id', 'reportoutput2'));
  $("#tablereportoutput3").css('max-width', (0.8*$("#reportoutput").width())+"px");
  $("#tablesortlist").html(sortlist);
  $("#tablesortlist").prepend("Output: <select class=\"slickot\" ><option value=\"grid\">Grid</option><option value=\"pdf\">PDF</option><option value=\"pdfd\">PDF Download</option></select><br><button id=\"expall\" type=\"button\">Expand All</button><button id=\"collall\" type=\"button\">Collapse All</button><br><br><small>Drag fields from the blue dock area to the pink area. The fields below can also be dragged to change the sort sequence.</small><br><br><b>Sort Sequence</b>");
  if(slick_full_config.hasOwnProperty("output_type")) {
     $(".slickot").val(slick_full_config.output_type);
  }
  $("#reportoutput").wrapInner("<div id=\"Test\"></div>");
  $(".sortAttrorder").click(function () { if ($(this).hasClass('ui-icon-arrowthick-1-n')) { $(this).addClass('ui-icon-arrowthick-1-s'); $(this).removeClass('ui-icon-arrowthick-1-n'); }
                                        else { $(this).addClass('ui-icon-arrowthick-1-n'); $(this).removeClass('ui-icon-arrowthick-1-s'); }
                                        slickupdate(dataView,grid,checklist,false,false);
                                        });
  $( "#fieldsortlist" ).sortable( { update: function( event, ui ) { slickupdate(dataView,grid,checklist,false,false); }});
  $( "#fieldsortlist" ).disableSelection();
  $(".slickot").change( function () {   if ($(".slickot option:selected").text()=="Grid") { grid = new Slick.Grid("#reportoutput2", dataView, columns, options);grid.invalidateAllRows();
    grid.render(); grid.resizeCanvas();slick_click (checklist);} else {slick_pdf(); };slickupdate(dataView,grid,checklist,false,false);  } );
  $("#tablesortlist").on('click', '#collall',function() {dataView.collapseAllGroups(); if ($(".slickot option:selected").text()=="Grid") {
    grid.invalidateAllRows();
    grid.render(); grid.resizeCanvas();;} else { slick_pdf() };} );
   $("#tablesortlist").on('click', '#expall',function() {dataView.expandAllGroups(); if ($(".slickot option:selected").text()=="Grid") {
    grid.invalidateAllRows();
    grid.render(); grid.resizeCanvas();;} else { slick_pdf() };} );      
 // $("#tablesortlist").on('click', '#expall',function() {dataView.expandAllGroups();slickupdate(dataView,grid,checklist,false);} );
  // LOok at Config
var columns = []; // These are the columns in the grid...
  var lis = document.getElementById("listfields").getElementsByTagName("li");
// Rebuild the Grid if we have any config
  if (slick_full_config.hasOwnProperty("grid")) {
    columns = [];
   for (var i in slick_full_config.grid.rows) {

       var element = document.getElementById(slick_full_config.grid.rows[i]);
       
       $('#selfields').append(element);
       if (element != null) {
       var col = new Object();
             col.id = slick_full_config.grid.rows[i];
             col.name = col.id;
             col.field =  col.id;
             col.resizable = true;
             col.sortable = false;
             col.width = columnsizes[col.id];
             //col.width = 200;
              
              columns.push(col);
       }
   }
    var lis = document.getElementById("selfields").getElementsByTagName("li");
         
         
          for (var i = 0; i < lis.length; i++) { 
           
             
          }
  } 
        
 
  var options = {
    enableCellNavigation: true,
    enableColumnReorder: false,
   // forceFitColumns: true,
  //    multiColumnSort: true
 //     autoHeight: true
  };
  //var dataView;
  
  $( "#selfields, #listfields" ).sortable({
  connectWith: ".reportfields",
  placeholder: "ph",
      update: function( event, ui ) { 
          var lis = document.getElementById("selfields").getElementsByTagName("li");
          columns = [];
         
          for (var i = 0; i < lis.length; i++) { 
           
             var col = new Object();
             col.id = lis[i].id;
             col.name = lis[i].id;
             col.field =  lis[i].id;
             col.resizable = true;
             col.sortable = false;
              col.width = columnsizes[col.id];
             //col.width = 200;
              columns.push(col);
          }
          grid.setColumns(columns);
          slickupdate(dataView,grid,checklist,false,false);
      }
}); 
      
  dataView.beginUpdate();
  dataView.setItems(report_data);
  dataView.setFilter(filterslick);
  dataView.endUpdate();
  grid = new Slick.Grid("#reportoutput2", dataView, columns, options);
  
   //grid.registerPlugin(groupItemMetadataProvider);
  //grid.setSelectionModel(new Slick.CellSelectionModel());
        
    //$("#dialog-form3 input[name='display_total']:checked").val()
  //       grid.onSort.subscribe(function(e, args) {
  //      var comparer = function(a, b) {
 //   return (a[args.sortCol.field] > b[args.sortCol.field]) ? 1 : -1;
 // }
  //      dataView.sort(comparer, args.sortAsc);
//});
        
        slickupdate(dataView,grid,checklist,true,true);
        

        
        

    }   
    
    
    //$("#config_json").bind("blur", function(event){
 //                   var a = JSON.parse($(this).val());
 //                   a.onRefresh=Refresh;
                    
                    
        // google.load("visualization", "1", {packages:["corechart", "charteditor"]});

 //                   $("#reportoutput").pivotUI(report_data,a,true);
 //               });    
 }
function initCharts() {
 //   alert("Hi");
}


function xls_dialog_open() {
//alert("Hi");

function Workbook() {
	if(!(this instanceof Workbook)) return new Workbook();
	this.SheetNames = [];
	this.Sheets = {};
}
if (report_data.length>0) { 
var wb = new Workbook(), ws = XLSX.utils.json_to_sheet(report_data);
/* add worksheet to workbook */
ws_name = "osmr"
wb.SheetNames.push(ws_name);
;
wb.Sheets[ws_name] = ws;
var wbout = XLSX.write(wb, {bookType:'xlsx', bookSST:true, type: 'binary'});
function s2ab(s) {
	var buf = new ArrayBuffer(s.length);
	var view = new Uint8Array(buf);
	for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
	return buf;
}
saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), "test.xlsx")

} else
{
$("#confirmation").text("No data to Export")
        dialog_confirm.dialog({ title: "Message" });
        dialog_confirm.dialog("open");
}
};

function disp(ticked){
  //  $(".display_total").change(disp());
    $(".pvtTotal").toggle(ticked);
    $(".pvtTotalLabel").toggle(ticked);
    $(".pvtGrandTotal").toggle(ticked);
}




function getAge(dateString,dateString2, ageformat) {

  if (dateString2=="") {
  var now = new Date();
  var today = new Date(now.getYear(),now.getMonth(),now.getDate());

  var yearNow = now.getYear();
  var monthNow = now.getMonth();
  var dateNow = now.getDate();
  } else
  {
    var now = new Date(dateString2);
    var yearNow = now.getYear();
     var monthNow = now.getMonth();
     var dateNow = now.getDate();
  }
  var dob = new Date(dateString);

  var yearDob = dob.getYear();
  var monthDob = dob.getMonth();
  var dateDob = dob.getDate();
  var age = {};
  var ageString = "";
  var yearString = "";
  var monthString = "";
  var dayString = "";
  var monthAge;
  var dateAge;

  yearAge = yearNow - yearDob;

  if (monthNow >= monthDob)
    monthAge = monthNow - monthDob;
  else {
    yearAge--;
    monthAge = 12 + monthNow -monthDob;
  }

  if (dateNow >= dateDob)
    var dateAge = dateNow - dateDob;
  else {
    monthAge--;
    var dateAge = 31 + dateNow - dateDob;

    if (monthAge < 0) {
      monthAge = 11;
      yearAge--;
    }
  }

  age = {
      years: yearAge,
      months: monthAge,
      days: dateAge
      };

  if ( age.years > 1 ) yearString = " years";
  else yearString = " year";
  if ( age.months> 1 ) monthString = " months";
  else monthString = " month";
  if ( age.days > 1 ) dayString = " days";
  else dayString = " day";

    if (ageformat=="a") {
  if ( (age.years > 0) && (age.months > 0) && (age.days > 0) )
    ageString = age.years + yearString + ", " + age.months + monthString + ", and " + age.days + dayString + " old.";
  else if ( (age.years == 0) && (age.months == 0) && (age.days > 0) )
    ageString = "Only " + age.days + dayString + " old!";
  else if ( (age.years > 0) && (age.months == 0) && (age.days == 0) )
    ageString = age.years + yearString + " old. Happy Birthday!!";
  else if ( (age.years > 0) && (age.months > 0) && (age.days == 0) )
    ageString = age.years + yearString + " and " + age.months + monthString + " old.";
  else if ( (age.years == 0) && (age.months > 0) && (age.days > 0) )
    ageString = age.months + monthString + " and " + age.days + dayString + " old.";
  else if ( (age.years > 0) && (age.months == 0) && (age.days > 0) )
    ageString = age.years + yearString + " and " + age.days + dayString + " old.";
  else if ( (age.years == 0) && (age.months > 0) && (age.days == 0) )
    ageString = age.months + monthString + " old.";
  else ageString = "Oops! Could not calculate age!";
    }
    if (ageformat=="b") {
  if ( (age.years > 0) && (age.months > 0) && (age.days > 0) )
    ageString = age.years + yearString + ", " + age.months + monthString + ", and " + age.days + dayString + ".";
  else if ( (age.years == 0) && (age.months == 0) && (age.days > 0) )
    ageString = "Only " + age.days + dayString + ".";
  else if ( (age.years > 0) && (age.months == 0) && (age.days == 0) )
    ageString = age.years + yearString + " old. Happy Birthday!!";
  else if ( (age.years > 0) && (age.months > 0) && (age.days == 0) )
    ageString = age.years + yearString + " and " + age.months + monthString + ".";
  else if ( (age.years == 0) && (age.months > 0) && (age.days > 0) )
    ageString = age.months + monthString + " and " + age.days + dayString + ".";
  else if ( (age.years > 0) && (age.months == 0) && (age.days > 0) )
    ageString = age.years + yearString + " and " + age.days + dayString + ".";
  else if ( (age.years == 0) && (age.months > 0) && (age.days == 0) )
    ageString = age.months + monthString + ".";
  else ageString = "Oops! Could not calculate age!";
    }
    
    if (ageformat=="y") {
        ageString = age.years;
    }
if (ageformat=="s") {
        ageString = age.years + "/" + age.months;
    }
if (ageformat=="c") {    
 
 
ageString  = Math.ceil(Math.abs(now - dob) / (1000 * 60 * 60 * 24)); 
}
  return ageString;
}

function print_report() {
    var display_option = $('input[name=outputtype]:checked').val();
    var mywindow = window.open();
     if (display_option=='pivot') {
    
     mywindow.document.write('<html><head><title>my div</title><style>');
    mywindow.document.write('table, th, td { border: 1px solid black; border-collapse: collapse; font-family: Verdana,Arial,sans-serif; font-size: 8pt;} .pvtAxisLabel { background: grey;}');
                            if($("#dialog-form3 input[name='display_total']:checked").val()==false) {
    mywindow.document.write('.pvtTotal  {display: none;} .pvtTotalLabel {display: none;} .pvtGrandTotal {display: none;}');
    }
   mywindow.document.write('</style></head><body>');
    if ($('.pvtTable').length>0) {
        mywindow.document.write($('.pvtTable').prop('outerHTML')); } else {
            mywindow.document.write($(".pvtRendererArea").prop('outerHTML')); }
   mywindow.document.write('</body></html>');

    
     }
    //var test = dataView.getItems();
    var groupings  = dataView.getGrouping();
     var table_row = new Array; 
    var pdf_doc = new Object;
      var pdf_table = new Object ;
      pdf_table.table = new Object;
      pdf_table.table.headerRows = 1;
      pdf_table.table.body = new Array;
      var table_row = new Array;  
      for (var j in grid.getColumns()) {
        table_row.push(grid.getColumns()[j].name);
      }
      pdf_table.table.body.push(table_row);
      for (var j=0; j < dataView.getLength(); j++) {
      table_row = []; 
      var rowitem = dataView.getItem(j);
      if (rowitem.hasOwnProperty("__group")) {
           for (var k in grid.getColumns()) {
           if (k==0) {
               var pdf_table_cell = new Object;
               pdf_table_cell.text = groupings[rowitem.level].getter+":"+rowitem.value+"   ("+rowitem.count+")";
               pdf_table_cell.colSpan =  grid.getColumns().length;
               table_row.push(pdf_table_cell);
           } else
           {
               table_row.push(" ");
           }
           }
      } else
      {
       for (var k in grid.getColumns()) {
        //var prop = grid.getColumns()[j].name;
         var pdf_table_cell = new Object;
         pdf_table_cell.text = rowitem[(grid.getColumns()[k].name)].toString()
         table_row.push(pdf_table_cell);
     //   table_row.push(rowitem[(grid.getColumns()[k].name)]);
      }  
      }
      pdf_table.table.body.push(table_row);    
      }
   pdf_doc.content = pdf_table;
   pdf_doc.pageSize =  $( "select[name=page_size" ).val();
   pdf_doc.pageOrientation =  $( "select[name=page_orient" ).val(); 
                var defaultStyle = new Object;
                defaultStyle.fontSize = $( "input[name=display_size" ).val();
                pdf_doc.defaultStyle = defaultStyle;
        
                //pdf_base
//var pdf_doc_copy = new Object;
pdf_doc_copy = Object.assign({}, pdf_doc);

                pdfMake.createPdf(pdf_doc).getDataUrl(function(outDoc) {
                $("#pdf_viewer").attr("src", outDoc);
                });
                $("#reportoutput2").html("<iframe id=\"pdf_viewer\" width=100% style = \"min-width: 700px; height: 800px;\"><iframe>");
}

function api_settings_table() {
//JSON.parse(api_setup[2023]).apis[3].permissions
if ((section_config!=undefined)&&(Object.keys(section_config).length>0)) {
$("#dialog-delay").dialog({ position: {'my': 'center',  'at': 'center top+300', of: window } });
dialog_delay.dialog( "open" );
do_api_setup(0);
} else
{
  $("#confirmation").text("You need to logon")
        dialog_confirm.dialog({ title: "Message" });
        dialog_confirm.dialog("open");
};
}

function api_visual(value, html)
{
if (value > 0) {
  html = html + "<td width=10%><img src=\"icons\\green.png\"></td>"
}
else
{
html = html + "<td width=10%><img src=\"icons\\red.png\"></td>"
} 
return html;
}
function api_settings_assess_access() {
dialog_delay.dialog( "close" );
for (var i = 0; i < roles_config.length; i++) { 
{
  var apidef = JSON.parse(api_setup[roles_config[i].sectionid]); 
  for (var j = 0; j < (apidef.apis).length; j++)
   {
     if (apidef.apis[j].apiid==api_number) 
     {
       if (apidef.apis[j].permissions.empty=="true")
       {
        html = html + "<td colspan=5><img src=\"icons\\red.png\">No Access</td>"
       } else
       {
        html = api_visual(apidef.apis[j].permissions.member, html);
        html = api_visual(apidef.apis[j].permissions.flexi, html);
        html = api_visual(apidef.apis[j].permissions.badge, html);
        html = api_visual(apidef.apis[j].permissions.quartermaster, html);
        html = api_visual(apidef.apis[j].permissions.events, html);
      }
     }
}
}
}
}

function api_settings_table_draw() {
dialog_delay.dialog( "close" );
var html = "<table class=\"permissions\"><tr><th>Section</th><th>Member</th>";
html=html+"<th>Flexi</th><th>Badge</th><th>QM</th><th>Events</th></tr>"
 for (var i = 0; i < roles_config.length; i++) { 
   html = html + "<tr><td width=50%>"+roles_config[i].sectionname+"</td>"
   var apidef = JSON.parse(api_setup[roles_config[i].sectionid]);
   for (var j = 0; j < (apidef.apis).length; j++)
   {
     if (apidef.apis[j].apiid==api_number) 
     {
      
      // for (var perm in apidef.apis[j].permissions) 
      // {
      //   html = html + perm + ":" + apidef.apis[j].permissions[perm];
      // }
      if (apidef.apis[j].permissions.empty=="true")
      {
        html = html + "<td colspan=5><img src=\"icons\\red.png\">No Access</td>"
      } else
      {
       html = api_visual(apidef.apis[j].permissions.member, html);
       html = api_visual(apidef.apis[j].permissions.flexi, html);
       html = api_visual(apidef.apis[j].permissions.badge, html);
       html = api_visual(apidef.apis[j].permissions.quartermaster, html);
       html = api_visual(apidef.apis[j].permissions.events, html);
      }
       html = html + "</td>";
     }
   }
   html = html + "</tr>";
 }
html = html +"<tr><td colspan=6>Check the permissions of OSMR API for the sections you manage. You can only report on  areas with the green tick in the grid above.</td></tr>"
html = html + "</table><button onclick='$(&quot;#reportoutput_permiss&quot;).html(&quot;&quot;);'>Close Check</button>";
$("#reportoutput_permiss").html("");
$("#reportoutput_permiss").html(html);
menu_closeNav();
}

function select_type(type){
$("#pivottable").prop("checked", true)
if (type==1) {
$("#pivot_menu_entry").html("&#10004; Pivot Layout");
$("#pivottable").prop("checked", true);
$("#grid_menu_entry").html("Grid Layout");
$("#map_menu_entry").html("Map Layout");
} 
if (type==2) {
$("#pivot_menu_entry").html("Pivot Layout");
$("#map_menu_entry").html("Map Layout");
$("#grid_menu_entry").html("&#10004; Grid Layout");
$("#gridtable").prop("checked", true);
}
if (type==3) {
$("#pivot_menu_entry").html("Pivot Layout");
$("#grid_menu_entry").html("Grid Layout");
$("#map_menu_entry").html("&#10004; Map Layout");
$("#maptable").prop("checked", true);
}
select_checks2();
}
function select_totals() {
if ($("#total_menu_entry").html() =="Display Totals")
{
$("#total_menu_entry").html("&#10004; Display Totals");
$("#disp_totals_ck").prop('checked', true);
} else
{
$("#total_menu_entry").html("Display Totals");
$("#disp_totals_ck").prop('checked', false);
}
select_checks2();
}

</script>
<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="menu_closeNav()">&times;</a>

<a href="#" style="color: #F37A1F;">File</a> 
<a href="#"><span onclick="menu_closeNav();$('#openr_dialog').dialog({ position: {'my': 'center',  at: 'center top+200', of: window } });openr_dialog.dialog('option','title','Open Report');$('#report_template').prop('checked',false);openr_dialog.dialog( 'open' );">Open Report</span></a>
<a href="#"><span onclick="menu_closeNav();report_saveas();">Save Report</span></a>
<a href="#"><span onclick="menu_closeNav();$('#delr_dialog').dialog( 'option', 'position',{ my: 'center', at: 'center top+300', of: window } ); delr_dialog.dialog( 'open' );">Delete Report</span></a>
<a href="#" style="color: #F37A1F;border: #f1f1f1;border-top-style: solid;">Format Options</a>
<a href="#"><span id="pivot_menu_entry" onclick="select_type(1)">&#10004; Pivot Layout</span></a>
<a href="#"><span id="grid_menu_entry" onclick="select_type(2)">Grid Layout</span></a>
<a href="#" ><span id="map_menu_entry" onclick="select_type(3)" >Map Layout</span></a>
<a href="#" style="border: #f1f1f1;border-bottom-style: solid;"><span id="total_menu_entry" onclick="select_totals()" >Display Totals</span></a>
  <a href="#"><span  onclick="pdf_dialog_open()">PDF Options</span></a>
<a href="#"><span onclick="menu_closeNav();xls_dialog_open();">Save Data to Excel</span></a>
 <!-- <a href="#"><span onclick="api_settings_table()">Check OSM</span></a> 
 -->
 <a href="#"><span onclick="$('#lib-thanks').dialog({ position: {'my': 'center',  at: 'center top+200', of: window } });$('#osmr_version').text(osmr_version);$('#relay_path_setting').val(relay_path); lib_thanks.dialog('open');">About</span></a>
 <a href="#"><span onclick="var win = window.open('https://2ndnewhawscouts.org.uk/wordpress-plugins-for-scout-websites/osmr-reporting-for-osm/#donate', '_blank');
  win.focus();">Donate</span></a>
  <a href="#"><span onclick="log_out()">Logout</span></a>
  
</div>
<div class="osmr_toolbar">
<span style="font-size:30px;cursor:pointer" onclick="menu_openNav()">&#9776; Online Scout Manager Reporting</span>
<div id="osmr_logon"><!--<span id="username_block">Username: <input type="text" name="username" id="username"></span>
<span id="password_block">Password: <input type="password" name="password" id="password">-->
Exclude Access Report<input type="checkbox" id="logon_access" name="logon_access">
<button type="button" onclick="call_report()" id="logon_button">Log On</button></span></div>

<div id="osmr_loggedon">
<!--<button id="logout_button" type="button" onclick="log_out()">Log Out</button> --> 



<span id="reportdate_block">Date: <input type="text" name="datepicker" id="datepicker" class="ms-choice"></span><span>Section:
<select  multiple="multiple" class="select section-select">
<option></option>
</select></span>
<span>Report Type:<select id='report_type' name="report_type" class="ms-choice" style="width: 200px;display: inline;">
</select></span>
<button type="button" onclick="select_fields()" id="osmr_field"><span class="tooltiptext">Run/Edit Report</span></button>&nbsp;Reads remaining: 
<span id="rr"></span>&nbsp;Time before reset: <span id="rt"></span>&nbsp;<span id="rt_abs"></span>
<div class="grid-select">
<input id="pivottable" type="radio" name="render" value="pivot" checked="checked">

<!--<label class="gridtype pivottable" for="pivottable"> <span class="tooltiptext">Pivot Table</span></label> -->
  <input id="gridtable" type="radio" name="render" value="grid"><!--<label class="gridtype gridtable" for="gridtable"> <span class="tooltiptext">Grid Table</span></label>-->
<input id="maptable" type="radio" name="render" value="map">
</div><input type="checkbox"  id="disp_totals_ck" name="display_total"><!--<label for="disp_totals_ck" id="disp_totals_ck"><span class="tooltiptext">Display Totals</span></label>-->

<!--<button id="pdf_button" type="button" onclick="pdf_dialog_open()"> <span class="tooltiptext">PDF Options</span></button>-->

<!--<button id="xls_button" type="button" onclick="xls_dialog_open()"> <span class="tooltiptext">XLS Download</span></button>-->


<span><!--<button id="check_button" type="button" onclick="api_settings_table()"> <span class="tooltiptext">Check Permissions</span></button>-->
</div></div>


<div id = "reportoutput_permiss">
</div>
    
<div id = "reportoutput">
</div>
<div style="display:none; height: 500px;" id="mapid">
    
</div>

<div id = "reportoutput_about">
<h1>Welcome to a tool to help you generate useful reports from Online Scout Manager<h2>
<div id="cycler">
<img class="active cyc" src="https://www.2ndnewhawscouts.org.uk/osmr/icons/OSMR1.jpg" alt="My image" />

<img class="cyc" src="https://www.2ndnewhawscouts.org.uk/osmr/icons/OSMR2.jpg" alt="My image" />
<img class="cyc"  src="https://www.2ndnewhawscouts.org.uk/osmr/icons/OSMR3.jpg" alt="My image" />
<img class="cyc"  src="https://www.2ndnewhawscouts.org.uk/osmr/icons/OSMR4.jpg" alt="My image" />
<img class="cyc"  src="https://www.2ndnewhawscouts.org.uk/osmr/icons/OSMR5.jpg" alt="My image" />
</div>
<div class="osmr_description">
<p>
<strong>OSMR</strong> allows you to generate reports, pivot tables, charts and graphs of your Online Scout Manager data allowing you to access the data you have in <strong>OSM</strong> in a lot of new ways.</p>
<p>You can combine data from any of the sections you have access to allowing you to generate group lists, attendees for Group event as well as producing lots of reports about specific sections. You can generate PDFs, print your reports or just see them on screen.</p>
<p>Using a simple drag and drop interface you are in control of your data. We don't store any of your report data and all report generation is done on your PC, tablet or phone.</p>
<p><table><tr>
<td width=5% style="vertical-align: middle !important;">
<img src="https://www.2ndnewhawscouts.org.uk/osmr/icons/1.jpg"></td><td width=20%>Log in using your OSM ID
</td>
<td width=5% style="vertical-align: middle !important;"><img src="https://www.2ndnewhawscouts.org.uk/osmr/icons/2.jpg"></td><td width=20%>Select which Sections you want to include</td>
<td width=5% style="vertical-align: middle !important;"><img src="https://www.2ndnewhawscouts.org.uk/osmr/icons/3.jpg"></td><td width=20%>Choose the type of data you want to use</td>
<td width=5% style="vertical-align: middle !important;"><img src="https://www.2ndnewhawscouts.org.uk/osmr/icons/fields.png"></td><td width=20%>Press the Run Report button to start!</td></tr></table></p>
<p>It really is that simple. Once you've selected your fields you can switch between grid and pivot views adjusting which fields are displayed by draging and dropping them into the report.You can filter and group your information from the field selection boxes. Very soon you'll be able to save your report formats for future use.</p>   
<p><strong>Find more detailed instructions about how to use OSMR and how to donate to my Scout Group, 2nd New Haw, <a href="https://2ndnewhawscouts.org.uk/wordpress-plugins-for-scout-websites/osmr-reporting-for-osm/">here</a>.</strong></p>  
<p>Contact us via FB on the OSM helping <a href="https://www.facebook.com/groups/157906375505510/">Group</a> or via the form on the page above, our old forum is https://osmr.freeforums.net/</p> 
</div>
</div>

<div id="pdf-dialog" title="PDF Options">
<label>PDF Font Size: <input  type="text" id='display_size' name="display_size" value="6" size="3">pt</label><br>
<label>PDF Page Size: <select id='page_size' name="page_size">
</select>
</label><br><span><label>PDF Orientation: <select name="page_orient" id='page_orient'><option value="landscape">Landscape</option><option value="portrait">Portrait</option></select></label></span>
</div>
<div id="lib-thanks" title="About">
This is version <span id="osmr_version"></span> of OSMR<br>Fixes in this version include:<br>Corrections to saving of Reports<br>Fixes to Filter Dialogs<br><br>
<!--Relay: <input type="text" name="fname" id="relay_path_setting"><br>-->
We'd like to thank the authors of the following libraries:<br><br><a href="http://pdfmake.org/#/" target="_blank">PDFMake</a> for PDF Creation<br>
<a href="https://pivottable.js.org/examples/" target="_blank">pivottable.js</a> for the pivot tables<br><a href="https://github.com/mleibman/SlickGrid" target="_blank">SlickGrid</a> for the grid display<br>
</div>

<div id="openr_dialog" title="Open Report">
Report Name: <select id="SavedReports" class="ms-choice" style="width: 200px;display: inline;"></select>
<input type="checkbox" name="report_template" id= "report_template" value="report_template" style="display: none !important;">
</div>
<div id="delr_dialog" title="Delete Report">
Report Name: <select id="DeleteReports" class="ms-choice" style="width: 200px;display: inline;"></select>
</div>
<script>


 $('#page_size').change (function() { 
          if ($(".pvtRenderer").val()=="PDF") {
          $(".pvtRenderer").val("PDF").change(); 
          }
          if ($(".slickot").val()=="pdf") {
          $(".slickot").val("pdf").change(); 
          }
      });
$('#page_orient').change (function() { 
          if ($(".pvtRenderer").val()=="PDF") {
          $(".pvtRenderer").val("PDF").change(); 
          }
          if ($(".slickot").val()=="pdf") {
          $(".slickot").val("pdf").change(); 
          }
      });
      $('#display_size').change (function() {
           if ($(".pvtRenderer").val()=="PDF") {
          $(".pvtRenderer").val("PDF").change(); 
          }
          if ($(".slickot").val()=="pdf") {
          $(".slickot").val("pdf").change(); 
          }
      });
 $('input[type=radio][name=render]').on('change', function(){
    switch($(this).val()){
        case 'grid' :
         //   alert("Grid");
            select_checks2();
            break;
        case 'pivot' :
         //   alert("Pivot");
select_checks2();
            break;
    }            
});
 $(document).on("change", "#disp_totals_ck", function () {
    select_checks2();
})
$("#osmr_loggedon").toggle();
var lib_thanks = $("#lib-thanks").dialog({ autoOpen: false, width: 600});
var pdf_dialog = $("#pdf-dialog").dialog({ autoOpen: false });
var size_array = [ "A4", "4A0", "2A0", "A0", "A1", "A2", "A3", "A5", "EXECUTIVE", "FOLIO", "LEGAL", "LETTER", "TABLOID" ];
for (dodrop in size_array)
{
$('#page_size').append($('<option>', {value:size_array[dodrop], text:size_array[dodrop]}));
};

var openr_dialog = $("#openr_dialog").dialog({ autoOpen: false, buttons: {Cancel: function() {
          openr_dialog.dialog( "close" );
         },
Run: function () {openr_dialog.dialog( "close" );select_fields();}
}});

var delr_dialog = $("#delr_dialog").dialog({ autoOpen: false, buttons: {Cancel: function() {
          delr_dialog.dialog( "close" );
         },
Delete: function () {delr_dialog.dialog( "close" );delete_report();}
}});
 access= $('#logon_access').is(":checked");
if (!access) {
var dialog_array = [ "Members","Members & Badges","Members & Badges Details","Members & Challenge Badges","Members & Staged Badges","Members & Sections", "Members & WL","Members & Maps", "Badges","Badge Stock","Events","Events & Attendance","Events & QM Lists","QM List","User Access","Programme & Badges","Programme & Attendance","Gift Aid","Shared Event Attendance","Events & Badges","Online Payments"];
} else {
   var dialog_array = [ "Members","Members & Badges","Members & Badges Details","Members & Challenge Badges","Members & Staged Badges","Members & Sections", "Members & WL","Members & Maps","Badges","Badge Stock","Events","Events & Attendance","Events & QM Lists","QM List","Programme & Badges","Programme & Attendance","Gift Aid","Shared Event Attendance","Events & Badges","Online Payments"]; 
}
for (dodrop in dialog_array)
{
$('#report_type').append($('<option>', {value:dialog_array[dodrop], text:dialog_array[dodrop]}));
};

$( "#datepicker" ).datepicker();
$( "#datepicker" ).datepicker( "option", "dateFormat", "yy-mm-dd" );
var today =  new Date().toISOString().slice(0,10);
$("#datepicker").val(today);
function pdf_dialog_open() { menu_closeNav(); 
$("#pdf-dialog").dialog({ position: {'my': 'center',  at: 'center top+300', of: window } });
pdf_dialog.dialog("open"); };
var mstest = new Object();
mstest = $('.section-select').multipleSelect({
            placeholder: "Select a Section", width: 200, filter: true
        });
</script>
<textarea rows="4" cols="50" id="config_json"></textarea>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-93668506-1', 'auto');
  ga('send', 'pageview');


function cycleImages(){
      var $active = $('#cycler .active');
      var $next = ($active.next().length > 0) ? $active.next() : $('#cycler img:first');
      $next.css('z-index',2);//move the next image up the pile
      $active.fadeOut(1500,function(){//fade out the top image
	  $active.css('z-index',1).show().removeClass('active');//reset the z-index and unhide the image
          $next.css('z-index',3).addClass('active');//make the next image the top one
      });
    }

$(document).ready(function(){
// run every 7s
setInterval('cycleImages()', 7000);
})

 
   // error_fkfdfjd();</script>
</body>

</html>


